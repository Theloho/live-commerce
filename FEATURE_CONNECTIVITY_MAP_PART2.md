# FEATURE_CONNECTIVITY_MAP_PART2.md - ì¿ í° + ë°°ì†¡ ì‹œìŠ¤í…œ

**âš ï¸ ì´ íŒŒì¼ì€ ì „ì²´ ë¬¸ì„œì˜ Part 2ì…ë‹ˆë‹¤**
- **Part 1**: ì£¼ë¬¸ ì‹œìŠ¤í…œ + ìƒí’ˆ ì‹œìŠ¤í…œ
- **Part 2**: ì¿ í° ì‹œìŠ¤í…œ + ë°°ì†¡ ì‹œìŠ¤í…œ â† **í˜„ì¬ íŒŒì¼**
- **Part 3**: ê´€ë¦¬ì ì‹œìŠ¤í…œ + ë°œì£¼ ì‹œìŠ¤í…œ

**ìƒì„±ì¼**: 2025-10-08
**ë²„ì „**: 1.0
**ëª©ì **: ì¿ í°, ë°°ì†¡ë¹„, ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œìŠ¤í…œì˜ ì—°ê²°ì„±ê³¼ ë°ì´í„° íë¦„ íŒŒì•…

---

## ğŸ“‹ ëª©ì°¨

1. [ì¿ í° ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±](#1-ì¿ í°-ì‹œìŠ¤í…œ-ì „ì²´-ì—°ê²°ì„±)
2. [ë°°ì†¡ë¹„ ê³„ì‚° ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±](#2-ë°°ì†¡ë¹„-ê³„ì‚°-ì‹œìŠ¤í…œ-ì „ì²´-ì—°ê²°ì„±)
3. [ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±](#3-ì¹´ì¹´ì˜¤-ë¡œê·¸ì¸-ì‹œìŠ¤í…œ-ì „ì²´-ì—°ê²°ì„±)
4. [ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ì—°ê²° ë‹¤ì´ì–´ê·¸ë¨](#4-ë°ì´í„°ë² ì´ìŠ¤-í…Œì´ë¸”-ì—°ê²°-ë‹¤ì´ì–´ê·¸ë¨)
5. [í•¨ìˆ˜ ì²´ì¸ (Function Call Chain)](#5-í•¨ìˆ˜-ì²´ì¸-function-call-chain)

---

## 1. ì¿ í° ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±

### 1.1 ì¿ í° ìƒì„± â†’ ë°°í¬ â†’ ì‚¬ìš© ì „ì²´ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: ì¿ í° ìƒì„± (ê´€ë¦¬ì)                                    â”‚
â”‚                                                              â”‚
â”‚ ì‹œì‘: /admin/coupons/new                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì…ë ¥:                                                        â”‚
â”‚  â”œâ”€â”€ code: 'WELCOME10' (ìë™ ëŒ€ë¬¸ì)                         â”‚
â”‚  â”œâ”€â”€ name: 'ì‹ ê·œ ê°€ì… ì¿ í°'                                  â”‚
â”‚  â”œâ”€â”€ discount_type: 'percentage' or 'fixed_amount'           â”‚
â”‚  â”œâ”€â”€ discount_value: 10 (10% ë˜ëŠ” 10,000ì›)                  â”‚
â”‚  â”œâ”€â”€ min_purchase_amount: 50000 (ìµœì†Œ êµ¬ë§¤ ê¸ˆì•¡)             â”‚
â”‚  â”œâ”€â”€ max_discount_amount: 5000 (percentage íƒ€ì… í•„ìˆ˜)        â”‚
â”‚  â”œâ”€â”€ valid_from, valid_until: ìœ íš¨ ê¸°ê°„                     â”‚
â”‚  â”œâ”€â”€ usage_limit_per_user: 1 (ì‚¬ìš©ìë‹¹ íšŸìˆ˜)                 â”‚
â”‚  â””â”€â”€ total_usage_limit: 100 (ì„ ì°©ìˆœ 100ëª…, NULL=ë¬´ì œí•œ)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ createCoupon(couponData) - Service Role API ì‚¬ìš©             â”‚
â”‚                                                              â”‚
â”‚ â­ 2025-10-07 ë³€ê²½: í´ë¼ì´ì–¸íŠ¸ ì§ì ‘ INSERT â†’ API Route      â”‚
â”‚                                                              â”‚
â”‚ í”„ë¡ íŠ¸ì—”ë“œ (lib/couponApi.js):                               â”‚
â”‚  â†“ calls                                                     â”‚
â”‚ POST /api/admin/coupons/create                               â”‚
â”‚  â†“ with                                                      â”‚
â”‚ { adminEmail: localStorage.adminEmail, ...couponData }       â”‚
â”‚                                                              â”‚
â”‚ ì„œë²„ ì‚¬ì´ë“œ (app/api/admin/coupons/create/route.js):        â”‚
â”‚  â†“ validates                                                 â”‚
â”‚ verifyAdminAuth(adminEmail)                                  â”‚
â”‚  â”œâ”€â”€ process.env.ADMIN_EMAILS í™•ì¸                          â”‚
â”‚  â””â”€â”€ ê´€ë¦¬ì ì•„ë‹ˆë©´ 403 ì—ëŸ¬                                  â”‚
â”‚  â†“ validates                                                 â”‚
â”‚ ì¿ í° ë°ì´í„° ê²€ì¦:                                            â”‚
â”‚  â”œâ”€â”€ percentage íƒ€ì…ì€ max_discount_amount í•„ìˆ˜              â”‚
â”‚  â”œâ”€â”€ valid_until > valid_from                                â”‚
â”‚  â”œâ”€â”€ discount_value > 0                                      â”‚
â”‚  â””â”€â”€ ì¿ í° ì½”ë“œ ì¤‘ë³µ í™•ì¸                                     â”‚
â”‚  â†“ creates (Service Role Key)                                â”‚
â”‚ supabaseAdmin.from('coupons').insert({ ... })                â”‚
â”‚  â””â”€â”€ RLS ì •ì±… ìš°íšŒ (SUPABASE_SERVICE_ROLE_KEY)              â”‚
â”‚  â†“ returns                                                   â”‚
â”‚ { success: true, coupon: {...} }                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: ì¿ í° ë°°í¬ (ê´€ë¦¬ì)                                    â”‚
â”‚                                                              â”‚
â”‚ ì‹œì‘: /admin/coupons/[id] (ì¿ í° ìƒì„¸ í˜ì´ì§€)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë°°í¬ ë°©ì‹ ì„ íƒ:                                              â”‚
â”‚  1) ê°œë³„ ë°°í¬: distributeCoupon(couponId, [userId1, ...])   â”‚
â”‚  2) ì „ì²´ ë°°í¬: distributeToAllCustomers(couponId)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ distributeCoupon() - Service Role API ì‚¬ìš©                   â”‚
â”‚                                                              â”‚
â”‚ í”„ë¡ íŠ¸ì—”ë“œ:                                                  â”‚
â”‚  â†“ calls                                                     â”‚
â”‚ POST /api/admin/coupons/distribute                           â”‚
â”‚  â†“ with                                                      â”‚
â”‚ { adminEmail, couponId, userIds: [...] }                     â”‚
â”‚                                                              â”‚
â”‚ ì„œë²„ ì‚¬ì´ë“œ:                                                 â”‚
â”‚  â†“ validates                                                 â”‚
â”‚ verifyAdminAuth(adminEmail)                                  â”‚
â”‚  â†“ validates                                                 â”‚
â”‚ ì¿ í° í™œì„±í™” ìƒíƒœ í™•ì¸ (is_active = true)                     â”‚
â”‚  â†“ distributes (Service Role Key)                            â”‚
â”‚ supabaseAdmin.from('user_coupons').upsert([                  â”‚
â”‚   { user_id: userId1, coupon_id: couponId, ... },           â”‚
â”‚   { user_id: userId2, coupon_id: couponId, ... },           â”‚
â”‚   ...                                                        â”‚
â”‚ ])                                                           â”‚
â”‚  â””â”€â”€ RLS ì •ì±… ìš°íšŒ                                           â”‚
â”‚  â””â”€â”€ ì¤‘ë³µ ë°°í¬ í—ˆìš© (UNIQUE ì œì•½ ì œê±°ë¨, 2025-10-06)        â”‚
â”‚  â†“ trigger                                                   â”‚
â”‚ coupons.total_issued_count += userIds.length                 â”‚
â”‚  â†“ returns                                                   â”‚
â”‚ { success, distributedCount, requestedCount }                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ë‹¨ê³„: ì¿ í° ì¡°íšŒ (ì‚¬ìš©ì)                                    â”‚
â”‚                                                              â”‚
â”‚ ì‹œì‘: /mypage/coupons                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ getUserCoupons(userId)                                       â”‚
â”‚  â†“ queries (RLS ìë™ ì ìš©)                                   â”‚
â”‚ SELECT uc.*, c.*                                             â”‚
â”‚ FROM user_coupons uc                                         â”‚
â”‚ JOIN coupons c ON uc.coupon_id = c.id                        â”‚
â”‚ WHERE uc.user_id = userId                                    â”‚
â”‚ ORDER BY c.valid_until ASC;                                  â”‚
â”‚                                                              â”‚
â”‚ íƒ­ í•„í„°ë§:                                                   â”‚
â”‚  â”œâ”€â”€ ì‚¬ìš© ê°€ëŠ¥: is_used=false AND valid_until > NOW()       â”‚
â”‚  â”œâ”€â”€ ì‚¬ìš© ì™„ë£Œ: is_used=true                                 â”‚
â”‚  â””â”€â”€ ê¸°ê°„ ë§Œë£Œ: is_used=false AND valid_until < NOW()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ë‹¨ê³„: ì¿ í° ê²€ì¦ (ì²´í¬ì•„ì›ƒ)                                  â”‚
â”‚                                                              â”‚
â”‚ ì‹œì‘: /checkout - ì¿ í° ì„ íƒ                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ handleApplyCoupon(couponCode)                                â”‚
â”‚  â†“ calls                                                     â”‚
â”‚ validateCoupon(couponCode, userId, productAmount)            â”‚
â”‚  â†“ calls DB function (PostgreSQL)                            â”‚
â”‚ SELECT * FROM validate_coupon(                               â”‚
â”‚   p_coupon_code := 'WELCOME10',                              â”‚
â”‚   p_user_id := userId,                                       â”‚
â”‚   p_product_amount := 50000  -- â­ ë°°ì†¡ë¹„ ì œì™¸!             â”‚
â”‚ );                                                           â”‚
â”‚                                                              â”‚
â”‚ DB í•¨ìˆ˜ ë‚´ë¶€ ê²€ì¦ ìˆœì„œ (7ë‹¨ê³„):                               â”‚
â”‚  1. ì¿ í° ì¡´ì¬ ë° í™œì„±í™” ì—¬ë¶€ (is_active = true)              â”‚
â”‚  2. ìœ íš¨ ê¸°ê°„ ì‹œì‘ ì „ (NOW() < valid_from)                   â”‚
â”‚  3. ìœ íš¨ ê¸°ê°„ ë§Œë£Œ (NOW() > valid_until)                     â”‚
â”‚  4. ìµœì†Œ êµ¬ë§¤ ê¸ˆì•¡ (productAmount >= min_purchase_amount)    â”‚
â”‚  5. ì „ì²´ ì‚¬ìš© í•œë„ (total_used_count < total_usage_limit)   â”‚
â”‚  6. ì‚¬ìš©ì ë³´ìœ  ì—¬ë¶€ (user_coupons.user_id = p_user_id)     â”‚
â”‚  7. ì‚¬ìš© ì´ë ¥ (is_used = false)                              â”‚
â”‚                                                              â”‚
â”‚ í• ì¸ ê¸ˆì•¡ ê³„ì‚°:                                              â”‚
â”‚  IF discount_type = 'fixed_amount' THEN                      â”‚
â”‚    discount := LEAST(discount_value, productAmount)          â”‚
â”‚  ELSE -- percentage                                          â”‚
â”‚    discount := productAmount * (discount_value / 100)        â”‚
â”‚    IF max_discount_amount IS NOT NULL THEN                   â”‚
â”‚      discount := LEAST(discount, max_discount_amount)        â”‚
â”‚    END IF                                                    â”‚
â”‚  END IF                                                      â”‚
â”‚                                                              â”‚
â”‚ ì¶œë ¥:                                                        â”‚
â”‚  â”œâ”€â”€ is_valid: true/false                                    â”‚
â”‚  â”œâ”€â”€ error_message: 'ì¬ê³  ë¶€ì¡±' ë“±                           â”‚
â”‚  â”œâ”€â”€ coupon_id: UUID                                         â”‚
â”‚  â””â”€â”€ discount_amount: 5000 (ê³„ì‚°ëœ í• ì¸ ê¸ˆì•¡)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5ë‹¨ê³„: ì¿ í° ì‚¬ìš© ì²˜ë¦¬ (ì£¼ë¬¸ ìƒì„± í›„)                         â”‚
â”‚                                                              â”‚
â”‚ ì£¼ë¬¸ ìƒì„± ì™„ë£Œ í›„ ì¦‰ì‹œ í˜¸ì¶œ                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ applyCouponUsage(userId, couponId, orderId, discountAmount)  â”‚
â”‚  â†“ calls DB function (PostgreSQL)                            â”‚
â”‚ SELECT use_coupon(                                           â”‚
â”‚   p_user_id := userId,                                       â”‚
â”‚   p_coupon_id := couponId,                                   â”‚
â”‚   p_order_id := orderId,                                     â”‚
â”‚   p_discount_amount := 5000                                  â”‚
â”‚ );                                                           â”‚
â”‚                                                              â”‚
â”‚ DB í•¨ìˆ˜ ë‚´ë¶€ (SECURITY DEFINER - RLS ìš°íšŒ):                 â”‚
â”‚  â†“ updates                                                   â”‚
â”‚ UPDATE user_coupons                                          â”‚
â”‚ SET is_used = true,                                          â”‚
â”‚     used_at = NOW(),                                         â”‚
â”‚     order_id = p_order_id,                                   â”‚
â”‚     discount_amount = p_discount_amount                      â”‚
â”‚ WHERE user_id = p_user_id                                    â”‚
â”‚   AND coupon_id = p_coupon_id                                â”‚
â”‚   AND is_used = false  -- â­ ì¤‘ë³µ ì‚¬ìš© ë°©ì§€                  â”‚
â”‚ RETURNING *;                                                 â”‚
â”‚                                                              â”‚
â”‚  â†“ trigger (ìë™ ì‹¤í–‰)                                       â”‚
â”‚ UPDATE coupons                                               â”‚
â”‚ SET total_used_count = total_used_count + 1                  â”‚
â”‚ WHERE id = p_coupon_id;                                      â”‚
â”‚                                                              â”‚
â”‚ ì¶œë ¥: true/false (ì„±ê³µ ì—¬ë¶€)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì¢…ë£Œ: ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€ (/orders/[id]/complete)              â”‚
â”‚                                                              â”‚
â”‚ í‘œì‹œ:                                                        â”‚
â”‚  â”œâ”€â”€ ìƒí’ˆ ê¸ˆì•¡: 50,000ì›                                     â”‚
â”‚  â”œâ”€â”€ ì¿ í° í• ì¸: -5,000ì› â­                                  â”‚
â”‚  â”œâ”€â”€ ë°°ì†¡ë¹„: +4,000ì›                                        â”‚
â”‚  â””â”€â”€ ìµœì¢… ê²°ì œ: 49,000ì›                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ë°°ì†¡ë¹„ ê³„ì‚° ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±

### 2.1 ìš°í¸ë²ˆí˜¸ ì…ë ¥ â†’ ë°°ì†¡ë¹„ ê³„ì‚° ì „ì²´ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: ì£¼ì†Œ ì…ë ¥ (AddressManager)                            â”‚
â”‚                                                              â”‚
â”‚ ì‹œì‘: /mypage ë˜ëŠ” /checkout                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Daum ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ API                                       â”‚
â”‚                                                              â”‚
â”‚ new daum.Postcode({                                          â”‚
â”‚   oncomplete: function(data) {                               â”‚
â”‚     postalCode = data.zonecode;  // '63000' (ì œì£¼)          â”‚
â”‚     address = data.address;                                  â”‚
â”‚   }                                                          â”‚
â”‚ });                                                          â”‚
â”‚                                                              â”‚
â”‚ ì €ì¥:                                                        â”‚
â”‚  â”œâ”€â”€ profiles.postal_code (ê¸°ë³¸ ë°°ì†¡ì§€)                      â”‚
â”‚  â””â”€â”€ profiles.addresses JSONB (ì—¬ëŸ¬ ë°°ì†¡ì§€)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: ë°°ì†¡ë¹„ ê³„ì‚° (ì²´í¬ì•„ì›ƒ ë˜ëŠ” ì£¼ë¬¸ ì¡°íšŒ)                 â”‚
â”‚                                                              â”‚
â”‚ formatShippingInfo(baseShipping, postalCode)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ calculateShippingSurcharge(postalCode)                       â”‚
â”‚                                                              â”‚
â”‚ ì…ë ¥: postalCode = '63100' (ì œì£¼)                            â”‚
â”‚                                                              â”‚
â”‚ ê²€ì¦:                                                        â”‚
â”‚  â”œâ”€â”€ ìš°í¸ë²ˆí˜¸ í˜•ì‹ í™•ì¸ (5ìë¦¬ ìˆ«ì)                         â”‚
â”‚  â””â”€â”€ parseInt(postalCode)                                    â”‚
â”‚                                                              â”‚
â”‚ ì§€ì—­ íŒì •:                                                   â”‚
â”‚  IF (63000 <= postalCode <= 63644) THEN                      â”‚
â”‚    region = 'ì œì£¼'                                           â”‚
â”‚    surcharge = 3000                                          â”‚
â”‚    isRemote = true                                           â”‚
â”‚                                                              â”‚
â”‚  ELSE IF (40200 <= postalCode <= 40240) THEN                 â”‚
â”‚    region = 'ìš¸ë¦‰ë„'                                         â”‚
â”‚    surcharge = 5000                                          â”‚
â”‚    isRemote = true                                           â”‚
â”‚                                                              â”‚
â”‚  ELSE IF (ê¸°íƒ€ ë„ì„œì‚°ê°„ - í–¥í›„ í™•ì¥) THEN                    â”‚
â”‚    region = 'ê¸°íƒ€ ë„ì„œì‚°ê°„'                                  â”‚
â”‚    surcharge = 5000                                          â”‚
â”‚    isRemote = true                                           â”‚
â”‚                                                              â”‚
â”‚  ELSE                                                        â”‚
â”‚    region = 'ì¼ë°˜'                                           â”‚
â”‚    surcharge = 0                                             â”‚
â”‚    isRemote = false                                          â”‚
â”‚  END IF                                                      â”‚
â”‚                                                              â”‚
â”‚ ì¶œë ¥:                                                        â”‚
â”‚  â”œâ”€â”€ isRemote: true                                          â”‚
â”‚  â”œâ”€â”€ region: 'ì œì£¼'                                          â”‚
â”‚  â””â”€â”€ surcharge: 3000                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ formatShippingInfo() ë°˜í™˜ê°’                                  â”‚
â”‚                                                              â”‚
â”‚ {                                                            â”‚
â”‚   baseShipping: 4000,     // ê¸°ë³¸ ë°°ì†¡ë¹„                     â”‚
â”‚   surcharge: 3000,         // ë„ì„œì‚°ê°„ ì¶”ê°€ë¹„                â”‚
â”‚   totalShipping: 7000,     // ì´ ë°°ì†¡ë¹„                      â”‚
â”‚   isRemote: true,          // ë„ì„œì‚°ê°„ ì—¬ë¶€                  â”‚
â”‚   region: 'ì œì£¼'           // ì§€ì—­ëª…                         â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ë‹¨ê³„: DB ì €ì¥ (ì£¼ë¬¸ ìƒì„± ì‹œ)                                â”‚
â”‚                                                              â”‚
â”‚ order_shipping (INSERT)                                      â”‚
â”‚  â”œâ”€â”€ postal_code: '63100' (í•„ìˆ˜)                             â”‚
â”‚  â”œâ”€â”€ shipping_cost: 7000 (ê¸°ë³¸ + ë„ì„œì‚°ê°„)                   â”‚
â”‚  â””â”€â”€ address, detail_address, ...                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ë‹¨ê³„: ì£¼ë¬¸ ì¡°íšŒ ì‹œ ë°°ì†¡ë¹„ ì¬ê³„ì‚°                            â”‚
â”‚                                                              â”‚
â”‚ ëª©ì : DB ì €ì¥ê°’ê³¼ ì‹¤ì‹œê°„ ê³„ì‚°ê°’ ë¹„êµ (ê´€ë¦¬ì í˜ì´ì§€)         â”‚
â”‚                                                              â”‚
â”‚ getOrderById(orderId)                                        â”‚
â”‚  â†“ fetches                                                   â”‚
â”‚ order_shipping.postal_code, order_shipping.shipping_cost     â”‚
â”‚  â†“ calculates                                                â”‚
â”‚ formatShippingInfo(4000, postalCode)                         â”‚
â”‚  â†“ compares                                                  â”‚
â”‚ IF (calculated !== stored) THEN                              â”‚
â”‚   logger.warn('ë°°ì†¡ë¹„ ë¶ˆì¼ì¹˜')                               â”‚
â”‚ END IF                                                       â”‚
â”‚  â†“ uses                                                      â”‚
â”‚ ì €ì¥ëœ ê°’ ìš°ì„  ì‚¬ìš© (DB ì €ì¥ê°’ ì‹ ë¢°)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±

### 3.1 ì¹´ì¹´ì˜¤ OAuth â†’ í”„ë¡œí•„ ì €ì¥ â†’ ì£¼ë¬¸ ì¡°íšŒ ì „ì²´ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: ì¹´ì¹´ì˜¤ OAuth ì¸ì¦                                     â”‚
â”‚                                                              â”‚
â”‚ ì‹œì‘: /login - ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì¹´ì¹´ì˜¤ ì¸ì¦ ì„œë²„ ë¦¬ë‹¤ì´ë ‰íŠ¸                                  â”‚
â”‚                                                              â”‚
â”‚ https://kauth.kakao.com/oauth/authorize                      â”‚
â”‚  â”œâ”€â”€ client_id: KAKAO_APP_KEY                                â”‚
â”‚  â”œâ”€â”€ redirect_uri: /auth/callback                            â”‚
â”‚  â””â”€â”€ response_type: code                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: ì½œë°± ì²˜ë¦¬ (/auth/callback)                            â”‚
â”‚                                                              â”‚
â”‚ ì…ë ¥: code (ì¸ì¦ ì½”ë“œ)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ í† í° ë°œê¸‰ ë° ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ                                â”‚
â”‚                                                              â”‚
â”‚ POST https://kauth.kakao.com/oauth/token                     â”‚
â”‚  â†“ returns                                                   â”‚
â”‚ { access_token, refresh_token }                              â”‚
â”‚  â†“ calls                                                     â”‚
â”‚ GET https://kapi.kakao.com/v2/user/me                        â”‚
â”‚  â†“ returns                                                   â”‚
â”‚ {                                                            â”‚
â”‚   id: '1234567890',  -- â­ kakao_id                          â”‚
â”‚   kakao_account: {                                           â”‚
â”‚     profile: { nickname: 'í™ê¸¸ë™' },                         â”‚
â”‚     email: 'hong@example.com',                               â”‚
â”‚     phone_number: '+82 10-1234-5678'                         â”‚
â”‚   }                                                          â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ë‹¨ê³„: profiles í…Œì´ë¸” í™•ì¸ ë° ì €ì¥                          â”‚
â”‚                                                              â”‚
â”‚ SELECT * FROM profiles                                       â”‚
â”‚ WHERE kakao_id = '1234567890';                               â”‚
â”‚                                                              â”‚
â”‚ IF (NOT FOUND) THEN  -- ì‹ ê·œ ì‚¬ìš©ì                          â”‚
â”‚   INSERT INTO profiles (                                     â”‚
â”‚     kakao_id,                                                â”‚
â”‚     email,                                                   â”‚
â”‚     name,                                                    â”‚
â”‚     nickname,                                                â”‚
â”‚     phone,                                                   â”‚
â”‚     provider                                                 â”‚
â”‚   ) VALUES (                                                 â”‚
â”‚     '1234567890',                                            â”‚
â”‚     'hong@example.com',                                      â”‚
â”‚     'í™ê¸¸ë™',                                                â”‚
â”‚     'í™ê¸¸ë™',                                                â”‚
â”‚     '010-1234-5678',                                         â”‚
â”‚     'kakao'                                                  â”‚
â”‚   );                                                         â”‚
â”‚ ELSE  -- ê¸°ì¡´ ì‚¬ìš©ì                                         â”‚
â”‚   -- í”„ë¡œí•„ ì •ë³´ ì—…ë°ì´íŠ¸ (ì„ íƒì )                           â”‚
â”‚ END IF                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ë‹¨ê³„: sessionStorage ì €ì¥                                   â”‚
â”‚                                                              â”‚
â”‚ sessionStorage.setItem('user', JSON.stringify({              â”‚
â”‚   kakao_id: '1234567890',  -- â­ í•µì‹¬                        â”‚
â”‚   email: 'hong@example.com',                                 â”‚
â”‚   name: 'í™ê¸¸ë™',                                            â”‚
â”‚   nickname: 'í™ê¸¸ë™',                                        â”‚
â”‚   phone: '010-1234-5678',                                    â”‚
â”‚   is_kakao: true  -- â­ í”Œë˜ê·¸                               â”‚
â”‚ }));                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5ë‹¨ê³„: ì£¼ë¬¸ ìƒì„± ì‹œ order_type ì €ì¥                          â”‚
â”‚                                                              â”‚
â”‚ createOrder(orderData, userProfile, depositName)             â”‚
â”‚  â†“ checks                                                    â”‚
â”‚ IF (userProfile.is_kakao) THEN                               â”‚
â”‚   order_type = `direct:KAKAO:${userProfile.kakao_id}`       â”‚
â”‚   user_id = NULL  -- â­ auth.usersì— ì—†ìŒ                    â”‚
â”‚ ELSE                                                         â”‚
â”‚   order_type = 'direct'                                      â”‚
â”‚   user_id = auth.uid()                                       â”‚
â”‚ END IF                                                       â”‚
â”‚                                                              â”‚
â”‚ INSERT INTO orders (                                         â”‚
â”‚   user_id,        -- NULL (ì¹´ì¹´ì˜¤) or UUID (ì¼ë°˜)           â”‚
â”‚   order_type,     -- 'direct:KAKAO:1234567890'              â”‚
â”‚   ...                                                        â”‚
â”‚ );                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6ë‹¨ê³„: ì£¼ë¬¸ ì¡°íšŒ (RLS ì •ì±… ìë™ ì ìš©)                        â”‚
â”‚                                                              â”‚
â”‚ getOrders()                                                  â”‚
â”‚  â†“ RLS SELECT ì •ì±…                                           â”‚
â”‚ SELECT * FROM orders                                         â”‚
â”‚ WHERE (                                                      â”‚
â”‚   -- ì¼ë°˜ ì‚¬ìš©ì                                             â”‚
â”‚   user_id = auth.uid()                                       â”‚
â”‚   OR                                                         â”‚
â”‚   -- ì¹´ì¹´ì˜¤ ì‚¬ìš©ì (í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©)                          â”‚
â”‚   order_type LIKE '%KAKAO:' ||                               â”‚
â”‚                  get_current_user_kakao_id() || '%'          â”‚
â”‚   OR                                                         â”‚
â”‚   -- ê´€ë¦¬ì                                                  â”‚
â”‚   (SELECT is_admin FROM profiles                             â”‚
â”‚    WHERE id = auth.uid()) = true                             â”‚
â”‚ );                                                           â”‚
â”‚                                                              â”‚
â”‚ ì„±ëŠ¥ ìµœì í™” (2025-10-05):                                    â”‚
â”‚  â”œâ”€â”€ get_current_user_kakao_id() í•¨ìˆ˜ ìºì‹± (STABLE)         â”‚
â”‚  â”œâ”€â”€ idx_orders_order_type_gin (GIN ì¸ë±ìŠ¤)                 â”‚
â”‚  â””â”€â”€ idx_profiles_id_kakao_id (ë³µí•© ì¸ë±ìŠ¤)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ì—°ê²° ë‹¤ì´ì–´ê·¸ë¨

### 4.1 ì¿ í° ì‹œìŠ¤í…œ í…Œì´ë¸” ê´€ê³„

```
profiles (ì‚¬ìš©ì)
    â”œâ”€â”€ id (UUID) - auth.users ì—°ê²°
    â””â”€â”€ is_admin (BOOLEAN)
        â†“
        â”‚ (FK: created_by)
        â†“
    coupons (ì¿ í° ë§ˆìŠ¤í„°)
        â”œâ”€â”€ id (UUID)
        â”œâ”€â”€ code (VARCHAR) UNIQUE - 'WELCOME10'
        â”œâ”€â”€ discount_type (VARCHAR) - 'fixed_amount' | 'percentage'
        â”œâ”€â”€ discount_value (DECIMAL) - 10% ë˜ëŠ” 10000ì›
        â”œâ”€â”€ min_purchase_amount (DECIMAL) - ìµœì†Œ êµ¬ë§¤ ê¸ˆì•¡
        â”œâ”€â”€ max_discount_amount (DECIMAL) - í¼ì„¼íŠ¸ ìµœëŒ€ í• ì¸
        â”œâ”€â”€ valid_from, valid_until (TIMESTAMPTZ) - ìœ íš¨ ê¸°ê°„
        â”œâ”€â”€ usage_limit_per_user (INT) - ì‚¬ìš©ìë‹¹ íšŸìˆ˜
        â”œâ”€â”€ total_usage_limit (INT) - ì „ì²´ ì‚¬ìš© í•œë„
        â”œâ”€â”€ total_issued_count (INT) - ì´ ë°œê¸‰ ìˆ˜ (íŠ¸ë¦¬ê±° ìë™)
        â”œâ”€â”€ total_used_count (INT) - ì´ ì‚¬ìš© ìˆ˜ (íŠ¸ë¦¬ê±° ìë™)
        â””â”€â”€ is_active (BOOLEAN) - í™œì„±í™” ì—¬ë¶€
            â†“
            â”‚ (FK: coupon_id)
            â†“
        user_coupons (ì‚¬ìš©ìë³„ ì¿ í°)
            â”œâ”€â”€ id (UUID)
            â”œâ”€â”€ user_id (UUID) FK â†’ profiles
            â”œâ”€â”€ coupon_id (UUID) FK â†’ coupons
            â”œâ”€â”€ is_used (BOOLEAN) - ì‚¬ìš© ì—¬ë¶€
            â”œâ”€â”€ used_at (TIMESTAMPTZ) - ì‚¬ìš© ì‹œì 
            â”œâ”€â”€ order_id (UUID) FK â†’ orders - ì–´ë–¤ ì£¼ë¬¸ì— ì‚¬ìš©?
            â”œâ”€â”€ discount_amount (DECIMAL) - ì‹¤ì œ í• ì¸ ê¸ˆì•¡ (ìŠ¤ëƒ…ìƒ·)
            â””â”€â”€ issued_by (UUID) FK â†’ profiles - ë°°í¬ì
                â†“
                â”‚ (FK: order_id)
                â†“
            orders (ì£¼ë¬¸)
                â”œâ”€â”€ id (UUID)
                â”œâ”€â”€ discount_amount (DECIMAL) - ì¿ í° í• ì¸ (2025-10-04)
                â””â”€â”€ total_amount (DECIMAL) - ìƒí’ˆê¸ˆì•¡ + ë°°ì†¡ë¹„
```

### 4.2 ë°°ì†¡ë¹„ ê³„ì‚° í…Œì´ë¸” ê´€ê³„

```
profiles (ì‚¬ìš©ì)
    â”œâ”€â”€ postal_code (VARCHAR) - ê¸°ë³¸ ë°°ì†¡ì§€ ìš°í¸ë²ˆí˜¸ (2025-10-03)
    â””â”€â”€ addresses (JSONB) - ì—¬ëŸ¬ ë°°ì†¡ì§€ ë°°ì—´
        [
          {
            postal_code: '63100',
            address: 'ì œì£¼ì‹œ...',
            is_default: true
          }
        ]
        â†“
        â”‚ (ì£¼ë¬¸ ìƒì„± ì‹œ ë³µì‚¬)
        â†“
    order_shipping (ë°°ì†¡ ì •ë³´)
        â”œâ”€â”€ id (UUID)
        â”œâ”€â”€ order_id (UUID) FK â†’ orders
        â”œâ”€â”€ postal_code (VARCHAR) - ì£¼ë¬¸ ì‹œì  ìš°í¸ë²ˆí˜¸ â­
        â”œâ”€â”€ address (TEXT)
        â”œâ”€â”€ detail_address (TEXT)
        â”œâ”€â”€ shipping_cost (NUMERIC) - ì €ì¥ëœ ë°°ì†¡ë¹„
        â”œâ”€â”€ name (TEXT)
        â”œâ”€â”€ phone (TEXT)
        â””â”€â”€ tracking_number (VARCHAR) - ì†¡ì¥ë²ˆí˜¸ (optional)
```

### 4.3 ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í…Œì´ë¸” ê´€ê³„

```
Kakao OAuth Server
    â†“ (ì¸ì¦ ì„±ê³µ)
    kakao_id: '1234567890'
    email, name, nickname, phone
    â†“
profiles (ì‚¬ìš©ì)
    â”œâ”€â”€ id (UUID) - NULL ë˜ëŠ” Supabase UUID
    â”œâ”€â”€ kakao_id (TEXT) - '1234567890' â­ í•µì‹¬
    â”œâ”€â”€ email (TEXT)
    â”œâ”€â”€ name (TEXT)
    â”œâ”€â”€ nickname (TEXT)
    â”œâ”€â”€ phone (TEXT)
    â”œâ”€â”€ provider (TEXT) - 'kakao'
    â””â”€â”€ is_admin (BOOLEAN)
        â†“
        â”‚ (ì£¼ë¬¸ ìƒì„± ì‹œ)
        â†“
    orders (ì£¼ë¬¸)
        â”œâ”€â”€ id (UUID)
        â”œâ”€â”€ user_id (UUID) - NULL (ì¹´ì¹´ì˜¤) | UUID (ì¼ë°˜)
        â”œâ”€â”€ order_type (VARCHAR) - 'direct:KAKAO:1234567890' â­
        â””â”€â”€ ...
            â†“
            â”‚ (RLS ì •ì±…)
            â†“
        SELECT ì •ì±…:
            user_id = auth.uid()  -- ì¼ë°˜ ì‚¬ìš©ì
            OR
            order_type LIKE '%KAKAO:' ||
                get_current_user_kakao_id() || '%'  -- ì¹´ì¹´ì˜¤ ì‚¬ìš©ì
```

---

## 5. í•¨ìˆ˜ ì²´ì¸ (Function Call Chain)

### 5.1 ì¿ í° ìƒì„± â†’ ë°°í¬ â†’ ì‚¬ìš© í•¨ìˆ˜ ì²´ì¸

```javascript
// ========================================
// 1. ì¿ í° ìƒì„± (ê´€ë¦¬ì)
// ========================================

// í”„ë¡ íŠ¸ì—”ë“œ (lib/couponApi.js)
createCoupon(couponData)
  â†“ calls API Route
  POST /api/admin/coupons/create
  â†“ with body
  {
    adminEmail: localStorage.getItem('adminEmail'),
    code: 'WELCOME10',
    discount_type: 'percentage',
    discount_value: 10,
    max_discount_amount: 5000,
    ...
  }

// ì„œë²„ ì‚¬ì´ë“œ (app/api/admin/coupons/create/route.js)
export async function POST(request) {
  const { adminEmail, ...couponData } = await request.json()

  â†“ validates
  verifyAdminAuth(adminEmail)
    â”œâ”€â”€ process.env.ADMIN_EMAILS.split(',').includes(adminEmail)
    â””â”€â”€ IF (false) THEN return 403

  â†“ validates data
  validateCouponData(couponData)
    â”œâ”€â”€ percentage íƒ€ì…ì€ max_discount_amount í•„ìˆ˜
    â”œâ”€â”€ valid_until > valid_from
    â””â”€â”€ discount_value > 0

  â†“ creates (Service Role)
  const { data, error } = await supabaseAdmin
    .from('coupons')
    .insert({
      code: couponData.code.toUpperCase(),
      ...couponData,
      created_by: adminUserId
    })
    .select()

  â†“ returns
  return NextResponse.json({ success: true, coupon: data })
}

// ========================================
// 2. ì¿ í° ë°°í¬ (ê´€ë¦¬ì)
// ========================================

// í”„ë¡ íŠ¸ì—”ë“œ
distributeCoupon(couponId, userIds)
  â†“ calls API Route
  POST /api/admin/coupons/distribute
  â†“ with body
  { adminEmail, couponId, userIds: [...] }

// ì„œë²„ ì‚¬ì´ë“œ
export async function POST(request) {
  const { adminEmail, couponId, userIds } = await request.json()

  â†“ validates
  verifyAdminAuth(adminEmail)

  â†“ validates coupon
  const { data: coupon } = await supabaseAdmin
    .from('coupons')
    .select('is_active')
    .eq('id', couponId)
    .single()

  IF (!coupon.is_active) THEN
    return 400 'ë¹„í™œì„±í™”ëœ ì¿ í°'

  â†“ distributes (Service Role)
  const userCoupons = userIds.map(userId => ({
    user_id: userId,
    coupon_id: couponId,
    issued_by: adminUserId,
    issued_at: new Date().toISOString()
  }))

  const { data, error } = await supabaseAdmin
    .from('user_coupons')
    .upsert(userCoupons)  -- ì¤‘ë³µ í—ˆìš© (2025-10-06)

  â†“ trigger (DB)
  UPDATE coupons
  SET total_issued_count = total_issued_count + userIds.length
  WHERE id = couponId

  â†“ returns
  return NextResponse.json({
    success: true,
    distributedCount: data.length,
    requestedCount: userIds.length
  })
}

// ========================================
// 3. ì¿ í° ê²€ì¦ (ì²´í¬ì•„ì›ƒ)
// ========================================

// í”„ë¡ íŠ¸ì—”ë“œ
handleApplyCoupon(couponCode)
  â†“ calls
  validateCoupon(couponCode, userId, productAmount)
    â†“ calls DB function
    const { data, error } = await supabase.rpc('validate_coupon', {
      p_coupon_code: couponCode,
      p_user_id: userId,
      p_product_amount: productAmount  -- ë°°ì†¡ë¹„ ì œì™¸!
    })

    â†“ returns
    {
      is_valid: true,
      error_message: null,
      coupon_id: 'uuid',
      discount_amount: 5000
    }

  â†“ if (is_valid)
  setAppliedCoupon({ code, discountAmount })

  â†“ calculates
  finalAmount = productAmount - discountAmount + shippingFee

// DB í•¨ìˆ˜ (validate_coupon)
CREATE OR REPLACE FUNCTION validate_coupon(
    p_coupon_code VARCHAR(50),
    p_user_id UUID,
    p_product_amount DECIMAL(12, 2)
)
RETURNS TABLE (...) AS $$
DECLARE
    v_coupon coupons%ROWTYPE;
    v_discount DECIMAL(12, 2);
BEGIN
    -- 1. ì¿ í° ì¡°íšŒ
    SELECT * INTO v_coupon
    FROM coupons
    WHERE code = UPPER(p_coupon_code)
      AND is_active = true;

    IF NOT FOUND THEN
        RETURN QUERY SELECT false, 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì¿ í°', NULL, 0;
        RETURN;
    END IF;

    -- 2. ìœ íš¨ ê¸°ê°„ í™•ì¸
    IF NOW() < v_coupon.valid_from THEN
        RETURN QUERY SELECT false, 'ì•„ì§ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ì¿ í°', NULL, 0;
        RETURN;
    END IF;

    IF NOW() > v_coupon.valid_until THEN
        RETURN QUERY SELECT false, 'ìœ íš¨ ê¸°ê°„ì´ ë§Œë£Œëœ ì¿ í°', NULL, 0;
        RETURN;
    END IF;

    -- 3. ìµœì†Œ êµ¬ë§¤ ê¸ˆì•¡
    IF p_product_amount < v_coupon.min_purchase_amount THEN
        RETURN QUERY SELECT false,
            'ìµœì†Œ êµ¬ë§¤ ê¸ˆì•¡ ' || v_coupon.min_purchase_amount || 'ì› ì´ìƒ',
            NULL, 0;
        RETURN;
    END IF;

    -- 4. ì „ì²´ ì‚¬ìš© í•œë„
    IF v_coupon.total_usage_limit IS NOT NULL THEN
        IF v_coupon.total_used_count >= v_coupon.total_usage_limit THEN
            RETURN QUERY SELECT false, 'ì¿ í° ì‚¬ìš© ê°€ëŠ¥ íšŸìˆ˜ ì´ˆê³¼', NULL, 0;
            RETURN;
        END IF;
    END IF;

    -- 5. ì‚¬ìš©ì ë³´ìœ  í™•ì¸
    IF NOT EXISTS (
        SELECT 1 FROM user_coupons
        WHERE user_id = p_user_id
          AND coupon_id = v_coupon.id
    ) THEN
        RETURN QUERY SELECT false, 'ë³´ìœ í•˜ì§€ ì•Šì€ ì¿ í°', NULL, 0;
        RETURN;
    END IF;

    -- 6. ì‚¬ìš© ì´ë ¥ í™•ì¸
    IF EXISTS (
        SELECT 1 FROM user_coupons
        WHERE user_id = p_user_id
          AND coupon_id = v_coupon.id
          AND is_used = true
    ) THEN
        RETURN QUERY SELECT false, 'ì´ë¯¸ ì‚¬ìš©í•œ ì¿ í°', NULL, 0;
        RETURN;
    END IF;

    -- 7. í• ì¸ ê¸ˆì•¡ ê³„ì‚°
    IF v_coupon.discount_type = 'fixed_amount' THEN
        v_discount := LEAST(v_coupon.discount_value, p_product_amount);
    ELSE -- percentage
        v_discount := p_product_amount * (v_coupon.discount_value / 100);
        IF v_coupon.max_discount_amount IS NOT NULL THEN
            v_discount := LEAST(v_discount, v_coupon.max_discount_amount);
        END IF;
    END IF;

    -- ì„±ê³µ ë°˜í™˜
    RETURN QUERY SELECT true, NULL::TEXT, v_coupon.id, v_discount;
END;
$$ LANGUAGE plpgsql;

// ========================================
// 4. ì¿ í° ì‚¬ìš© ì²˜ë¦¬ (ì£¼ë¬¸ ìƒì„± í›„)
// ========================================

// í”„ë¡ íŠ¸ì—”ë“œ
createOrder(...)
  â†“ after success
  applyCouponUsage(userId, couponId, orderId, discountAmount)
    â†“ calls DB function
    const { data, error } = await supabase.rpc('use_coupon', {
      p_user_id: userId,
      p_coupon_id: couponId,
      p_order_id: orderId,
      p_discount_amount: discountAmount
    })

    â†“ returns
    true/false (ì„±ê³µ ì—¬ë¶€)

// DB í•¨ìˆ˜ (use_coupon)
CREATE OR REPLACE FUNCTION use_coupon(
    p_user_id UUID,
    p_coupon_id UUID,
    p_order_id UUID,
    p_discount_amount DECIMAL(12, 2)
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER  -- RLS ìš°íšŒ
AS $$
DECLARE
    v_affected_rows INT;
BEGIN
    -- user_coupons ì—…ë°ì´íŠ¸
    UPDATE user_coupons
    SET is_used = true,
        used_at = NOW(),
        order_id = p_order_id,
        discount_amount = p_discount_amount
    WHERE user_id = p_user_id
      AND coupon_id = p_coupon_id
      AND is_used = false;  -- ì¤‘ë³µ ì‚¬ìš© ë°©ì§€

    GET DIAGNOSTICS v_affected_rows = ROW_COUNT;

    IF v_affected_rows = 0 THEN
        RETURN false;  -- ì´ë¯¸ ì‚¬ìš©ë¨
    END IF;

    -- íŠ¸ë¦¬ê±° ìë™ ì‹¤í–‰: coupons.total_used_count++

    RETURN true;
END;
$$;
```

### 5.2 ë°°ì†¡ë¹„ ê³„ì‚° í•¨ìˆ˜ ì²´ì¸

```javascript
// ========================================
// ë°°ì†¡ë¹„ ê³„ì‚° (ì²´í¬ì•„ì›ƒ)
// ========================================

// í”„ë¡ íŠ¸ì—”ë“œ
useEffect(() => {
  loadShippingInfo()
}, [postalCode])

loadShippingInfo()
  â†“ calls
  formatShippingInfo(baseShipping, postalCode)
    â†“ calls (lib/shippingUtils.js)
    calculateShippingSurcharge(postalCode)
      â†“ validates
      IF (!postalCode || postalCode.length !== 5) THEN
        return { isRemote: false, region: 'ì¼ë°˜', surcharge: 0 }

      â†“ converts
      const postalNum = parseInt(postalCode, 10)

      â†“ checks
      IF (63000 <= postalNum && postalNum <= 63644) THEN
        return {
          isRemote: true,
          region: 'ì œì£¼',
          surcharge: 3000
        }
      ELSE IF (40200 <= postalNum && postalNum <= 40240) THEN
        return {
          isRemote: true,
          region: 'ìš¸ë¦‰ë„',
          surcharge: 5000
        }
      ELSE
        return {
          isRemote: false,
          region: 'ì¼ë°˜',
          surcharge: 0
        }

    â†“ returns (formatShippingInfo)
    {
      baseShipping: 4000,
      surcharge: 3000,
      totalShipping: 7000,
      isRemote: true,
      region: 'ì œì£¼'
    }

  â†“ updates UI
  setShippingInfo(shippingInfo)

  â†“ calculates final amount
  finalAmount = productAmount - discountAmount + shippingInfo.totalShipping
```

### 5.3 ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í•¨ìˆ˜ ì²´ì¸

```javascript
// ========================================
// ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì „ì²´ íë¦„
// ========================================

// 1. ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
handleKakaoLogin()
  â†“ redirects
  window.location.href = `https://kauth.kakao.com/oauth/authorize?
    client_id=${KAKAO_APP_KEY}&
    redirect_uri=${REDIRECT_URI}&
    response_type=code`

// 2. ì½œë°± ì²˜ë¦¬ (/auth/callback)
useEffect(() => {
  const code = searchParams.get('code')
  if (code) {
    handleKakaoCallback(code)
  }
}, [])

handleKakaoCallback(code)
  â†“ calls
  getKakaoToken(code)
    â†“ POST
    fetch('https://kauth.kakao.com/oauth/token', {
      method: 'POST',
      body: new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: KAKAO_APP_KEY,
        redirect_uri: REDIRECT_URI,
        code: code
      })
    })
    â†“ returns
    { access_token, refresh_token }

  â†“ calls
  getKakaoUserInfo(accessToken)
    â†“ GET
    fetch('https://kapi.kakao.com/v2/user/me', {
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    })
    â†“ returns
    {
      id: '1234567890',  -- kakao_id
      kakao_account: {
        profile: { nickname },
        email,
        phone_number
      }
    }

  â†“ saves to DB
  upsertKakaoProfile(kakaoUserInfo)
    â†“ queries
    const { data: existingProfile } = await supabase
      .from('profiles')
      .select('*')
      .eq('kakao_id', kakaoUserInfo.id)
      .single()

    â†“ if not exists
    const { data: newProfile } = await supabase
      .from('profiles')
      .insert({
        kakao_id: kakaoUserInfo.id,
        email: kakaoUserInfo.kakao_account.email,
        name: kakaoUserInfo.kakao_account.profile.nickname,
        nickname: kakaoUserInfo.kakao_account.profile.nickname,
        phone: kakaoUserInfo.kakao_account.phone_number,
        provider: 'kakao'
      })
      .select()

    â†“ returns
    profile (existing or new)

  â†“ saves to sessionStorage
  sessionStorage.setItem('user', JSON.stringify({
    kakao_id: profile.kakao_id,
    email: profile.email,
    name: profile.name,
    nickname: profile.nickname,
    phone: profile.phone,
    is_kakao: true  -- í”Œë˜ê·¸
  }))

  â†“ redirects
  router.push('/')

// 3. ì£¼ë¬¸ ì¡°íšŒ (RLS ìë™ ì²˜ë¦¬)
getOrders()
  â†“ calls
  const { data, error } = await supabase
    .from('orders')
    .select(`
      *,
      order_items(*),
      order_shipping(*),
      order_payments(*)
    `)

  â†“ RLS SELECT ì •ì±… ìë™ ì ìš©
  WHERE (
    user_id = auth.uid()  -- ì¼ë°˜ ì‚¬ìš©ì
    OR
    order_type LIKE '%KAKAO:' || get_current_user_kakao_id() || '%'
    OR
    (SELECT is_admin FROM profiles WHERE id = auth.uid()) = true
  )

  â†“ returns
  ì¹´ì¹´ì˜¤ ì‚¬ìš©ìì˜ ëª¨ë“  ì£¼ë¬¸ (order_type ë§¤ì¹­)
```

---

## ğŸ¯ Claudeìš© ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì¿ í° ìƒì„± ì‹œ í•„ìˆ˜ í™•ì¸ ì‚¬í•­

```
âœ… percentage íƒ€ì…ì€ max_discount_amount í•„ìˆ˜
âœ… valid_until > valid_from (ë‚ ì§œ ë²”ìœ„ ê²€ì¦)
âœ… discount_value > 0
âœ… Service Role API ì‚¬ìš© (/api/admin/coupons/create)
âœ… ê´€ë¦¬ì ê¶Œí•œ ê²€ì¦ (verifyAdminAuth)
âœ… ì¿ í° ì½”ë“œ ìë™ ëŒ€ë¬¸ì (code.toUpperCase())
```

### ì¿ í° ê²€ì¦ ì‹œ í•„ìˆ˜ í™•ì¸ ì‚¬í•­

```
âœ… validateCoupon() DB í•¨ìˆ˜ í˜¸ì¶œ
âœ… p_product_amountëŠ” ë°°ì†¡ë¹„ ì œì™¸ ìƒí’ˆ ê¸ˆì•¡ë§Œ
âœ… 7ë‹¨ê³„ ê²€ì¦ ìˆœì„œ ì¤€ìˆ˜
   1. ì¿ í° ì¡´ì¬/í™œì„±í™”
   2. ìœ íš¨ ê¸°ê°„ ì‹œì‘ ì „
   3. ìœ íš¨ ê¸°ê°„ ë§Œë£Œ
   4. ìµœì†Œ êµ¬ë§¤ ê¸ˆì•¡
   5. ì „ì²´ ì‚¬ìš© í•œë„
   6. ì‚¬ìš©ì ë³´ìœ 
   7. ì‚¬ìš© ì´ë ¥
âœ… í• ì¸ ê¸ˆì•¡ ê³„ì‚°:
   - fixed_amount: LEAST(discount_value, productAmount)
   - percentage: LEAST(amount * value / 100, max_discount_amount)
```

### ì¿ í° ì‚¬ìš© ì²˜ë¦¬ ì‹œ í•„ìˆ˜ í™•ì¸ ì‚¬í•­

```
âœ… ì£¼ë¬¸ ìƒì„± í›„ ì¦‰ì‹œ applyCouponUsage() í˜¸ì¶œ
âœ… use_coupon() DB í•¨ìˆ˜ (SECURITY DEFINER)
âœ… is_used = false ì¡°ê±´ (ì¤‘ë³µ ì‚¬ìš© ë°©ì§€)
âœ… íŠ¸ë¦¬ê±° ìë™ ì‹¤í–‰ (coupons.total_used_count++)
âœ… ì‹¤íŒ¨í•´ë„ ì£¼ë¬¸ ì·¨ì†Œ ì•ˆ í•¨ (ì¿ í°ì€ ì¬ë°œí–‰ ê°€ëŠ¥)
```

### ë°°ì†¡ë¹„ ê³„ì‚° ì‹œ í•„ìˆ˜ í™•ì¸ ì‚¬í•­

```
âœ… postal_code í•„ìˆ˜ (profiles, order_shipping)
âœ… formatShippingInfo(baseShipping, postalCode) ì‚¬ìš©
âœ… calculateShippingSurcharge(postalCode) í˜¸ì¶œ
âœ… ë„ì„œì‚°ê°„ ê·œì¹™:
   - ì œì£¼ (63000-63644): +3,000ì›
   - ìš¸ë¦‰ë„ (40200-40240): +5,000ì›
   - ê¸°íƒ€ ë„ì„œì‚°ê°„: +5,000ì› (í–¥í›„ í™•ì¥)
âœ… pending ìƒíƒœì—ì„œëŠ” ë°°ì†¡ë¹„ 0ì›
âœ… DB ì €ì¥ê°’ê³¼ ê³„ì‚°ê°’ ë¹„êµ (ê´€ë¦¬ì í˜ì´ì§€)
```

### ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œ í•„ìˆ˜ í™•ì¸ ì‚¬í•­

```
âœ… profiles.kakao_id ì €ì¥
âœ… orders.user_id = NULL (auth.users ì—†ìŒ)
âœ… orders.order_type = 'direct:KAKAO:${kakao_id}'
âœ… sessionStorageì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
âœ… is_kakao í”Œë˜ê·¸ ì„¤ì •
âœ… RLS ì •ì±… ìë™ ë§¤ì¹­:
   - order_type LIKE '%KAKAO:' || get_current_user_kakao_id() || '%'
âœ… ì„±ëŠ¥ ìµœì í™”:
   - get_current_user_kakao_id() í•¨ìˆ˜ ìºì‹±
   - idx_orders_order_type_gin (GIN ì¸ë±ìŠ¤)
   - idx_profiles_id_kakao_id (ë³µí•© ì¸ë±ìŠ¤)
```

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-10-08
**ì‘ì„±ì**: Claude (AI Assistant)
**ë²„ì „**: 1.0
