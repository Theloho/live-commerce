# FEATURE_CONNECTIVITY_MAP_PART1.md - ì£¼ë¬¸ + ìƒí’ˆ ì‹œìŠ¤í…œ

**âš ï¸ ì´ íŒŒì¼ì€ ì „ì²´ ë¬¸ì„œì˜ Part 1ì…ë‹ˆë‹¤**
- **Part 1**: ì£¼ë¬¸ ì‹œìŠ¤í…œ + ìƒí’ˆ ì‹œìŠ¤í…œ â† **í˜„ì¬ íŒŒì¼**
- **Part 2**: ì¿ í° ì‹œìŠ¤í…œ + ë°°ì†¡ ì‹œìŠ¤í…œ
- **Part 3**: ê´€ë¦¬ì ì‹œìŠ¤í…œ + ë°œì£¼ ì‹œìŠ¤í…œ

**ìƒì„±ì¼**: 2025-10-08
**ë²„ì „**: 1.0
**ëª©ì **: ì£¼ë¬¸ ë° ìƒí’ˆ ê´€ë ¨ ê¸°ëŠ¥ì˜ ì—°ê²°ì„±ê³¼ ë°ì´í„° íë¦„ íŒŒì•…

---

## ğŸ“‹ ëª©ì°¨

1. [ì£¼ë¬¸ ìƒì„± ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±](#1-ì£¼ë¬¸-ìƒì„±-ì‹œìŠ¤í…œ-ì „ì²´-ì—°ê²°ì„±)
2. [ìƒí’ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±](#2-ìƒí’ˆ-ê´€ë¦¬-ì‹œìŠ¤í…œ-ì „ì²´-ì—°ê²°ì„±)
3. [Variant ì¬ê³  ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±](#3-variant-ì¬ê³ -ì‹œìŠ¤í…œ-ì „ì²´-ì—°ê²°ì„±)
4. [ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ì—°ê²° ë‹¤ì´ì–´ê·¸ë¨](#4-ë°ì´í„°ë² ì´ìŠ¤-í…Œì´ë¸”-ì—°ê²°-ë‹¤ì´ì–´ê·¸ë¨)
5. [í•¨ìˆ˜ ì²´ì¸ (Function Call Chain)](#5-í•¨ìˆ˜-ì²´ì¸-function-call-chain)

---

## 1. ì£¼ë¬¸ ìƒì„± ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±

### 1.1 ì£¼ë¬¸ ìƒì„± ì „ì²´ íë¦„ (ì‹œì‘ â†’ ì¢…ë£Œ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì‹œì‘: í™ˆ í˜ì´ì§€ (/) - ìƒí’ˆ ì¹´ë“œ í´ë¦­                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: BuyBottomSheet ì˜µì…˜ ì„ íƒ                              â”‚
â”‚                                                              â”‚
â”‚ ì…ë ¥: product, selectedOptions                               â”‚
â”‚ ì²˜ë¦¬:                                                        â”‚
â”‚  â”œâ”€â”€ getProductVariants(productId) - Variant ì¡°íšŒ           â”‚
â”‚  â”œâ”€â”€ findVariant(selectedOptions) - ì˜µì…˜ ë§¤ì¹­               â”‚
â”‚  â””â”€â”€ checkVariantInventory(variantId) - ì¬ê³  í™•ì¸           â”‚
â”‚                                                              â”‚
â”‚ ì¶œë ¥: variantId, quantity, availableInventory                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: ì²´í¬ì•„ì›ƒ í˜ì´ì§€ (/checkout)                           â”‚
â”‚                                                              â”‚
â”‚ ì…ë ¥: sessionStorage.checkoutItem                            â”‚
â”‚ ì²˜ë¦¬ (ë³‘ë ¬):                                                 â”‚
â”‚  â”œâ”€â”€ UserProfileManager.getCurrentUser() - í”„ë¡œí•„ ì¡°íšŒ      â”‚
â”‚  â”œâ”€â”€ loadUserCouponsOptimized() - ì¿ í° ëª©ë¡ ì¡°íšŒ            â”‚
â”‚  â””â”€â”€ formatShippingInfo(baseShipping, postalCode)           â”‚
â”‚      â””â”€â”€ calculateShippingSurcharge(postalCode)             â”‚
â”‚          â””â”€â”€ ë„ì„œì‚°ê°„ ë°°ì†¡ë¹„ ê³„ì‚°                            â”‚
â”‚                                                              â”‚
â”‚ ìƒí˜¸ì‘ìš©:                                                    â”‚
â”‚  â”œâ”€â”€ AddressManager - ë°°ì†¡ì§€ ì„ íƒ (ìš°í¸ë²ˆí˜¸ í•„ìˆ˜)           â”‚
â”‚  â”œâ”€â”€ handleApplyCoupon() - ì¿ í° ì„ íƒ                         â”‚
â”‚  â”‚   â””â”€â”€ validateCoupon(code, userId, productAmount)        â”‚
â”‚  â”‚       â””â”€â”€ DB í•¨ìˆ˜: validate_coupon() (7ë‹¨ê³„ ê²€ì¦)        â”‚
â”‚  â””â”€â”€ ì…ê¸ˆìëª… ì„ íƒ ëª¨ë‹¬                                      â”‚
â”‚                                                              â”‚
â”‚ ì¶œë ¥:                                                        â”‚
â”‚  â”œâ”€â”€ shippingInfo {baseShipping, surcharge, totalShipping}  â”‚
â”‚  â”œâ”€â”€ discountAmount (ì¿ í° í• ì¸)                              â”‚
â”‚  â””â”€â”€ finalAmount = productAmount - discount + shipping      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ë‹¨ê³„: ì£¼ë¬¸ ë°ì´í„° ì €ì¥ (createOrder)                        â”‚
â”‚                                                              â”‚
â”‚ DB ì‘ì—… ìˆœì„œ (íŠ¸ëœì­ì…˜):                                      â”‚
â”‚  1. product_variants (FOR UPDATE) - ì¬ê³  ì ê¸ˆ               â”‚
â”‚  2. orders (INSERT)                                          â”‚
â”‚     â”œâ”€â”€ customer_order_number: 'S251003-1234'               â”‚
â”‚     â”œâ”€â”€ user_id: UUID (ì¼ë°˜) or NULL (ì¹´ì¹´ì˜¤)               â”‚
â”‚     â”œâ”€â”€ order_type: 'direct:KAKAO:1234567890'               â”‚
â”‚     â”œâ”€â”€ status: 'pending'                                    â”‚
â”‚     â”œâ”€â”€ total_amount: ìƒí’ˆê¸ˆì•¡ + ë°°ì†¡ë¹„                      â”‚
â”‚     â””â”€â”€ discount_amount: ì¿ í° í• ì¸ ê¸ˆì•¡                      â”‚
â”‚                                                              â”‚
â”‚  3. order_items (INSERT)                                     â”‚
â”‚     â”œâ”€â”€ title: ì£¼ë¬¸ ì‹œì  ìƒí’ˆëª… (ìŠ¤ëƒ…ìƒ·)                     â”‚
â”‚     â”œâ”€â”€ variant_id: UUID (ì¬ê³  ê´€ë¦¬ìš©)                       â”‚
â”‚     â”œâ”€â”€ selected_options: JSONB (ìŠ¤ëƒ…ìƒ·)                     â”‚
â”‚     â”œâ”€â”€ price, unit_price: ë‹¨ê°€ (ì–‘ìª½ ëª¨ë‘)                  â”‚
â”‚     â””â”€â”€ total, total_price: ì´ì•¡ (ì–‘ìª½ ëª¨ë‘)                 â”‚
â”‚                                                              â”‚
â”‚  4. order_shipping (INSERT)                                  â”‚
â”‚     â”œâ”€â”€ postal_code: ìš°í¸ë²ˆí˜¸ (í•„ìˆ˜)                         â”‚
â”‚     â””â”€â”€ address, detail_address, name, phone                â”‚
â”‚                                                              â”‚
â”‚  5. order_payments (INSERT)                                  â”‚
â”‚     â”œâ”€â”€ method: 'bank_transfer'                              â”‚
â”‚     â”œâ”€â”€ amount: finalAmount                                  â”‚
â”‚     â””â”€â”€ depositor_name: ì…ê¸ˆìëª…                             â”‚
â”‚                                                              â”‚
â”‚  6. product_variants (UPDATE) - ì¬ê³  ì°¨ê°                    â”‚
â”‚     â””â”€â”€ inventory = inventory - quantity                     â”‚
â”‚                                                              â”‚
â”‚  7. products (ìë™ UPDATE) - íŠ¸ë¦¬ê±° ì‹¤í–‰                     â”‚
â”‚     â””â”€â”€ inventory = SUM(variant.inventory)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ë‹¨ê³„: ì¿ í° ì‚¬ìš© ì²˜ë¦¬ (ì¿ í° ì„ íƒ ì‹œ)                         â”‚
â”‚                                                              â”‚
â”‚ applyCouponUsage(userId, couponId, orderId, discountAmount) â”‚
â”‚  â†“ calls DB function                                         â”‚
â”‚ use_coupon(p_user_id, p_coupon_id, p_order_id, ...)         â”‚
â”‚  â†“ updates                                                   â”‚
â”‚ user_coupons:                                                â”‚
â”‚  â”œâ”€â”€ is_used = true                                          â”‚
â”‚  â”œâ”€â”€ used_at = NOW()                                         â”‚
â”‚  â”œâ”€â”€ order_id = orderId                                      â”‚
â”‚  â””â”€â”€ discount_amount = discountAmount                        â”‚
â”‚  â†“ trigger                                                   â”‚
â”‚ coupons.total_used_count++ (ìë™)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì¢…ë£Œ: ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€ (/orders/[id]/complete)              â”‚
â”‚                                                              â”‚
â”‚ ë°ì´í„° ë¡œë”©:                                                 â”‚
â”‚  â”œâ”€â”€ getOrder(orderId) - ì£¼ë¬¸ ë°ì´í„° ì¡°íšŒ                    â”‚
â”‚  â””â”€â”€ formatShippingInfo(4000, postalCode) - ë°°ì†¡ë¹„ ì¬ê³„ì‚°   â”‚
â”‚                                                              â”‚
â”‚ âš ï¸ ì¤‘ìš”: DB ì €ì¥ê°’ ì§ì ‘ ì‚¬ìš© ê¸ˆì§€!                           â”‚
â”‚  âŒ orderData.payment?.amount (DB ì €ì¥ê°’)                    â”‚
â”‚  âœ… OrderCalculations.calculateFinalOrderAmount()           â”‚
â”‚     â””â”€â”€ ìƒí’ˆê¸ˆì•¡ - ì¿ í°í• ì¸ + ë°°ì†¡ë¹„ (ì •í™•í•œ ì¬ê³„ì‚°)         â”‚
â”‚                                                              â”‚
â”‚ í‘œì‹œ ë‚´ìš©:                                                   â”‚
â”‚  â”œâ”€â”€ ì£¼ë¬¸ë²ˆí˜¸                                                â”‚
â”‚  â”œâ”€â”€ ì£¼ë¬¸ ìƒí’ˆ (title, quantity, price)                     â”‚
â”‚  â”œâ”€â”€ ìƒí’ˆ ê¸ˆì•¡ (SUM of items)                                â”‚
â”‚  â”œâ”€â”€ ì¿ í° í• ì¸ (orderData.discount_amount)                   â”‚
â”‚  â”œâ”€â”€ ë°°ì†¡ë¹„ (ê¸°ë³¸ + ë„ì„œì‚°ê°„, formatShippingInfo ì‚¬ìš©)       â”‚
â”‚  â”œâ”€â”€ ìµœì¢… ê²°ì œ ê¸ˆì•¡ (orderCalc.finalAmount) â­ í•„ìˆ˜          â”‚
â”‚  â””â”€â”€ ë°°ì†¡ì§€ ì •ë³´                                             â”‚
â”‚                                                              â”‚
â”‚ ğŸ› 2025-10-08 ìˆ˜ì •: ì´ ê²°ì œê¸ˆì•¡ ê³„ì‚° ì˜¤ë¥˜ í•´ê²°              â”‚
â”‚  - ë¬¸ì œ: DB ì €ì¥ê°’ ì§ì ‘ í‘œì‹œ â†’ ì˜ëª»ëœ ê¸ˆì•¡ (â‚©373,000)       â”‚
â”‚  - í•´ê²°: OrderCalculations ì‚¬ìš© â†’ ì •í™•í•œ ê¸ˆì•¡ (â‚©1,485,000)  â”‚
â”‚  - ìœ„ì¹˜: /app/orders/[id]/complete/page.js:788-840          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ì£¼ë¬¸ ì¡°íšŒ íë¦„ (ì‚¬ìš©ì)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì‹œì‘: ì£¼ë¬¸ ë‚´ì—­ í˜ì´ì§€ (/orders)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: ì‚¬ìš©ì ì¸ì¦ í™•ì¸                                      â”‚
â”‚                                                              â”‚
â”‚ UserProfileManager.getCurrentUser()                          â”‚
â”‚  â†“ checks                                                    â”‚
â”‚ sessionStorage.getItem('user') (ì¹´ì¹´ì˜¤ ìš°ì„ )                 â”‚
â”‚  â†“ or                                                        â”‚
â”‚ supabase.auth.getUser() (ì¼ë°˜ ì‚¬ìš©ì)                        â”‚
â”‚  â†“ returns                                                   â”‚
â”‚ { id, kakao_id, is_kakao, ... }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: ì£¼ë¬¸ ëª©ë¡ ì¡°íšŒ (RLS ìë™ ì²˜ë¦¬)                        â”‚
â”‚                                                              â”‚
â”‚ getOrders()                                                  â”‚
â”‚  â†“ RLS SELECT ì •ì±… ìë™ ì ìš©                                 â”‚
â”‚ ì¼ë°˜ ì‚¬ìš©ì: user_id = auth.uid()                            â”‚
â”‚ ì¹´ì¹´ì˜¤ ì‚¬ìš©ì:                                               â”‚
â”‚  â””â”€â”€ order_type LIKE '%KAKAO:' || kakao_id || '%'           â”‚
â”‚  â””â”€â”€ get_current_user_kakao_id() í•¨ìˆ˜ ìºì‹±                   â”‚
â”‚                                                              â”‚
â”‚ JOIN:                                                        â”‚
â”‚  â”œâ”€â”€ order_items                                             â”‚
â”‚  â”œâ”€â”€ products                                                â”‚
â”‚  â”œâ”€â”€ order_shipping (postal_code â­ í•„ìˆ˜)                    â”‚
â”‚  â””â”€â”€ order_payments                                          â”‚
â”‚                                                              â”‚
â”‚ ë°ì´í„° ë§¤í•‘:                                                 â”‚
â”‚  â””â”€â”€ shipping.postal_code = order_shipping[0].postal_code   â”‚
â”‚      (ë°°ì†¡ë¹„ ê³„ì‚°ìš©, 2025-10-08 ì¶”ê°€)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ë‹¨ê³„: ì£¼ë¬¸ ìƒíƒœë³„ ê·¸ë£¹í™” ë° í‘œì‹œ                            â”‚
â”‚                                                              â”‚
â”‚ í•„í„°ë§:                                                      â”‚
â”‚  â”œâ”€â”€ payment_group_id ê¸°ì¤€ ê·¸ë£¹í™” (ì¼ê´„ê²°ì œ)                 â”‚
â”‚  â””â”€â”€ ìƒíƒœë³„ í•„í„° (pending/verifying/paid/delivered)         â”‚
â”‚                                                              â”‚
â”‚ âš ï¸ ì¤‘ìš”: ì£¼ë¬¸ ì¹´ë“œ ê¸ˆì•¡ ê³„ì‚° (ê° ì£¼ë¬¸ë§ˆë‹¤)                  â”‚
â”‚  1. formatShippingInfo(4000, order.shipping.postal_code)    â”‚
â”‚     â””â”€â”€ ë„ì„œì‚°ê°„ ë°°ì†¡ë¹„ í¬í•¨ ê³„ì‚°                            â”‚
â”‚  2. OrderCalculations.calculateFinalOrderAmount()           â”‚
â”‚     â””â”€â”€ ìƒí’ˆ - ì¿ í° + ë°°ì†¡ë¹„ = ì •í™•í•œ ì´ì•¡                   â”‚
â”‚                                                              â”‚
â”‚ í‘œì‹œ:                                                        â”‚
â”‚  â”œâ”€â”€ ì£¼ë¬¸ë²ˆí˜¸, ìƒí’ˆëª…, ìˆ˜ëŸ‰                                  â”‚
â”‚  â”œâ”€â”€ ì´ ì…ê¸ˆ ê¸ˆì•¡ (finalAmount) â­ DB ì €ì¥ê°’ ì‚¬ìš© ê¸ˆì§€!      â”‚
â”‚  â”œâ”€â”€ ì£¼ë¬¸ ìƒíƒœ (pending â†’ delivered)                        â”‚
â”‚  â””â”€â”€ íƒ€ì„ìŠ¤íƒ¬í”„ (created_at, paid_at, delivered_at)         â”‚
â”‚                                                              â”‚
â”‚ ğŸ› 2025-10-08 ìˆ˜ì •: ì£¼ë¬¸ ì¹´ë“œ ê¸ˆì•¡ ê³„ì‚° ì˜¤ë¥˜ í•´ê²°           â”‚
â”‚  - ë¬¸ì œ: ìƒí’ˆ ê¸ˆì•¡ë§Œ í‘œì‹œ (ë°°ì†¡ë¹„ ì œì™¸)                      â”‚
â”‚  - í•´ê²°: OrderCalculations ì‚¬ìš© (ë°°ì†¡ë¹„ í¬í•¨)                â”‚
â”‚  - ìœ„ì¹˜: /app/orders/page.js:600-610, 719                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ìƒí’ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±

### 2.1 ìƒí’ˆ ë“±ë¡ ì „ì²´ íë¦„ (ì˜µì…˜ ì—†ëŠ” ê²½ìš°)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì‹œì‘: ê´€ë¦¬ì ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ (/admin/products/new)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: ìƒí’ˆ ê¸°ë³¸ ì •ë³´ ì…ë ¥                                   â”‚
â”‚                                                              â”‚
â”‚ ì…ë ¥:                                                        â”‚
â”‚  â”œâ”€â”€ title: ìƒí’ˆëª…                                           â”‚
â”‚  â”œâ”€â”€ price: ê°€ê²©                                             â”‚
â”‚  â”œâ”€â”€ inventory: ì¬ê³  (ì˜µì…˜ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ê´€ë¦¬)               â”‚
â”‚  â”œâ”€â”€ description: ì„¤ëª…                                       â”‚
â”‚  â”œâ”€â”€ thumbnail_url: ì´ë¯¸ì§€ URL                               â”‚
â”‚  â”œâ”€â”€ category_id: ì¹´í…Œê³ ë¦¬                                   â”‚
â”‚  â””â”€â”€ supplier_id: ê³µê¸‰ì—…ì²´                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: DB ì €ì¥                                               â”‚
â”‚                                                              â”‚
â”‚ addProduct(productData)                                      â”‚
â”‚  â†“ inserts                                                   â”‚
â”‚ products (INSERT)                                            â”‚
â”‚  â”œâ”€â”€ id: gen_random_uuid()                                   â”‚
â”‚  â”œâ”€â”€ product_number: ìë™ ìƒì„± ë˜ëŠ” ìˆ˜ë™ ì…ë ¥               â”‚
â”‚  â”œâ”€â”€ status: 'active'                                        â”‚
â”‚  â”œâ”€â”€ is_live: false (ê¸°ë³¸ê°’)                                 â”‚
â”‚  â”œâ”€â”€ is_live_active: false (ê¸°ë³¸ê°’)                          â”‚
â”‚  â””â”€â”€ created_at: NOW()                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì¢…ë£Œ: ê´€ë¦¬ì ìƒí’ˆ ëª©ë¡ (/admin/products)                     â”‚
â”‚                                                              â”‚
â”‚ í‘œì‹œ:                                                        â”‚
â”‚  â”œâ”€â”€ ìƒí’ˆëª…, ê°€ê²©, ì¬ê³                                       â”‚
â”‚  â”œâ”€â”€ ì¹´í…Œê³ ë¦¬, ê³µê¸‰ì—…ì²´                                      â”‚
â”‚  â”œâ”€â”€ ë¼ì´ë¸Œ ìƒíƒœ (is_live, is_live_active)                  â”‚
â”‚  â””â”€â”€ ìƒíƒœ (active/inactive/deleted)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ìƒí’ˆ ë“±ë¡ ì „ì²´ íë¦„ (ì˜µì…˜ ìˆëŠ” ê²½ìš°)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì‹œì‘: ê´€ë¦¬ì ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ (/admin/products/new)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: ì˜µì…˜ ì„¤ì •                                             â”‚
â”‚                                                              â”‚
â”‚ ì…ë ¥:                                                        â”‚
â”‚  ì˜µì…˜ 1: ìƒ‰ìƒ â†’ [ë¸”ë™, í™”ì´íŠ¸, ë ˆë“œ]                         â”‚
â”‚  ì˜µì…˜ 2: ì‚¬ì´ì¦ˆ â†’ [S, M, L]                                  â”‚
â”‚                                                              â”‚
â”‚ ìë™ ê³„ì‚°:                                                   â”‚
â”‚  ì˜µì…˜ ì¡°í•© = 3 x 3 = 9ê°œ Variant ìƒì„± ì˜ˆì •                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: DB ì €ì¥ (íŠ¸ëœì­ì…˜)                                    â”‚
â”‚                                                              â”‚
â”‚ createProductWithOptions(productData, optionsData)           â”‚
â”‚                                                              â”‚
â”‚ 1. products (INSERT)                                         â”‚
â”‚    â””â”€â”€ ìƒí’ˆ ë§ˆìŠ¤í„° ë°ì´í„° ìƒì„±                               â”‚
â”‚                                                              â”‚
â”‚ 2. product_options (INSERT) - 2ê°œ                            â”‚
â”‚    â”œâ”€â”€ { name: 'ìƒ‰ìƒ', position: 1 }                         â”‚
â”‚    â””â”€â”€ { name: 'ì‚¬ì´ì¦ˆ', position: 2 }                       â”‚
â”‚                                                              â”‚
â”‚ 3. product_option_values (INSERT) - 6ê°œ                      â”‚
â”‚    â”œâ”€â”€ { option_id: ìƒ‰ìƒ, value: 'ë¸”ë™', position: 1 }       â”‚
â”‚    â”œâ”€â”€ { option_id: ìƒ‰ìƒ, value: 'í™”ì´íŠ¸', position: 2 }     â”‚
â”‚    â”œâ”€â”€ { option_id: ìƒ‰ìƒ, value: 'ë ˆë“œ', position: 3 }       â”‚
â”‚    â”œâ”€â”€ { option_id: ì‚¬ì´ì¦ˆ, value: 'S', position: 1 }        â”‚
â”‚    â”œâ”€â”€ { option_id: ì‚¬ì´ì¦ˆ, value: 'M', position: 2 }        â”‚
â”‚    â””â”€â”€ { option_id: ì‚¬ì´ì¦ˆ, value: 'L', position: 3 }        â”‚
â”‚                                                              â”‚
â”‚ 4. generateVariantCombinations() - ì˜µì…˜ ì¡°í•© ìƒì„±            â”‚
â”‚    ë°ì¹´ë¥´íŠ¸ ê³± ì•Œê³ ë¦¬ì¦˜:                                     â”‚
â”‚    [ë¸”ë™, í™”ì´íŠ¸, ë ˆë“œ] x [S, M, L] = 9ê°œ ì¡°í•©               â”‚
â”‚                                                              â”‚
â”‚ 5. product_variants (INSERT) - 9ê°œ                           â”‚
â”‚    â”œâ”€â”€ { sku: '0005-ë¸”ë™-S', inventory: 10, options: {...} } â”‚
â”‚    â”œâ”€â”€ { sku: '0005-ë¸”ë™-M', inventory: 10, options: {...} } â”‚
â”‚    â”œâ”€â”€ { sku: '0005-ë¸”ë™-L', inventory: 10, options: {...} } â”‚
â”‚    â”œâ”€â”€ { sku: '0005-í™”ì´íŠ¸-S', inventory: 10, ... }          â”‚
â”‚    â”œâ”€â”€ { sku: '0005-í™”ì´íŠ¸-M', inventory: 10, ... }          â”‚
â”‚    â”œâ”€â”€ { sku: '0005-í™”ì´íŠ¸-L', inventory: 10, ... }          â”‚
â”‚    â”œâ”€â”€ { sku: '0005-ë ˆë“œ-S', inventory: 10, ... }            â”‚
â”‚    â”œâ”€â”€ { sku: '0005-ë ˆë“œ-M', inventory: 10, ... }            â”‚
â”‚    â””â”€â”€ { sku: '0005-ë ˆë“œ-L', inventory: 10, ... }            â”‚
â”‚                                                              â”‚
â”‚ 6. variant_option_values (INSERT) - 18ê°œ (9 x 2)            â”‚
â”‚    ê° Variantë§ˆë‹¤ 2ê°œì˜ ë§¤í•‘ ë ˆì½”ë“œ:                         â”‚
â”‚    â”œâ”€â”€ { variant_id: v1, option_value_id: ë¸”ë™ }            â”‚
â”‚    â”œâ”€â”€ { variant_id: v1, option_value_id: S }               â”‚
â”‚    â”œâ”€â”€ { variant_id: v2, option_value_id: ë¸”ë™ }            â”‚
â”‚    â”œâ”€â”€ { variant_id: v2, option_value_id: M }               â”‚
â”‚    â””â”€â”€ ... (ì´ 18ê°œ)                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì¢…ë£Œ: ê´€ë¦¬ì ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ (/admin/products/[id])        â”‚
â”‚                                                              â”‚
â”‚ í‘œì‹œ:                                                        â”‚
â”‚  â”œâ”€â”€ ìƒí’ˆ ê¸°ë³¸ ì •ë³´                                          â”‚
â”‚  â”œâ”€â”€ ì˜µì…˜ ëª©ë¡ (ìƒ‰ìƒ, ì‚¬ì´ì¦ˆ)                                â”‚
â”‚  â”œâ”€â”€ Variant ëª©ë¡ (9ê°œ)                                      â”‚
â”‚  â”‚   â””â”€â”€ ê° Variantë³„ SKU, ì¬ê³ , ê°€ê²© í‘œì‹œ                  â”‚
â”‚  â””â”€â”€ ì´ ì¬ê³ : 90ê°œ (10 x 9)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 ìƒí’ˆ ë…¸ì¶œ (í™ˆ í˜ì´ì§€)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì‹œì‘: ê´€ë¦¬ìê°€ ë¼ì´ë¸Œ í™œì„±í™”                                 â”‚
â”‚                                                              â”‚
â”‚ updateProductLiveStatus(productId, true)                     â”‚
â”‚  â†“ updates                                                   â”‚
â”‚ products:                                                    â”‚
â”‚  â”œâ”€â”€ is_live = true                                          â”‚
â”‚  â””â”€â”€ is_live_active = true                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ í™ˆ í˜ì´ì§€ (/) - useRealtimeProducts hook                     â”‚
â”‚                                                              â”‚
â”‚ getProducts()                                                â”‚
â”‚  â†“ filters                                                   â”‚
â”‚ SELECT * FROM products                                       â”‚
â”‚ WHERE status = 'active'                                      â”‚
â”‚   AND is_live = true                                         â”‚
â”‚   AND is_live_active = true                                  â”‚
â”‚ ORDER BY live_priority ASC, created_at DESC                  â”‚
â”‚                                                              â”‚
â”‚  â†“ parallel (ë³‘ë ¬ ë¡œë“œ)                                      â”‚
â”‚ ê° ìƒí’ˆë§ˆë‹¤:                                                 â”‚
â”‚  â””â”€â”€ getProductVariants(productId)                           â”‚
â”‚      â””â”€â”€ ëª¨ë“  Variant ì¡°íšŒ                                   â”‚
â”‚      â””â”€â”€ ì´ ì¬ê³  ê³„ì‚° (SUM)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì¢…ë£Œ: í™ˆ í˜ì´ì§€ ìƒí’ˆ ì¹´ë“œ í‘œì‹œ                               â”‚
â”‚                                                              â”‚
â”‚ í‘œì‹œ:                                                        â”‚
â”‚  â”œâ”€â”€ ì´ë¯¸ì§€ (thumbnail_url)                                  â”‚
â”‚  â”œâ”€â”€ ìƒí’ˆëª… (title)                                          â”‚
â”‚  â”œâ”€â”€ ê°€ê²© (price)                                            â”‚
â”‚  â”œâ”€â”€ ì´ ì¬ê³  (ëª¨ë“  Variant í•©ê³„)                             â”‚
â”‚  â””â”€â”€ ì˜µì…˜ ì •ë³´ (ìƒ‰ìƒ 3ê°€ì§€, ì‚¬ì´ì¦ˆ 3ê°€ì§€)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Variant ì¬ê³  ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±

### 3.1 ì¬ê³  í™•ì¸ â†’ ì°¨ê° â†’ ë³µì› ì „ì²´ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: ì¬ê³  í™•ì¸ (BuyBottomSheet)                            â”‚
â”‚                                                              â”‚
â”‚ ì…ë ¥: selectedOptions = { ìƒ‰ìƒ: 'ë¸”ë™', ì‚¬ì´ì¦ˆ: 'M' }        â”‚
â”‚                                                              â”‚
â”‚ checkVariantInventory(productId, selectedOptions)            â”‚
â”‚  â†“ finds                                                     â”‚
â”‚ SELECT v.* FROM product_variants v                           â”‚
â”‚ JOIN variant_option_values vov ON v.id = vov.variant_id     â”‚
â”‚ JOIN product_option_values pov ON vov.option_value_id = ... â”‚
â”‚ WHERE v.product_id = productId                               â”‚
â”‚   AND pov.value IN ('ë¸”ë™', 'M')                             â”‚
â”‚   AND v.is_active = true                                     â”‚
â”‚ GROUP BY v.id                                                â”‚
â”‚ HAVING COUNT(*) = 2  -- 2ê°œ ì˜µì…˜ ëª¨ë‘ ì¼ì¹˜                   â”‚
â”‚                                                              â”‚
â”‚ ì¶œë ¥:                                                        â”‚
â”‚  â”œâ”€â”€ available: true                                         â”‚
â”‚  â”œâ”€â”€ inventory: 50 (ì¬ê³ )                                    â”‚
â”‚  â””â”€â”€ variantId: UUID                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: ì¬ê³  ì°¨ê° (ì£¼ë¬¸ ìƒì„± ì‹œ)                              â”‚
â”‚                                                              â”‚
â”‚ updateVariantInventory(variantId, -3)  -- 3ê°œ êµ¬ë§¤          â”‚
â”‚                                                              â”‚
â”‚ DB ì‘ì—… (íŠ¸ëœì­ì…˜):                                           â”‚
â”‚                                                              â”‚
â”‚ BEGIN;                                                       â”‚
â”‚                                                              â”‚
â”‚ -- 1. ì¬ê³  ì ê¸ˆ (ë™ì‹œì„± ì œì–´)                                â”‚
â”‚ SELECT inventory FROM product_variants                       â”‚
â”‚ WHERE id = variantId                                         â”‚
â”‚ FOR UPDATE;  -- â­ ë½ íšë“ (ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ ëŒ€ê¸°)               â”‚
â”‚                                                              â”‚
â”‚ -- 2. ì¬ê³  ë¶€ì¡± ì²´í¬                                         â”‚
â”‚ IF (currentInventory < 3) THEN                               â”‚
â”‚   ROLLBACK;                                                  â”‚
â”‚   RETURN ERROR 'ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤';                          â”‚
â”‚ END IF;                                                      â”‚
â”‚                                                              â”‚
â”‚ -- 3. ì¬ê³  ì°¨ê°                                              â”‚
â”‚ UPDATE product_variants                                      â”‚
â”‚ SET inventory = inventory - 3                                â”‚
â”‚ WHERE id = variantId;                                        â”‚
â”‚ -- ê²°ê³¼: 50 â†’ 47                                             â”‚
â”‚                                                              â”‚
â”‚ -- 4. íŠ¸ë¦¬ê±° ìë™ ì‹¤í–‰                                       â”‚
â”‚ -- products.inventory = SUM(variant.inventory) ì¬ê³„ì‚°       â”‚
â”‚                                                              â”‚
â”‚ COMMIT;  -- â­ ë½ í•´ì œ                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ë‹¨ê³„: ì¬ê³  ë³µì› (ì£¼ë¬¸ ì·¨ì†Œ ì‹œ)                              â”‚
â”‚                                                              â”‚
â”‚ cancelOrder(orderId)                                         â”‚
â”‚  â†“ selects                                                   â”‚
â”‚ order_items ì¡°íšŒ â†’ variant_id, quantity í™•ì¸                 â”‚
â”‚  â†“ calls                                                     â”‚
â”‚ updateVariantInventory(variantId, +3)  -- 3ê°œ ë³µì›          â”‚
â”‚                                                              â”‚
â”‚ DB ì‘ì—… (ë™ì¼ í”„ë¡œì„¸ìŠ¤):                                      â”‚
â”‚ BEGIN;                                                       â”‚
â”‚ SELECT ... FOR UPDATE;  -- ë½ íšë“                           â”‚
â”‚ UPDATE product_variants SET inventory = inventory + 3;       â”‚
â”‚ -- ê²°ê³¼: 47 â†’ 50                                             â”‚
â”‚ COMMIT;                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ì£¼ë¬¸ ìˆ˜ëŸ‰ ë³€ê²½ ì‹œ ì¬ê³  ì²˜ë¦¬ (2025-10-07 ì—…ë°ì´íŠ¸)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì‹œì‘: ì£¼ë¬¸ ë‚´ì—­ í˜ì´ì§€ - ìˆ˜ëŸ‰ ì¡°ì • ë²„íŠ¼ í´ë¦­                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ë‹¨ê³„: í˜„ì¬ ìˆ˜ëŸ‰ ë° variant_id ì¡°íšŒ                          â”‚
â”‚                                                              â”‚
â”‚ SELECT quantity, variant_id                                  â”‚
â”‚ FROM order_items                                             â”‚
â”‚ WHERE id = itemId;                                           â”‚
â”‚                                                              â”‚
â”‚ ì¶œë ¥:                                                        â”‚
â”‚  â”œâ”€â”€ currentQuantity: 2                                      â”‚
â”‚  â””â”€â”€ variantId: UUID (ìˆì„ ìˆ˜ë„ ì—†ì„ ìˆ˜ë„)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ë‹¨ê³„: Variant ì¬ê³  ê²€ì¦ (variantIdê°€ ìˆëŠ” ê²½ìš°ë§Œ)           â”‚
â”‚                                                              â”‚
â”‚ IF (variantId) THEN                                          â”‚
â”‚   SELECT inventory FROM product_variants                     â”‚
â”‚   WHERE id = variantId;                                      â”‚
â”‚                                                              â”‚
â”‚   quantityDifference = newQuantity - currentQuantity         â”‚
â”‚   -- ì˜ˆ: 5 - 2 = 3 (3ê°œ ë” í•„ìš”)                             â”‚
â”‚                                                              â”‚
â”‚   IF (quantityDifference > 0) THEN  -- ìˆ˜ëŸ‰ ì¦ê°€            â”‚
â”‚     IF (inventory < quantityDifference) THEN                 â”‚
â”‚       RETURN ERROR 'ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤';                      â”‚
â”‚     END IF;                                                  â”‚
â”‚   END IF;                                                    â”‚
â”‚ END IF;                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ë‹¨ê³„: ì¬ê³  ì—…ë°ì´íŠ¸ (variantIdê°€ ìˆëŠ” ê²½ìš°ë§Œ)               â”‚
â”‚                                                              â”‚
â”‚ updateVariantInventory(variantId, -quantityDifference)       â”‚
â”‚                                                              â”‚
â”‚ ê²½ìš° 1: ìˆ˜ëŸ‰ ì¦ê°€ (2 â†’ 5)                                    â”‚
â”‚  â””â”€â”€ quantityDifference = 3                                  â”‚
â”‚  â””â”€â”€ inventory -= 3 (ì¬ê³  ì°¨ê°)                              â”‚
â”‚                                                              â”‚
â”‚ ê²½ìš° 2: ìˆ˜ëŸ‰ ê°ì†Œ (2 â†’ 1)                                    â”‚
â”‚  â””â”€â”€ quantityDifference = -1                                 â”‚
â”‚  â””â”€â”€ inventory -= (-1) = inventory + 1 (ì¬ê³  ë³µêµ¬)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ë‹¨ê³„: order_items ì—…ë°ì´íŠ¸                                  â”‚
â”‚                                                              â”‚
â”‚ UPDATE order_items                                           â”‚
â”‚ SET quantity = newQuantity,                                  â”‚
â”‚     total = price * newQuantity,                             â”‚
â”‚     total_price = price * newQuantity                        â”‚
â”‚ WHERE id = itemId;                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ì—°ê²° ë‹¤ì´ì–´ê·¸ë¨

### 4.1 ì£¼ë¬¸ ì‹œìŠ¤í…œ í…Œì´ë¸” ê´€ê³„

```
profiles (ì‚¬ìš©ì)
    â”œâ”€â”€ id (UUID)
    â”œâ”€â”€ kakao_id (TEXT)  -- ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì‹ë³„
    â””â”€â”€ is_admin (BOOLEAN)
        â†“
        â”‚ (FK: user_id, NULL ê°€ëŠ¥)
        â†“
    orders (ì£¼ë¬¸)
        â”œâ”€â”€ id (UUID)
        â”œâ”€â”€ user_id (UUID, NULL ê°€ëŠ¥)
        â”œâ”€â”€ order_type (VARCHAR) -- 'direct:KAKAO:1234567890'
        â”œâ”€â”€ status (VARCHAR) -- 'pending' â†’ 'paid' â†’ 'delivered'
        â”œâ”€â”€ total_amount (NUMERIC)
        â””â”€â”€ discount_amount (NUMERIC) -- ì¿ í° í• ì¸
            â†“
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                                   â”‚
            â†“                                   â†“
        order_items (ì£¼ë¬¸ ìƒí’ˆ)          order_payments (ê²°ì œ)
            â”œâ”€â”€ id                           â”œâ”€â”€ id
            â”œâ”€â”€ order_id (FK)                â”œâ”€â”€ order_id (FK)
            â”œâ”€â”€ product_id (FK)              â”œâ”€â”€ method
            â”œâ”€â”€ variant_id (FK) â­           â”œâ”€â”€ amount
            â”œâ”€â”€ title (ìŠ¤ëƒ…ìƒ·)                â””â”€â”€ depositor_name
            â”œâ”€â”€ quantity
            â”œâ”€â”€ price, unit_price
            â””â”€â”€ total, total_price
            â†“
            â”‚ (FK: variant_id)
            â†“
        product_variants (ë³€í˜•)          order_shipping (ë°°ì†¡)
            â”œâ”€â”€ id                           â”œâ”€â”€ id
            â”œâ”€â”€ product_id (FK)              â”œâ”€â”€ order_id (FK)
            â”œâ”€â”€ sku                          â”œâ”€â”€ postal_code â­
            â”œâ”€â”€ inventory â­ (ì‹¤ì œ ì¬ê³ )     â”œâ”€â”€ address
            â””â”€â”€ is_active                    â””â”€â”€ tracking_number
                â†“
                â”‚ (FK: product_id)
                â†“
            products (ìƒí’ˆ)
                â”œâ”€â”€ id
                â”œâ”€â”€ title
                â”œâ”€â”€ price
                â”œâ”€â”€ inventory (ì°¸ê³ ìš©)
                â”œâ”€â”€ is_live
                â”œâ”€â”€ is_live_active
                â”œâ”€â”€ category_id (FK)
                â””â”€â”€ supplier_id (FK)
```

### 4.2 Variant ì‹œìŠ¤í…œ í…Œì´ë¸” ê´€ê³„

```
products (ìƒí’ˆ)
    â”œâ”€â”€ id (UUID)
    â”œâ”€â”€ product_number (VARCHAR)
    â””â”€â”€ inventory (NUMERIC) -- ì°¸ê³ ìš© (íŠ¸ë¦¬ê±°ë¡œ ìë™ ì—…ë°ì´íŠ¸)
        â†“
        â”‚ (FK: product_id)
        â†“
    product_options (ì˜µì…˜)
        â”œâ”€â”€ id (UUID)
        â”œâ”€â”€ product_id (FK)
        â”œâ”€â”€ name (TEXT) -- 'ìƒ‰ìƒ', 'ì‚¬ì´ì¦ˆ'
        â””â”€â”€ position (INT)
            â†“
            â”‚ (FK: option_id)
            â†“
        product_option_values (ì˜µì…˜ê°’)
            â”œâ”€â”€ id (UUID)
            â”œâ”€â”€ option_id (FK)
            â”œâ”€â”€ value (TEXT) -- 'ë¸”ë™', 'M'
            â””â”€â”€ position (INT)
                â†“
                â”‚ (ë§¤í•‘)
                â†“
            variant_option_values (ë§¤í•‘ í…Œì´ë¸”)
                â”œâ”€â”€ variant_id (FK)
                â””â”€â”€ option_value_id (FK)
                    â†“
                    â”‚ (FK: variant_id)
                    â†“
                product_variants (ë³€í˜• ìƒí’ˆ)
                    â”œâ”€â”€ id (UUID)
                    â”œâ”€â”€ product_id (FK)
                    â”œâ”€â”€ sku (VARCHAR) -- '0005-ë¸”ë™-M'
                    â”œâ”€â”€ inventory (INT) â­ ì‹¤ì œ ì¬ê³ 
                    â”œâ”€â”€ price_adjustment (NUMERIC)
                    â””â”€â”€ is_active (BOOLEAN)
```

---

## 5. í•¨ìˆ˜ ì²´ì¸ (Function Call Chain)

### 5.1 ì£¼ë¬¸ ìƒì„± í•¨ìˆ˜ ì²´ì¸

```javascript
// í”„ë¡ íŠ¸ì—”ë“œ (BuyBottomSheet)
handleBuyNow()
  â†“ calls
  getProductVariants(productId)
    â†“ returns
    [ { id, sku, inventory, options: {...} }, ... ]
  â†“ calls
  findVariant(selectedOptions)
    â†“ returns
    { variantId, inventory, sku }
  â†“ calls
  checkVariantInventory(variantId, quantity)
    â†“ returns
    { available: true/false, inventory: number }
  â†“ if (available)
  sessionStorage.setItem('checkoutItem', { variantId, quantity, ... })
  â†“
  router.push('/checkout')

// í”„ë¡ íŠ¸ì—”ë“œ (ì²´í¬ì•„ì›ƒ í˜ì´ì§€)
useEffect(() => {
  loadCheckoutData()
    â†“ parallel
    â”œâ”€â”€ UserProfileManager.getCurrentUser()
    â”œâ”€â”€ loadUserCouponsOptimized()
    â””â”€â”€ formatShippingInfo(baseShipping, postalCode)
})

handleCheckout()
  â†“ calls
  createOrder(orderData, userProfile, depositName)
    â†“ DB (íŠ¸ëœì­ì…˜)
    â”œâ”€â”€ BEGIN
    â”œâ”€â”€ product_variants FOR UPDATE (ì¬ê³  ì ê¸ˆ)
    â”œâ”€â”€ orders INSERT
    â”œâ”€â”€ order_items INSERT (variant_id, title, price ë“±)
    â”œâ”€â”€ order_shipping INSERT (postal_code í•„ìˆ˜)
    â”œâ”€â”€ order_payments INSERT (depositor_name)
    â”œâ”€â”€ product_variants UPDATE (ì¬ê³  ì°¨ê°)
    â””â”€â”€ COMMIT
  â†“ if (couponId)
  applyCouponUsage(userId, couponId, orderId, discountAmount)
    â†“ calls DB function
    use_coupon(p_user_id, p_coupon_id, p_order_id, p_discount_amount)
      â†“ updates
      user_coupons (is_used=true, used_at, order_id)
      â†“ trigger
      coupons.total_used_count++
  â†“
  router.push(`/orders/${orderId}/complete`)
```

### 5.2 ìƒí’ˆ ë“±ë¡ í•¨ìˆ˜ ì²´ì¸ (ì˜µì…˜ ìˆëŠ” ê²½ìš°)

```javascript
// í”„ë¡ íŠ¸ì—”ë“œ (ê´€ë¦¬ì ìƒí’ˆ ë“±ë¡)
handleSubmit()
  â†“ calls
  createProductWithOptions(productData, optionsData)
    â†“ DB (íŠ¸ëœì­ì…˜)
    â”œâ”€â”€ BEGIN
    â”œâ”€â”€ products INSERT â†’ productId
    â”œâ”€â”€ product_options INSERT (ì—¬ëŸ¬ ê°œ) â†’ optionIds[]
    â”œâ”€â”€ product_option_values INSERT (ê° ì˜µì…˜ì˜ ê°’ë“¤) â†’ optionValueIds[]
    â”œâ”€â”€ generateVariantCombinations(optionsData)
    â”‚     â†“ ë°ì¹´ë¥´íŠ¸ ê³± ì•Œê³ ë¦¬ì¦˜
    â”‚     [ [ë¸”ë™, S], [ë¸”ë™, M], [ë¸”ë™, L], ... ]
    â”œâ”€â”€ product_variants INSERT (ê° ì¡°í•©ë§ˆë‹¤)
    â”‚     â”œâ”€â”€ { sku: '0005-ë¸”ë™-S', inventory: 10 }
    â”‚     â”œâ”€â”€ { sku: '0005-ë¸”ë™-M', inventory: 10 }
    â”‚     â””â”€â”€ ... (9ê°œ)
    â”œâ”€â”€ variant_option_values INSERT (ë§¤í•‘, 18ê°œ)
    â”‚     â”œâ”€â”€ { variant_id: v1, option_value_id: ë¸”ë™ }
    â”‚     â”œâ”€â”€ { variant_id: v1, option_value_id: S }
    â”‚     â””â”€â”€ ... (ì´ 18ê°œ = 9 variants x 2 ì˜µì…˜)
    â””â”€â”€ COMMIT
  â†“
  router.push(`/admin/products/${productId}`)
```

### 5.3 ì¬ê³  í™•ì¸ ë° ì°¨ê° í•¨ìˆ˜ ì²´ì¸

```javascript
// ì¬ê³  í™•ì¸
checkVariantInventory(productId, selectedOptions)
  â†“ queries DB
  SELECT v.*, v.inventory
  FROM product_variants v
  JOIN variant_option_values vov ON v.id = vov.variant_id
  JOIN product_option_values pov ON vov.option_value_id = pov.id
  WHERE v.product_id = productId
    AND pov.value IN (selectedOptions.values)
    AND v.is_active = true
  GROUP BY v.id
  HAVING COUNT(*) = optionsCount
  â†“ returns
  { available: boolean, inventory: number, variantId: UUID }

// ì¬ê³  ì°¨ê°
updateVariantInventory(variantId, -quantity)
  â†“ DB (íŠ¸ëœì­ì…˜)
  BEGIN;
    â†“ 1. ì¬ê³  ì ê¸ˆ
    SELECT inventory FROM product_variants
    WHERE id = variantId
    FOR UPDATE;  -- â­ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ ëŒ€ê¸°
    â†“ 2. ì¬ê³  ë¶€ì¡± ì²´í¬
    IF (currentInventory < quantity) THEN
      ROLLBACK;
      THROW ERROR 'ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤';
    END IF;
    â†“ 3. ì¬ê³  ì°¨ê°
    UPDATE product_variants
    SET inventory = inventory - quantity
    WHERE id = variantId;
    â†“ 4. íŠ¸ë¦¬ê±° ìë™ ì‹¤í–‰
    -- products.inventory ì¬ê³„ì‚°
  COMMIT;  -- â­ ë½ í•´ì œ
```

---

## ğŸ¯ Claudeìš© ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì£¼ë¬¸ ìƒì„± ì‹œ í•„ìˆ˜ í™•ì¸ ì‚¬í•­

```
âœ… Variant ì¬ê³  í™•ì¸ (checkVariantInventory)
âœ… FOR UPDATE ì ê¸ˆ ì‚¬ìš© (updateVariantInventory)
âœ… order_items ì»¬ëŸ¼:
   â”œâ”€â”€ title (ì£¼ë¬¸ ì‹œì  ìƒí’ˆëª… ìŠ¤ëƒ…ìƒ·)
   â”œâ”€â”€ variant_id (ì¬ê³  ê´€ë¦¬ ì°¸ì¡°)
   â”œâ”€â”€ selected_options (JSONB ìŠ¤ëƒ…ìƒ·)
   â”œâ”€â”€ price, unit_price (ì–‘ìª½ ëª¨ë‘ ì €ì¥)
   â””â”€â”€ total, total_price (ì–‘ìª½ ëª¨ë‘ ì €ì¥)
âœ… orders ì»¬ëŸ¼:
   â”œâ”€â”€ order_type ('direct:KAKAO:1234567890' í˜•ì‹)
   â”œâ”€â”€ discount_amount (ì¿ í° í• ì¸)
   â””â”€â”€ total_amount (ìƒí’ˆ + ë°°ì†¡ë¹„)
âœ… order_shipping.postal_code (ë„ì„œì‚°ê°„ ë°°ì†¡ë¹„ í•„ìˆ˜)
âœ… order_payments.depositor_name (ì…ê¸ˆìëª…)
âœ… ì¿ í° ì‚¬ìš© ì²˜ë¦¬ (applyCouponUsage)
âœ… íŠ¸ëœì­ì…˜ ì‚¬ìš© (ì „ì²´ ì„±ê³µ ë˜ëŠ” ì „ì²´ ë¡¤ë°±)
```

### ì£¼ë¬¸ ê¸ˆì•¡ ê³„ì‚° ì‹œ í•„ìˆ˜ í™•ì¸ ì‚¬í•­ âš ï¸ ì¤‘ìš”!

```
âœ… OrderCalculations ëª¨ë“ˆ ì‚¬ìš© (í•„ìˆ˜!)
   â”œâ”€â”€ import OrderCalculations from '@/lib/orderCalculations'
   â””â”€â”€ OrderCalculations.calculateFinalOrderAmount(items, options)

âœ… DB ì €ì¥ê°’ ì§ì ‘ ì‚¬ìš© ê¸ˆì§€!
   âŒ orderData.payment?.amount (ì €ì¥ ì‹œì  ê¸ˆì•¡, ë³€ê²½ ê°€ëŠ¥)
   âŒ orderData.total_amount (ì €ì¥ ì‹œì  ê¸ˆì•¡, ë³€ê²½ ê°€ëŠ¥)
   âœ… OrderCalculationsë¡œ ì¬ê³„ì‚° (í•­ìƒ ì •í™•)

âœ… ê¸ˆì•¡ í‘œì‹œ í˜ì´ì§€:
   â”œâ”€â”€ /orders/[id]/complete (ì£¼ë¬¸ ì™„ë£Œ)
   â”œâ”€â”€ /orders (ì£¼ë¬¸ ë‚´ì—­)
   â”œâ”€â”€ /admin/orders (ê´€ë¦¬ì ì£¼ë¬¸ ëª©ë¡)
   â””â”€â”€ /admin/orders/[id] (ê´€ë¦¬ì ì£¼ë¬¸ ìƒì„¸)

âœ… ê³„ì‚° ìš”ì†Œ:
   â”œâ”€â”€ ìƒí’ˆ ê¸ˆì•¡: SUM(items.total_price)
   â”œâ”€â”€ ì¿ í° í• ì¸: orderData.discount_amount
   â”œâ”€â”€ ë°°ì†¡ë¹„: formatShippingInfo(baseShipping, postalCode).totalShipping
   â””â”€â”€ ìµœì¢… ê¸ˆì•¡: ìƒí’ˆ - ì¿ í° + ë°°ì†¡ë¹„

âš ï¸ 2025-10-08 ë²„ê·¸ ìˆ˜ì • ì‚¬ë¡€:
   - ë¬¸ì œ: ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€ì—ì„œ DB ì €ì¥ê°’(payment.amount) ì§ì ‘ í‘œì‹œ
   - ì¦ìƒ: ì´ ê²°ì œê¸ˆì•¡ â‚©373,000 (ì‹¤ì œ: â‚©1,485,000)
   - í•´ê²°: OrderCalculations.calculateFinalOrderAmount() ì‚¬ìš©
   - ì˜í–¥: /app/orders/[id]/complete/page.js:788-840
```

### ì˜µì…˜ ìƒí’ˆ ë“±ë¡ ì‹œ í•„ìˆ˜ í™•ì¸ ì‚¬í•­

```
âœ… product_options ìƒì„± (name, position)
âœ… product_option_values ìƒì„± (value, position)
âœ… ì˜µì…˜ ì¡°í•© ìë™ ìƒì„± (ë°ì¹´ë¥´íŠ¸ ê³±)
âœ… product_variants ìƒì„± (ê° ì¡°í•©ë§ˆë‹¤)
   â”œâ”€â”€ sku ìë™ ìƒì„± ('ì œí’ˆë²ˆí˜¸-ì˜µì…˜ê°’1-ì˜µì…˜ê°’2')
   â”œâ”€â”€ inventory ì´ˆê¸°ê°’ ì„¤ì •
   â””â”€â”€ is_active = true
âœ… variant_option_values ë§¤í•‘ (ê° variantë§ˆë‹¤ ì˜µì…˜ê°’ ê°œìˆ˜ë§Œí¼)
âœ… íŠ¸ëœì­ì…˜ ì‚¬ìš©
âœ… ì¡°í•© ìˆ˜ ê²€ì¦ (ë„ˆë¬´ ë§ìœ¼ë©´ ê²½ê³ )
```

### Variant ì¬ê³  ê´€ë¦¬ ì‹œ í•„ìˆ˜ í™•ì¸ ì‚¬í•­

```
âœ… FOR UPDATE ì ê¸ˆ ì‚¬ìš© (ë™ì‹œì„± ì œì–´)
âœ… ì¬ê³  ë¶€ì¡± ì²´í¬ (currentInventory >= quantity)
âœ… ìŒìˆ˜ ì¬ê³  ë°©ì§€
âœ… ì¬ê³  ì°¨ê° ë¡œì§:
   â”œâ”€â”€ ì£¼ë¬¸ ìƒì„±: updateVariantInventory(variantId, -quantity)
   â”œâ”€â”€ ì£¼ë¬¸ ì·¨ì†Œ: updateVariantInventory(variantId, +quantity)
   â””â”€â”€ ìˆ˜ëŸ‰ ë³€ê²½: updateVariantInventory(variantId, -quantityDifference)
âœ… íŠ¸ë¦¬ê±° ìë™ ì‹¤í–‰ (products.inventory ì¬ê³„ì‚°)
âœ… ì—ëŸ¬ ì²˜ë¦¬ ë° ì‚¬ìš©ì ì•Œë¦¼
```

---

## ğŸ“ ìµœê·¼ ìˆ˜ì • ì´ë ¥

### 2025-10-08 (ì˜¤í›„ - ìµœì‹ )
- **ì£¼ë¬¸ ë‚´ì—­ í˜ì´ì§€ ê¸ˆì•¡ í‘œì‹œ ë²„ê·¸ ìˆ˜ì •** â­
  - ë¬¸ì œ: ì£¼ë¬¸ ì¹´ë“œì— ìƒí’ˆ ê¸ˆì•¡ë§Œ í‘œì‹œ (ë°°ì†¡ë¹„ ì œì™¸)
  - ì¦ìƒ: â‚©1,476,000 í‘œì‹œ (ì‹¤ì œ ì…ê¸ˆ í•„ìš”: â‚©1,485,000)
  - í•´ê²°: `OrderCalculations + formatShippingInfo` ì‚¬ìš©
  - ì˜í–¥:
    - `/app/orders/page.js:600-610, 719` (ì£¼ë¬¸ ì¹´ë“œ ê¸ˆì•¡ ê³„ì‚°)
    - `/lib/supabaseApi.js:1272` (shipping.postal_code ì¶”ê°€)

- **ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€ ê¸ˆì•¡ ê³„ì‚° ë²„ê·¸ ìˆ˜ì •**
  - ë¬¸ì œ: DB ì €ì¥ê°’(`payment.amount`) ì§ì ‘ í‘œì‹œ â†’ ì˜ëª»ëœ ê¸ˆì•¡ í‘œì‹œ
  - í•´ê²°: `OrderCalculations.calculateFinalOrderAmount()` ì‚¬ìš©
  - ì˜í–¥: `/app/orders/[id]/complete/page.js:788-840`
  - ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¶”ê°€: "ì£¼ë¬¸ ê¸ˆì•¡ ê³„ì‚° ì‹œ í•„ìˆ˜ í™•ì¸ ì‚¬í•­" ì„¹ì…˜

### 2025-10-08 (ì˜¤ì „)
- ë¬¸ì„œ ìƒì„±
  - ì£¼ë¬¸ ìƒì„± ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±
  - ìƒí’ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±
  - Variant ì¬ê³  ì‹œìŠ¤í…œ ì „ì²´ ì—°ê²°ì„±
  - ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ì—°ê²° ë‹¤ì´ì–´ê·¸ë¨
  - í•¨ìˆ˜ ì²´ì¸ (Function Call Chain)

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-10-08 (ì˜¤í›„ - ìµœì‹ )
**ì‘ì„±ì**: Claude (AI Assistant)
**ë²„ì „**: 1.2
