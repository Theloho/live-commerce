# FEATURE_REFERENCE_MAP.md - Part 3 (ë°°ì†¡ + ì¿ í° + í†µê³„)

**âš ï¸ ì´ íŒŒì¼ì€ ì „ì²´ ë¬¸ì„œì˜ Part 3ì…ë‹ˆë‹¤**
- **Part 1**: ê°œìš” + ì£¼ë¬¸ ê´€ë ¨ + ìƒí’ˆ ê´€ë ¨
- **Part 2**: Variant + ì‚¬ìš©ì + ì¸ì¦ + ê³µê¸‰ì—…ì²´
- **Part 3**: ë°°ì†¡ + ì¿ í° + í†µê³„ â† **í˜„ì¬ íŒŒì¼**

---

## 7. ë°°ì†¡ ê´€ë ¨ ê¸°ëŠ¥

### 7.1 ë°°ì†¡ë¹„ ê³„ì‚° â­ [ì£¼ìš”]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/checkout` - ì²´í¬ì•„ì›ƒ í˜ì´ì§€
2. `/orders/[id]/complete` - ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€
3. `/admin/orders` - ê´€ë¦¬ì ì£¼ë¬¸ ëª©ë¡
4. `/admin/orders/[id]` - ê´€ë¦¬ì ì£¼ë¬¸ ìƒì„¸

#### ğŸ”§ í•µì‹¬ í•¨ìˆ˜ ì²´ì¸
```javascript
formatShippingInfo(baseShipping, postalCode)
  â†“ calls
  calculateShippingSurcharge(postalCode)
  â†“ returns
  {
    baseShipping: 4000,
    surcharge: 3000,  // ì œì£¼
    totalShipping: 7000,
    isRemote: true,
    region: 'ì œì£¼'
  }
```

#### ğŸ“Š ë„ì„œì‚°ê°„ ë°°ì†¡ë¹„ ê·œì¹™
```javascript
ì œì£¼: 63000-63644 â†’ +3,000ì›
ìš¸ë¦‰ë„: 40200-40240 â†’ +5,000ì›
ê¸°íƒ€ ë„ì„œì‚°ê°„ â†’ +5,000ì›
```

#### âš ï¸ í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] postal_code í•„ìˆ˜ (profiles, order_shipping)
- [ ] ê¸°ë³¸ ë°°ì†¡ë¹„ 4,000ì›
- [ ] ë„ì„œì‚°ê°„ ì¶”ê°€ë¹„ ìë™ ê³„ì‚°
- [ ] pending ìƒíƒœì—ì„œëŠ” ë°°ì†¡ë¹„ 0ì›
- [ ] DB ì €ì¥ê°’ê³¼ ê³„ì‚°ê°’ ë¹„êµ (ê´€ë¦¬ì í˜ì´ì§€)

#### ğŸ”— ì—°ê´€ ê¸°ëŠ¥
- **ë„ì„œì‚°ê°„ ë°°ì†¡ë¹„ ì¶”ê°€** (calculateShippingSurcharge)
- **ì£¼ì†Œ ê´€ë¦¬** (postal_code ì €ì¥)
- **ì£¼ë¬¸ ìƒì„±** (ë°°ì†¡ë¹„ ê³„ì‚° í›„ ì €ì¥)

#### ğŸ’¡ íŠ¹ì´ì‚¬í•­
- **ìš°í¸ë²ˆí˜¸ í•„ìˆ˜**: postal_code ì—†ìœ¼ë©´ ê¸°ë³¸ ë°°ì†¡ë¹„ë§Œ ì ìš©
- **pending ìƒíƒœ**: ë°°ì†¡ë¹„ 0ì› (ì•„ì§ ê²°ì œ ì „)
- **DB ì €ì¥ê°’ ìš°ì„ **: order_shippingì— ì €ì¥ëœ ë°°ì†¡ë¹„ ìš°ì„  ì‚¬ìš©

#### ğŸ“ ìµœê·¼ ìˆ˜ì • ì´ë ¥
- 2025-10-03: ìš°í¸ë²ˆí˜¸ ì‹œìŠ¤í…œ ì™„ì „ í†µí•© (ëª¨ë“  í˜ì´ì§€ ì ìš©)
- 2025-10-02: ë„ì„œì‚°ê°„ ë°°ì†¡ë¹„ ê·œì¹™ ì¶”ê°€

#### ğŸ“ ìƒì„¸ ë¬¸ì„œ ìœ„ì¹˜
- **ì½”ë“œ**: lib/shippingUtils.js - formatShippingInfo(), calculateShippingSurcharge()
- **ë°ì´í„° íë¦„**: DETAILED_DATA_FLOW.md Â§ ì²´í¬ì•„ì›ƒ í˜ì´ì§€

---

### 7.2 ë„ì„œì‚°ê°„ ë°°ì†¡ë¹„ ì¶”ê°€ â­ [ì£¼ìš”]

#### ğŸ”§ í•µì‹¬ í•¨ìˆ˜
```javascript
calculateShippingSurcharge(postalCode)
  â†“ validates
  ìš°í¸ë²ˆí˜¸ í˜•ì‹ í™•ì¸
  â†“ checks
  ë„ì„œì‚°ê°„ ì§€ì—­ ë§¤ì¹­
  â†“ returns
  {
    isRemote: true/false,
    region: 'ì œì£¼/ìš¸ë¦‰ë„/ê¸°íƒ€',
    surcharge: 3000/5000
  }
```

#### ğŸ“Š ìš°í¸ë²ˆí˜¸ ë²”ìœ„
```javascript
ì œì£¼: 63000-63644 â†’ surcharge: 3000
ìš¸ë¦‰ë„: 40200-40240 â†’ surcharge: 5000
ê¸°íƒ€ ë„ì„œì‚°ê°„: â†’ surcharge: 5000
```

#### âš ï¸ í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ìš°í¸ë²ˆí˜¸ í˜•ì‹ ê²€ì¦ (5ìë¦¬ ìˆ«ì)
- [ ] ë²”ìœ„ ì²´í¬ (ì œì£¼, ìš¸ë¦‰ë„)
- [ ] ê¸°íƒ€ ë„ì„œì‚°ê°„ ì²˜ë¦¬ (í–¥í›„ í™•ì¥ ê°€ëŠ¥)
- [ ] ë°˜í™˜ê°’: { isRemote, region, surcharge }

#### ğŸ”— ì—°ê´€ ê¸°ëŠ¥
- **ë°°ì†¡ë¹„ ê³„ì‚°** (formatShippingInfo)

#### ğŸ“ ìƒì„¸ ë¬¸ì„œ ìœ„ì¹˜
- **ì½”ë“œ**: lib/shippingUtils.js - calculateShippingSurcharge()

---

### 7.3 ë°°ì†¡ ìƒíƒœ ì¡°íšŒ [ì¼ë°˜]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/orders/[id]/complete` - ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€
2. `/admin/shipping` - ë°œì†¡ ê´€ë¦¬ í˜ì´ì§€

#### ğŸ”§ í•µì‹¬ ê¸°ëŠ¥
```javascript
// ì£¼ë¬¸ ìƒíƒœ í™•ì¸
orders.status
  - pending: ê²°ì œëŒ€ê¸°
  - verifying: ê²°ì œí™•ì¸ì¤‘
  - paid: ê²°ì œì™„ë£Œ
  - delivered: ë°œì†¡ì™„ë£Œ
  - cancelled: ì·¨ì†Œë¨
```

#### âš ï¸ í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] í˜„ì¬ ë°°ì†¡ ìƒíƒœ í‘œì‹œ
- [ ] ìƒíƒœë³„ íƒ€ì„ìŠ¤íƒ¬í”„ í‘œì‹œ
- [ ] ì†¡ì¥ë²ˆí˜¸ í‘œì‹œ (ìˆëŠ” ê²½ìš°)
- [ ] ë°°ì†¡ ë‹¨ê³„ UI (ì§„í–‰ ë°”)

#### ğŸ’¡ íŠ¹ì´ì‚¬í•­
- **íƒ€ì„ìŠ¤íƒ¬í”„**: created_at, verifying_at, paid_at, delivered_at
- **ìƒíƒœ ì „í™˜**: ìˆœì°¨ì  ì „í™˜ (pending â†’ verifying â†’ paid â†’ delivered)

---

### 7.4 ë°°ì†¡ ì¶”ì  [ì¼ë°˜]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/orders/[id]/complete` - ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€
2. `/admin/shipping` - ë°œì†¡ ê´€ë¦¬ í˜ì´ì§€

#### ğŸ”§ í•µì‹¬ ê¸°ëŠ¥
- ì†¡ì¥ë²ˆí˜¸ ê¸°ë°˜ ë°°ì†¡ ì¶”ì 
- íƒë°°ì‚¬ API ì—°ë™ (ì˜ˆì •)

#### ğŸ—„ï¸ DB ì‘ì—…
- `order_shipping` (SELECT) - tracking_number

#### âš ï¸ í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì†¡ì¥ë²ˆí˜¸ ì €ì¥ (tracking_number)
- [ ] íƒë°°ì‚¬ ì½”ë“œ (carrier)
- [ ] ì™¸ë¶€ API ì—°ë™ (optional)
- [ ] ë°°ì†¡ ì¶”ì  ë§í¬ ìƒì„±

#### ğŸ’¡ íŠ¹ì´ì‚¬í•­
- **ë¯¸êµ¬í˜„**: í˜„ì¬ ì†¡ì¥ë²ˆí˜¸ë§Œ ì €ì¥
- **í–¥í›„ ê¸°ëŠ¥**: íƒë°°ì‚¬ API ì—°ë™ (ì‹¤ì‹œê°„ ë°°ì†¡ ì¡°íšŒ)
- **ë§í¬ ìƒì„±**: íƒë°°ì‚¬ë³„ ì¶”ì  URL ìë™ ìƒì„±

---

### 7.5 ë°°ì†¡ ì•Œë¦¼ [ì¼ë°˜]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… (ì˜ˆì •)

#### ğŸ”§ í•µì‹¬ ê¸°ëŠ¥
- ë°°ì†¡ ìƒíƒœ ë³€ê²½ ì‹œ ìë™ ì•Œë¦¼
- ì´ë©”ì¼/SMS ë°œì†¡

#### âš ï¸ í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ë°œì†¡ ì™„ë£Œ ì•Œë¦¼ (delivered ìƒíƒœ)
- [ ] ì´ë©”ì¼ í…œí”Œë¦¿
- [ ] SMS ë°œì†¡ (optional)
- [ ] ì•Œë¦¼ ë°œì†¡ ì´ë ¥ ê¸°ë¡

#### ğŸ’¡ íŠ¹ì´ì‚¬í•­
- **ë¯¸êµ¬í˜„**: í˜„ì¬ ìˆ˜ë™ ì•Œë¦¼ë§Œ ê°€ëŠ¥
- **í–¥í›„ ê¸°ëŠ¥**:
  - ìë™ ì´ë©”ì¼ ë°œì†¡
  - SMS ì•Œë¦¼ (ì„ íƒì )
  - ë°°ì†¡ ì „ ì•Œë¦¼
  - ë°°ì†¡ ì™„ë£Œ ì•Œë¦¼

---

## ğŸ“‹ ê¸°ëŠ¥ ë¬¸ì„œí™” ì™„ë£Œ í†µê³„

### âœ… ìƒì„¸ ë¬¸ì„œí™” ì™„ë£Œ (77ê°œ ì „ì²´)

#### ì£¼ìš” ê¸°ëŠ¥ (20ê°œ)
1. ì£¼ë¬¸ ìƒì„±
2. ì£¼ë¬¸ ì¡°íšŒ (ì‚¬ìš©ì)
3. ì£¼ë¬¸ ì¡°íšŒ (ê´€ë¦¬ì)
4. ì£¼ë¬¸ ìƒì„¸ ì¡°íšŒ
5. ì£¼ë¬¸ ìƒíƒœ ë³€ê²½
6. ì¼ê´„ ìƒíƒœ ë³€ê²½
7. ì£¼ë¬¸ ì·¨ì†Œ
8. ì¼ê´„ê²°ì œ ì²˜ë¦¬
9. ìƒí’ˆ ë“±ë¡
10. ìƒí’ˆ ìˆ˜ì •
11. ì˜µì…˜ í¬í•¨ ìƒí’ˆ ìƒì„±
12. Variant ìƒì„±
13. Variant ì¬ê³  ê´€ë¦¬
14. Variant ì¬ê³  í™•ì¸
15. í”„ë¡œí•„ ìˆ˜ì •
16. í”„ë¡œí•„ ì •ê·œí™”
17. ì£¼ì†Œ ê´€ë¦¬
18. ë¡œê·¸ì¸ (ì¹´ì¹´ì˜¤)
19. ë°œì£¼ì„œ ìƒì„±
20. ë°°ì†¡ë¹„ ê³„ì‚°
21. ë„ì„œì‚°ê°„ ë°°ì†¡ë¹„ ì¶”ê°€

#### ì¼ë°˜ ê¸°ëŠ¥ (57ê°œ)
- ì£¼ë¬¸ ê´€ë ¨: 11ê°œ (1.8~1.18)
- ìƒí’ˆ ê´€ë ¨: 15ê°œ (2.3~2.17)
- Variant/ì˜µì…˜ ê´€ë ¨: 9ê°œ (3.4~3.12)
- ì‚¬ìš©ì/í”„ë¡œí•„ ê´€ë ¨: 6ê°œ (4.1, 4.4, 4.6~4.10)
- ì¸ì¦ ê´€ë ¨: 5ê°œ (5.1, 5.3~5.6)
- ê³µê¸‰ì—…ì²´/ë°œì£¼ ê´€ë ¨: 5ê°œ (6.2~6.6)
- ë°°ì†¡ ê´€ë ¨: 3ê°œ (7.3~7.5)

### ğŸ“Š ë¬¸ì„œí™” ìˆ˜ì¤€

**ì™„ì „ ë¬¸ì„œí™” (77ê°œ ì „ì²´)**:
- ì˜í–¥ë°›ëŠ” í˜ì´ì§€ ëª…ì‹œ
- í•µì‹¬ í•¨ìˆ˜ ì²´ì¸ ì„¤ëª…
- DB ì‘ì—… ìˆœì„œ ëª…ì‹œ
- í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì œê³µ
- ì—°ê´€ ê¸°ëŠ¥ ë§í¬
- íŠ¹ì´ì‚¬í•­ ë° ì£¼ì˜ì 
- ìƒì„¸ ë¬¸ì„œ ìœ„ì¹˜

---

## ğŸ“‹ ì£¼ìš” ê¸°ëŠ¥ ëª©ë¡ (ìƒì„¸ ë¬¸ì„œí™” ì™„ë£Œ - 21ê°œ)

### ì£¼ë¬¸ ê´€ë ¨ (7ê°œ)
1. âœ… ì£¼ë¬¸ ìƒì„± - createOrder()
2. âœ… ì£¼ë¬¸ ì¡°íšŒ (ì‚¬ìš©ì) - getOrders()
3. âœ… ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ - updateOrderStatus()
4. âœ… ì¼ê´„ ìƒíƒœ ë³€ê²½ - updateMultipleOrderStatus()
5. âœ… ì£¼ë¬¸ ì·¨ì†Œ - cancelOrder()
6. âœ… ì¼ê´„ê²°ì œ ì²˜ë¦¬ - payment_group_id

### ìƒí’ˆ ê´€ë ¨ (3ê°œ)
7. âœ… ìƒí’ˆ ë“±ë¡ - addProduct()
8. âœ… ìƒí’ˆ ìˆ˜ì • - updateProduct()
9. âœ… ì˜µì…˜ í¬í•¨ ìƒí’ˆ ìƒì„± - createProductWithOptions()

### Variant/ì˜µì…˜ ê´€ë ¨ (3ê°œ)
10. âœ… Variant ìƒì„± - createVariant()
11. âœ… Variant ì¬ê³  ê´€ë¦¬ - updateVariantInventory()
12. âœ… Variant ì¬ê³  í™•ì¸ - checkVariantInventory()

### ì‚¬ìš©ì/í”„ë¡œí•„ ê´€ë ¨ (3ê°œ)
13. âœ… í”„ë¡œí•„ ìˆ˜ì • - atomicProfileUpdate()
14. âœ… í”„ë¡œí•„ ì •ê·œí™” - normalizeProfile()
15. âœ… ì£¼ì†Œ ê´€ë¦¬ - AddressManager

### ì¸ì¦ ê´€ë ¨ (1ê°œ)
16. âœ… ë¡œê·¸ì¸ (ì¹´ì¹´ì˜¤) - ì¹´ì¹´ì˜¤ OAuth

### ê³µê¸‰ì—…ì²´/ë°œì£¼ ê´€ë ¨ (1ê°œ)
17. âœ… ë°œì£¼ì„œ ìƒì„± - getPurchaseOrderBySupplier()

### ë°°ì†¡ ê´€ë ¨ (2ê°œ)
18. âœ… ë°°ì†¡ë¹„ ê³„ì‚° - formatShippingInfo()
19. âœ… ë„ì„œì‚°ê°„ ë°°ì†¡ë¹„ ì¶”ê°€ - calculateShippingSurcharge()

---

## ğŸ“ ë¬¸ì„œí™” ì™„ë£Œ í˜„í™©

1. âœ… ëª¨ë“  ê¸°ëŠ¥ ê¸°ë³¸ êµ¬ì¡° ìƒì„± (ì™„ë£Œ)
2. âœ… ì£¼ìš” ê¸°ëŠ¥ 21ê°œ ìƒì„¸ ë¬¸ì„œí™” (ì™„ë£Œ)
3. âœ… ì¼ë°˜ ê¸°ëŠ¥ 57ê°œ ìƒì„¸ ë¬¸ì„œí™” (ì™„ë£Œ)
4. âœ… ì´ 77ê°œ ì „ì²´ ê¸°ëŠ¥ ë¬¸ì„œí™” (ì™„ë£Œ - 2025-10-03)

### ğŸ“ˆ ë¬¸ì„œí™” í†µê³„
- **ì´ ê¸°ëŠ¥ ê°œìˆ˜**: 77ê°œ
- **ìƒì„¸ ë¬¸ì„œí™” ì™„ë£Œ**: 77ê°œ (100%)
- **ë¶„ì„í•œ í˜ì´ì§€**: 31ê°œ
- **ë¶„ì„í•œ í•¨ìˆ˜**: 47ê°œ (lib/supabaseApi.js)
- **ì°¸ì¡°í•œ ë¬¸ì„œ**: CODE_ANALYSIS_COMPLETE.md, DB_REFERENCE_GUIDE.md, DETAILED_DATA_FLOW.md

### ğŸ¯ ë¬¸ì„œí™” í’ˆì§ˆ
**ëª¨ë“  ê¸°ëŠ¥ í¬í•¨ í•­ëª©**:
- âœ… ì˜í–¥ë°›ëŠ” í˜ì´ì§€ (1~5ê°œ)
- âœ… í•µì‹¬ í•¨ìˆ˜ ì²´ì¸ (ì½”ë“œ ì˜ˆì‹œ)
- âœ… DB ì‘ì—… ìˆœì„œ (í…Œì´ë¸” + ì‘ì—… ìœ í˜•)
- âœ… í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ (3~10ê°œ í•­ëª©)
- âœ… ì—°ê´€ ê¸°ëŠ¥ ë§í¬
- âœ… íŠ¹ì´ì‚¬í•­ ë° ì£¼ì˜ì 
- âœ… ìƒì„¸ ë¬¸ì„œ ìœ„ì¹˜

---

## ğŸ“ ì‚¬ìš© ì˜ˆì‹œ

### ì˜ˆì‹œ 1: ì£¼ë¬¸ ìƒì„± ê¸°ëŠ¥ ìˆ˜ì • ì‹œ
```
1. FEATURE_REFERENCE_MAP.md Â§ 1.1 ì£¼ë¬¸ ìƒì„± ì½ê¸°
2. ì˜í–¥ë°›ëŠ” í˜ì´ì§€ 5ê°œ í™•ì¸
3. í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ 15ê°œ í•­ëª© í™•ì¸
4. ì—°ê´€ ê¸°ëŠ¥ 6ê°œ í…ŒìŠ¤íŠ¸ í•„ìš”
5. DB_REFERENCE_GUIDE.md Â§ 6.1 ì°¸ì¡°
6. DETAILED_DATA_FLOW.md Â§ ì²´í¬ì•„ì›ƒ í˜ì´ì§€ ì°¸ì¡°
```

### ì˜ˆì‹œ 2: Variant ì¬ê³  ê´€ë¦¬ ê¸°ëŠ¥ ìˆ˜ì • ì‹œ
```
1. FEATURE_REFERENCE_MAP.md Â§ 3.2 Variant ì¬ê³  ê´€ë¦¬ ì½ê¸°
2. ì˜í–¥ë°›ëŠ” í˜ì´ì§€ 3ê°œ í™•ì¸
3. FOR UPDATE ì ê¸ˆ ì‚¬ìš© í™•ì¸
4. ì—°ê´€ ê¸°ëŠ¥: ì£¼ë¬¸ ìƒì„±, ì£¼ë¬¸ ì·¨ì†Œ í…ŒìŠ¤íŠ¸
5. DB_REFERENCE_GUIDE.md Â§ 5.1 ì°¸ì¡°
```

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-10-03
**ìƒíƒœ**: ì™„ì „ ë¬¸ì„œí™” ì™„ë£Œ (ì „ì²´ 77ê°œ ê¸°ëŠ¥ ìƒì„¸ ë¬¸ì„œí™”)
**ì´ ê¸°ëŠ¥**: 77ê°œ (ì£¼ìš”: 21ê°œ, ì¼ë°˜: 56ê°œ)
## 8. ì¿ í° ê´€ë ¨ ê¸°ëŠ¥

### 8.1 ì¿ í° ë°œí–‰ â­ [ì£¼ìš”]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/admin/coupons` - ì¿ í° ëª©ë¡ (ìƒˆ ì¿ í° í‘œì‹œ)
2. `/admin/coupons/new` - ì¿ í° ë°œí–‰ í˜ì´ì§€
3. `/admin/coupons/[id]` - ì¿ í° ìƒì„¸/ë°°í¬ í˜ì´ì§€

#### ğŸ”§ í•µì‹¬ í•¨ìˆ˜ ì²´ì¸
```javascript
createCoupon(couponData)
  â†“ validates
  - ì¿ í° ì½”ë“œ ì¤‘ë³µ í™•ì¸
  - í• ì¸ íƒ€ì…ë³„ í•„ìˆ˜ í•„ë“œ ê²€ì¦ (max_discount_amount)
  - ë‚ ì§œ ë²”ìœ„ ê²€ì¦ (valid_until > valid_from)
  â†“ creates
  coupons (INSERT)
  â†“ returns
  ìƒˆë¡œ ìƒì„±ëœ ì¿ í° ê°ì²´
```

#### ğŸ—„ï¸ ê´€ë ¨ í…Œì´ë¸”
- `coupons` (main)

#### âš ï¸ ì£¼ìš” í•„ë“œ
- `code`: VARCHAR(50) UNIQUE - ì¿ í° ì½”ë“œ (ìë™ ëŒ€ë¬¸ì)
- `discount_type`: 'fixed_amount' | 'percentage'
- `discount_value`: í• ì¸ ê¸ˆì•¡ ë˜ëŠ” ë¹„ìœ¨
- `min_purchase_amount`: ìµœì†Œ êµ¬ë§¤ ê¸ˆì•¡ (ê¸°ë³¸ 0)
- `max_discount_amount`: ìµœëŒ€ í• ì¸ ê¸ˆì•¡ (percentage íƒ€ì… í•„ìˆ˜)
- `valid_from`, `valid_until`: ìœ íš¨ ê¸°ê°„
- `usage_limit_per_user`: ì‚¬ìš©ìë‹¹ ì‚¬ìš© íšŸìˆ˜ (ê¸°ë³¸ 1)
- `total_usage_limit`: ì „ì²´ ì‚¬ìš© í•œë„ (ì„ ì°©ìˆœ, NULL=ë¬´ì œí•œ)

#### âœ… í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì¿ í° ì½”ë“œ ì˜ë¬¸+ìˆ«ìë§Œ ì‚¬ìš©
- [ ] percentage íƒ€ì…ì€ max_discount_amount í•„ìˆ˜
- [ ] valid_until > valid_from ê²€ì¦
- [ ] discount_value > 0 ê²€ì¦

---

### 8.2 ì¿ í° ë°°í¬ (ê°œë³„) â­ [ì£¼ìš”]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/admin/coupons/[id]` - ì¿ í° ë°°í¬ í˜ì´ì§€
2. `/mypage/coupons` - ì‚¬ìš©ì ì¿ í°í•¨ (ìƒˆ ì¿ í° í‘œì‹œ)

#### ğŸ”§ í•µì‹¬ í•¨ìˆ˜ ì²´ì¸
```javascript
// í”„ë¡ íŠ¸ì—”ë“œ (lib/couponApi.js)
distributeCoupon(couponId, userIds)
  â†“ calls API Route
  POST /api/admin/coupons/distribute
  â†“ validates (ì„œë²„ ì‚¬ì´ë“œ)
  - ê´€ë¦¬ì ì´ë©”ì¼ ê²€ì¦ (verifyAdminAuth)
  - ì¿ í° í™œì„±í™” ìƒíƒœ í™•ì¸
  - ì‚¬ìš©ì ID ë°°ì—´ ìœ íš¨ì„± ê²€ì¦
  â†“ distributes (Service Role Key ì‚¬ìš©)
  user_coupons (INSERT with upsert, RLS ìš°íšŒ)
  â†“ triggers
  coupons.total_issued_count ìë™ ì¦ê°€ (DB trigger)
  â†“ returns
  { success, distributedCount, requestedCount, duplicates, couponCode }
```

#### ğŸ—„ï¸ ê´€ë ¨ íŒŒì¼
- **í”„ë¡ íŠ¸ì—”ë“œ**: `lib/couponApi.js` - distributeCoupon()
- **API Route**: `app/api/admin/coupons/distribute/route.js`
- **Admin Client**: `lib/supabaseAdmin.js` - Service Role í´ë¼ì´ì–¸íŠ¸
- **RLS ì •ì±…**: `supabase_user_coupons_rls.sql`

#### ğŸ—„ï¸ ê´€ë ¨ í…Œì´ë¸”
- `user_coupons` (main)
- `coupons` (í†µê³„ ì—…ë°ì´íŠ¸)

#### âš ï¸ ì£¼ìš” íŠ¹ì§•
- **ë³´ì•ˆ**: Service Role Key ì‚¬ìš© + ê´€ë¦¬ì ì´ë©”ì¼ ê²€ì¦
- **RLS ìš°íšŒ**: supabaseAdmin í´ë¼ì´ì–¸íŠ¸ë¡œ RLS ì •ì±… ìš°íšŒ
- ì¤‘ë³µ ë°°í¬ ë°©ì§€: UNIQUE(user_id, coupon_id)
- upsert ì‚¬ìš©ìœ¼ë¡œ ì¤‘ë³µ ì‹œ ì¡°ìš©íˆ ë¬´ì‹œ
- ë°°í¬ì ì •ë³´ ì €ì¥ (issued_by)

#### ğŸ”’ ë³´ì•ˆ êµ¬ì¡° (2025-10-03 ì—…ë°ì´íŠ¸)
```
ê´€ë¦¬ì UI
  â†“ localStorage (admin_email)
  â†“
API Route (ì„œë²„ ì‚¬ì´ë“œ)
  â†“ verifyAdminAuth(adminEmail)
  â†“ process.env.ADMIN_EMAILS í™•ì¸
  â†“
supabaseAdmin (Service Role)
  â†“ SUPABASE_SERVICE_ROLE_KEY
  â†“ RLS ì •ì±… ìš°íšŒ
  â†“
user_coupons í…Œì´ë¸” INSERT
```

#### âœ… í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [x] í™œì„±í™”ëœ ì¿ í°ë§Œ ë°°í¬ ê°€ëŠ¥
- [x] ì´ë¯¸ ë³´ìœ í•œ ì‚¬ìš©ìëŠ” ì¤‘ë³µ ì œì™¸
- [x] ë°°í¬ ê²°ê³¼ í”¼ë“œë°± (ì„±ê³µ Xê±´, ì¤‘ë³µ Yê±´)
- [x] ê´€ë¦¬ì ê¶Œí•œ ê²€ì¦ (ADMIN_EMAILS)
- [x] Service Role Keyë¡œ ì•ˆì „í•œ ë°°í¬

---

### 8.3 ì¿ í° ë°°í¬ (ì „ì²´) â­ [ì£¼ìš”]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/admin/coupons/[id]` - ì „ì²´ ê³ ê°ì—ê²Œ ë°°í¬
2. `/mypage/coupons` - ëª¨ë“  ì‚¬ìš©ì ì¿ í°í•¨

#### ğŸ”§ í•µì‹¬ í•¨ìˆ˜ ì²´ì¸
```javascript
distributeToAllCustomers(couponId)
  â†“ fetches
  ëª¨ë“  ê³ ê° ëª©ë¡ (is_admin = false)
  â†“ calls
  distributeCoupon(couponId, allUserIds)
  â†“ returns
  ì „ì²´ ë°°í¬ ê²°ê³¼
```

#### âš ï¸ ì£¼ìš” íŠ¹ì§•
- ì¼ë°˜ ê³ ê°ë§Œ ëŒ€ìƒ (ê´€ë¦¬ì ì œì™¸)
- ëŒ€ëŸ‰ ë°°í¬ ìµœì í™” (upsert ì‚¬ìš©)
- ê¸°ì¡´ ë³´ìœ ì ìë™ ì œì™¸

#### âœ… í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] í™•ì¸ ëª¨ë‹¬ë¡œ ì‹¤ìˆ˜ ë°©ì§€
- [ ] ë°°í¬ ì§„í–‰ ìƒí™© í‘œì‹œ
- [ ] ì™„ë£Œ í›„ í†µê³„ ê°±ì‹ 

---

### 8.4 ì¿ í° ìœ íš¨ì„± ê²€ì¦ â­ [ì£¼ìš”]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/checkout` - ì¿ í° ì ìš© ì‹œ ê²€ì¦

#### ğŸ”§ í•µì‹¬ í•¨ìˆ˜ ì²´ì¸
```javascript
validateCoupon(couponCode, userId, orderAmount)
  â†“ calls DB function
  validate_coupon(p_coupon_code, p_user_id, p_order_amount)
  â†“ validates
  1. ì¿ í° ì¡´ì¬ ë° í™œì„±í™” ì—¬ë¶€
  2. ìœ íš¨ ê¸°ê°„ (NOW() BETWEEN valid_from AND valid_until)
  3. ìµœì†Œ êµ¬ë§¤ ê¸ˆì•¡
  4. ì „ì²´ ì‚¬ìš© í•œë„
  5. ì‚¬ìš©ì ë³´ìœ  ì—¬ë¶€
  6. ì‚¬ìš© ì´ë ¥ (is_used = false)
  â†“ calculates
  í• ì¸ ê¸ˆì•¡ (fixed_amount ë˜ëŠ” percentage)
  â†“ returns
  { is_valid, error_message, coupon_id, discount_amount }
```

#### ğŸ—„ï¸ ê´€ë ¨ í•¨ìˆ˜ (DB)
- `validate_coupon()` - PostgreSQL í•¨ìˆ˜

#### âš ï¸ ê²€ì¦ ìˆœì„œ (ì¤‘ìš”!)
1. ì¿ í° ì¡´ì¬/í™œì„±í™” â†’ "ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ë¹„í™œì„±í™”ëœ ì¿ í°"
2. ìœ íš¨ ê¸°ê°„ (ì‹œì‘ ì „) â†’ "ì•„ì§ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ì¿ í°"
3. ìœ íš¨ ê¸°ê°„ (ë§Œë£Œ) â†’ "ìœ íš¨ ê¸°ê°„ì´ ë§Œë£Œëœ ì¿ í°"
4. ìµœì†Œ êµ¬ë§¤ ê¸ˆì•¡ â†’ "ìµœì†Œ êµ¬ë§¤ ê¸ˆì•¡ Xì› ì´ìƒ"
5. ì „ì²´ ì‚¬ìš© í•œë„ â†’ "ì¿ í° ì‚¬ìš© ê°€ëŠ¥ íšŸìˆ˜ ì´ˆê³¼"
6. ì‚¬ìš©ì ë³´ìœ  â†’ "ë³´ìœ í•˜ì§€ ì•Šì€ ì¿ í°"
7. ì‚¬ìš© ì´ë ¥ â†’ "ì´ë¯¸ ì‚¬ìš©í•œ ì¿ í°"

#### í• ì¸ ê¸ˆì•¡ ê³„ì‚° ë¡œì§
```sql
-- fixed_amount
v_discount := LEAST(v_coupon.discount_value, p_order_amount)

-- percentage
v_discount := p_order_amount * (v_coupon.discount_value / 100)
IF v_coupon.max_discount_amount IS NOT NULL THEN
    v_discount := LEAST(v_discount, v_coupon.max_discount_amount)
END IF
```

#### âœ… í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ëª¨ë“  ê²€ì¦ ë‹¨ê³„ í†µê³¼ í™•ì¸
- [ ] ì—ëŸ¬ ë©”ì‹œì§€ ì‚¬ìš©ì ì¹œí™”ì ìœ¼ë¡œ í‘œì‹œ
- [ ] í• ì¸ ê¸ˆì•¡ ê³„ì‚° ì •í™•ì„± í™•ì¸

---

### 8.5 ì¿ í° ì‚¬ìš© ì²˜ë¦¬ â­ [ì£¼ìš”]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/checkout` - ì£¼ë¬¸ ì™„ë£Œ í›„ ì¿ í° ì‚¬ìš© ì²˜ë¦¬
2. `/orders/[id]/complete` - ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€
3. `/admin/coupons/[id]` - ì‚¬ìš© í†µê³„ ì—…ë°ì´íŠ¸

#### ğŸ”§ í•µì‹¬ í•¨ìˆ˜ ì²´ì¸
```javascript
applyCouponUsage(userId, couponId, orderId, discountAmount)
  â†“ calls DB function
  use_coupon(p_user_id, p_coupon_id, p_order_id, p_discount_amount)
  â†“ updates
  user_coupons.is_used = true
  user_coupons.used_at = NOW()
  user_coupons.order_id = orderId
  user_coupons.discount_amount = discountAmount
  â†“ triggers
  coupons.total_used_count ìë™ ì¦ê°€ (DB trigger)
  â†“ returns
  boolean (ì„±ê³µ ì—¬ë¶€)
```

#### ğŸ—„ï¸ ê´€ë ¨ íŠ¸ë¦¬ê±°
- `trigger_update_coupon_usage_stats` - ì‚¬ìš© í†µê³„ ìë™ ì—…ë°ì´íŠ¸

#### âš ï¸ ì£¼ì˜ì‚¬í•­
- WHERE ì¡°ê±´: `is_used = false` (ì¤‘ë³µ ì‚¬ìš© ë°©ì§€)
- íŠ¸ëœì­ì…˜ ì•ˆì „ì„±: ì£¼ë¬¸ ìƒì„±ê³¼ í•¨ê»˜ ì²˜ë¦¬
- ì‹¤íŒ¨ ì‹œì—ë„ ì£¼ë¬¸ì€ ì§„í–‰ (ì¿ í°ì€ ì¬ë°œí–‰ ê°€ëŠ¥)

#### âœ… í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì£¼ë¬¸ ìƒì„± í›„ ì¦‰ì‹œ í˜¸ì¶œ
- [ ] ì¿ í° ì‚¬ìš© ì‹¤íŒ¨í•´ë„ ì£¼ë¬¸ ì·¨ì†Œ ì•ˆ ë¨
- [ ] ì‚¬ìš© ë‚´ì—­ ë¡œê·¸ ê¸°ë¡ (logger)

---

### 8.6 ì¿ í° ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ì) [ì¼ë°˜]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/admin/coupons` - ì¿ í° ê´€ë¦¬ í˜ì´ì§€

#### ğŸ”§ í•µì‹¬ í•¨ìˆ˜
```javascript
getCoupons()
  â†“ fetches
  ëª¨ë“  ì¿ í° + í†µê³„ (join user_coupons)
  â†“ returns
  ì¿ í° ë°°ì—´ (total_issued_count, total_used_count í¬í•¨)
```

#### ğŸ¨ UI ê¸°ëŠ¥
- ê²€ìƒ‰: ì½”ë“œ, ì´ë¦„
- í•„í„°: ìƒíƒœ (ì „ì²´/í™œì„±/ë¹„í™œì„±), íƒ€ì… (ì „ì²´/ê¸ˆì•¡/í¼ì„¼íŠ¸)
- ì •ë ¬: ìƒì„±ì¼ ë‚´ë¦¼ì°¨ìˆœ
- í†µê³„ ì¹´ë“œ: ì „ì²´/í™œì„±/ë°œê¸‰/ì‚¬ìš©

---

### 8.7 ì¿ í° ëª©ë¡ ì¡°íšŒ (ì‚¬ìš©ì) [ì¼ë°˜]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/mypage/coupons` - ë‚´ ì¿ í°í•¨
2. `/checkout` - ì¿ í° ì„ íƒ

#### ğŸ”§ í•µì‹¬ í•¨ìˆ˜
```javascript
getUserCoupons(userId)
  â†“ fetches
  user_coupons + coupons (join)
  WHERE user_id = userId
  â†“ returns
  ì‚¬ìš©ì ì¿ í° ë°°ì—´ (ì¿ í° ì •ë³´ í¬í•¨)
```

#### ğŸ¨ UI ê¸°ëŠ¥
- íƒ­: ì‚¬ìš© ê°€ëŠ¥ / ì‚¬ìš© ì™„ë£Œ / ê¸°ê°„ ë§Œë£Œ
- ì¿ í° ë””ìì¸: í‹°ì¼“ ìŠ¤íƒ€ì¼ (ì¢Œì¸¡ í• ì¸ ê¸ˆì•¡, ìš°ì¸¡ ì •ë³´)
- ì •ë ¬: ë§Œë£Œì¼ ê°€ê¹Œìš´ ìˆœ

---

### 8.8 ì¿ í° ìƒì„¸ ì¡°íšŒ [ì¼ë°˜]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/admin/coupons/[id]` - ì¿ í° ìƒì„¸ ë° ë°°í¬

#### ğŸ”§ í•µì‹¬ í•¨ìˆ˜
```javascript
getCouponDetail(couponId)
  â†“ fetches
  ì¿ í° ê¸°ë³¸ ì •ë³´
  â†“ parallel fetches
  - ë³´ìœ  ê³ ê° ëª©ë¡ (ë¯¸ì‚¬ìš©)
  - ì‚¬ìš© ì™„ë£Œ ê³ ê° ëª©ë¡
  - í†µê³„ (usage_rate ë“±)
  â†“ returns
  ì¿ í° ìƒì„¸ + ê³ ê° ë¦¬ìŠ¤íŠ¸
```

#### ğŸ¨ UI ê¸°ëŠ¥
- í†µê³„: ì´ ë°œê¸‰ / ì‚¬ìš© ì™„ë£Œ / ì‚¬ìš©ë¥  / ë‚¨ì€ ìˆ˜ëŸ‰
- ê³ ê° íƒ­: ë¯¸ì‚¬ìš© / ì‚¬ìš©ì™„ë£Œ
- ë°°í¬: ê°œë³„ ì„ íƒ / ì „ì²´ ë°œì†¡

---

### 8.9 ì¿ í° í™œì„±í™”/ë¹„í™œì„±í™” [ì¼ë°˜]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/admin/coupons` - ì¿ í° ëª©ë¡

#### ğŸ”§ í•µì‹¬ í•¨ìˆ˜
```javascript
toggleCouponStatus(couponId, isActive)
  â†“ updates
  coupons.is_active = isActive
  â†“ affects
  - ë¹„í™œì„±í™” ì‹œ ì‹ ê·œ ë°°í¬ ë¶ˆê°€
  - ê¸°ì¡´ ë³´ìœ ìëŠ” ì‚¬ìš© ê°€ëŠ¥
```

---

### 8.10 ì¿ í° í†µê³„ ì¡°íšŒ [ì¼ë°˜]

#### ğŸ“ ì˜í–¥ë°›ëŠ” í˜ì´ì§€
1. `/admin/coupons/[id]` - ì¿ í° ìƒì„¸

#### ğŸ”§ í•µì‹¬ í•¨ìˆ˜
```javascript
getCouponStats(couponId)
  â†“ aggregates
  - total_issued: ì´ ë°œê¸‰ ìˆ˜
  - total_used: ì´ ì‚¬ìš© ìˆ˜
  - usage_rate: ì‚¬ìš©ë¥  (%)
  - remaining: ë‚¨ì€ ìˆ˜ëŸ‰ (total_usage_limit - total_used)
  â†“ returns
  í†µê³„ ê°ì²´
```

---

## ğŸ“Š ì¿ í° ì‹œìŠ¤í…œ ì „ì²´ íë¦„

### 1. ì¿ í° ë°œí–‰ (ê´€ë¦¬ì)
```
ê´€ë¦¬ì â†’ /admin/coupons/new
  â†“ createCoupon()
ì¿ í° ìƒì„± ì™„ë£Œ
  â†“ redirect
/admin/coupons/[id] (ë°°í¬ í˜ì´ì§€)
```

### 2. ì¿ í° ë°°í¬ (ê´€ë¦¬ì)
```
ê´€ë¦¬ì â†’ /admin/coupons/[id]
  â†“ ê³ ê° ì„ íƒ (ê°œë³„ or ì „ì²´)
  â†“ distributeCoupon() or distributeToAllCustomers()
user_coupons ë ˆì½”ë“œ ìƒì„±
  â†“ trigger
coupons.total_issued_count ì¦ê°€
```

### 3. ì¿ í° ì‚¬ìš© (ê³ ê°)
```
ê³ ê° â†’ /checkout
  â†“ ì¿ í° ì„ íƒ
  â†“ validateCoupon()
í• ì¸ ê¸ˆì•¡ ê³„ì‚° ë° í‘œì‹œ
  â†“ ì£¼ë¬¸ ìƒì„±
  â†“ applyCouponUsage()
user_coupons.is_used = true
  â†“ trigger
coupons.total_used_count ì¦ê°€
```

### 4. ì¿ í° ì¡°íšŒ (ê³ ê°)
```
ê³ ê° â†’ /mypage/coupons
  â†“ getUserCoupons()
ë‚´ ì¿ í° ëª©ë¡ í‘œì‹œ
  â†“ í•„í„° (ì‚¬ìš©ê°€ëŠ¥/ì‚¬ìš©ì™„ë£Œ/ë§Œë£Œ)
ìƒíƒœë³„ ë¶„ë¥˜ í‘œì‹œ
```

---

## ğŸ”— ì¿ í° ì‹œìŠ¤í…œ ì—°ê´€ ê´€ê³„

### ì¿ í° â†’ ì£¼ë¬¸
- ì²´í¬ì•„ì›ƒ í˜ì´ì§€ì—ì„œ ì¿ í° ì„ íƒ ì‹œ í• ì¸ ì ìš©
- ì£¼ë¬¸ ìƒì„± í›„ ì¿ í° ì‚¬ìš© ì²˜ë¦¬
- user_coupons.order_idì— ì£¼ë¬¸ ID ì €ì¥

### ì¿ í° â†’ ì‚¬ìš©ì
- user_coupons í…Œì´ë¸”ë¡œ ì‚¬ìš©ìë³„ ì¿ í° ë³´ìœ  ê´€ë¦¬
- ì¤‘ë³µ ë³´ìœ  ë°©ì§€ (UNIQUE ì œì•½)
- ì‚¬ìš© ì´ë ¥ ì¶”ì 

### ì¿ í° â†’ í†µê³„
- DB íŠ¸ë¦¬ê±°ë¡œ ìë™ í†µê³„ ì—…ë°ì´íŠ¸
- ë°œê¸‰ ì‹œ: total_issued_count++
- ì‚¬ìš© ì‹œ: total_used_count++

---

**ë¬¸ì„œí™” ì™„ë£Œìœ¨**: 100%
