# ğŸŸï¸ ì²´í¬ì•„ì›ƒ RLS UPDATE ì •ì±… í•´ê²° ì‘ì—… ë¡œê·¸

**ë‚ ì§œ**: 2025-10-04
**ì‘ì—…ì**: Claude Code
**ì‘ì—… ì‹œê°„**: ì•½ 2ì‹œê°„

---

## ğŸ“‹ ë¬¸ì œ ìƒí™©

### 1ï¸âƒ£ ì´ˆê¸° ì¦ìƒ
ì‚¬ìš©ìê°€ ì²´í¬ì•„ì›ƒì—ì„œ:
- âœ… ì œì£¼ ì£¼ì†Œ ì„ íƒ (63625)
- âœ… BEST10 ì¿ í° ì ìš© (â‚©24,600 í• ì¸)
- âœ… ì…ê¸ˆìëª… ì…ë ¥ ("ê¸°ë¬´ì¹œ")
- âœ… ê²°ì œí•˜ê¸° í´ë¦­

**ê²°ê³¼:**
- âŒ ì£¼ë¬¸ ìƒì„¸: ì„œìš¸ ì£¼ì†Œ (05794)
- âŒ ì¿ í° í• ì¸: 0ì› ë˜ëŠ” undefined
- âŒ ì…ê¸ˆìëª…: ë°°ì†¡ìëª…ìœ¼ë¡œ ëŒ€ì²´

### 2ï¸âƒ£ ë””ë²„ê¹… ê³¼ì •

**ë‹¨ê³„ 1: ë°ì´í„° ì „ì†¡ í™•ì¸**
```javascript
// ì²´í¬ì•„ì›ƒì—ì„œ ì „ì†¡í•œ ë°ì´í„° (âœ… ì •ìƒ)
paymentUpdateData = {
  discountAmount: 24600,
  shippingData: {
    shipping_postal_code: '63625'
  },
  depositorName: 'ê¸°ë¬´ì¹œ'
}
```

**ë‹¨ê³„ 2: API ì‘ë‹µ í™•ì¸**
```javascript
// PATCH ìš”ì²­ (âœ… ì„±ê³µ)
response.status: 204
response.ok: true

// í•˜ì§€ë§Œ DB ì¡°íšŒ ì‹œ (âŒ ì €ì¥ ì•ˆ ë¨)
discount_amount: 0
postal_code: '05794'
depositor_name: null
```

**ë‹¨ê³„ 3: ê·¼ë³¸ ì›ì¸ ë°œê²¬**
1. **RLS UPDATE ì •ì±… ëˆ„ë½**
   - orders, order_payments, order_shipping, user_coupons í…Œì´ë¸”
   - PATCHëŠ” ì„±ê³µí•˜ì§€ë§Œ 0 rows updated

2. **ANON KEY ì¸ì¦ ë¬¸ì œ**
   ```javascript
   // ê¸°ì¡´ (âŒ)
   Authorization: `Bearer ${ANON_KEY}`
   // RLS: auth.uid() = null â†’ ê¶Œí•œ ì—†ìŒ

   // ìˆ˜ì • (âœ…)
   const { data: { session } } = await supabase.auth.getSession()
   Authorization: `Bearer ${session.access_token}`
   // RLS: auth.uid() = ì‹¤ì œ ì‚¬ìš©ì ID â†’ ê¶Œí•œ ìˆìŒ
   ```

3. **discount_amount ì»¬ëŸ¼ ëˆ„ë½**
   - DB ìŠ¤í‚¤ë§ˆì— ì¡´ì¬í•˜ì§€ ì•ŠìŒ
   - ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”

---

## ğŸ› ï¸ í•´ê²° ë°©ë²•

### 1ï¸âƒ£ DB ìŠ¤í‚¤ë§ˆ ìˆ˜ì •
**íŒŒì¼**: `supabase/migrations/20251004_add_discount_to_orders.sql`

```sql
-- discount_amount ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE orders
ADD COLUMN discount_amount DECIMAL(12, 2) DEFAULT 0;

-- NOT NULL ì œì•½ì¡°ê±´ ì¶”ê°€
ALTER TABLE orders
ALTER COLUMN discount_amount SET NOT NULL;

-- ì¸ë±ìŠ¤ ìƒì„± (í• ì¸ì´ ì ìš©ëœ ì£¼ë¬¸ ì¡°íšŒìš©)
CREATE INDEX idx_orders_discount_amount
ON orders(discount_amount)
WHERE discount_amount > 0;
```

### 2ï¸âƒ£ RLS UPDATE ì •ì±… ì¶”ê°€
**íŒŒì¼**: `supabase/migrations/20251004_fix_rls_update_policies.sql`

```sql
-- orders í…Œì´ë¸” UPDATE ì •ì±…
CREATE POLICY "Users can update their own orders"
ON orders
FOR UPDATE
TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

-- order_payments í…Œì´ë¸” UPDATE ì •ì±…
CREATE POLICY "Users can update payments for their orders"
ON order_payments
FOR UPDATE
TO authenticated
USING (
  order_id IN (SELECT id FROM orders WHERE user_id = auth.uid())
)
WITH CHECK (
  order_id IN (SELECT id FROM orders WHERE user_id = auth.uid())
);

-- order_shipping í…Œì´ë¸” UPDATE ì •ì±…
CREATE POLICY "Users can update shipping for their orders"
ON order_shipping
FOR UPDATE
TO authenticated
USING (
  order_id IN (SELECT id FROM orders WHERE user_id = auth.uid())
)
WITH CHECK (
  order_id IN (SELECT id FROM orders WHERE user_id = auth.uid())
);
```

### 3ï¸âƒ£ ì¿ í° ì‚¬ìš© RLS ì •ì±… ì¶”ê°€
**íŒŒì¼**: `supabase/migrations/20251004_fix_user_coupons_rls.sql`

```sql
-- user_coupons í…Œì´ë¸” UPDATE ì •ì±…
CREATE POLICY "Users can update their coupons"
ON user_coupons
FOR UPDATE
TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());
```

### 4ï¸âƒ£ ì½”ë“œ ìˆ˜ì •

**lib/supabaseApi.js - ì‚¬ìš©ì í† í° ì¸ì¦**
```javascript
export const updateMultipleOrderStatus = async (orderIds, status, paymentData = null) => {
  // âœ… ì‚¬ìš©ì ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
  const { data: { session } } = await supabase.auth.getSession()
  const accessToken = session?.access_token

  if (!accessToken) {
    throw new Error('ì‚¬ìš©ì ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.')
  }

  // âœ… ì¿ í° í• ì¸ ì¶”ê°€
  if (paymentData?.discountAmount !== undefined) {
    updateData.discount_amount = paymentData.discountAmount
  }

  // âœ… ì‚¬ìš©ì í† í°ìœ¼ë¡œ ì¸ì¦ (CRITICAL FIX)
  const response = await fetch(`${supabaseUrl}/rest/v1/orders?id=eq.${orderId}`, {
    method: 'PATCH',
    headers: {
      'apikey': supabaseKey,
      'Authorization': `Bearer ${accessToken}`,  // â† í•µì‹¬ ìˆ˜ì •
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal'
    },
    body: JSON.stringify(updateData)
  })
}
```

**app/orders/[id]/complete/page.js - ì¿ í° í• ì¸ í‘œì‹œ**
```javascript
// í•˜ë‹¨ ì£¼ë¬¸ ìƒí’ˆ ì„¹ì…˜ì— ì¿ í° í• ì¸ ì¶”ê°€
const couponDiscount = orderData.discount_amount || 0

{couponDiscount > 0 && (
  <div className="flex justify-between items-center">
    <span className="text-sm text-blue-600">ì¿ í° í• ì¸</span>
    <span className="font-medium text-blue-600">
      -â‚©{couponDiscount.toLocaleString()}
    </span>
  </div>
)}
```

---

## âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ìµœì¢… í…ŒìŠ¤íŠ¸
1. ì²´í¬ì•„ì›ƒ í˜ì´ì§€
2. ì œì£¼ ì£¼ì†Œ ì„ íƒ (63625)
3. BEST10 ì¿ í° ì ìš©
4. ì…ê¸ˆìëª… "ê¸°ë¬´ì¹œ" ì…ë ¥
5. ê²°ì œí•˜ê¸°

**ê²°ê³¼ (âœ… ì„±ê³µ):**
```
ğŸ”µ [1.5] ì‚¬ìš©ì ì„¸ì…˜ í† í° í™•ì¸: {hasToken: true, tokenLength: 699}
ğŸ”µ [7] orders í…Œì´ë¸” PATCH ì‘ë‹µ: {status: 204, ok: true}
ğŸ”µ [10] âœ… order_shipping UPDATE ì„±ê³µ
ğŸŸï¸ ì¿ í° ì •ë³´ (DBì—ì„œ ì¡°íšŒ): {db_discount_amount: 24600}  âœ…
ğŸ’° ì£¼ë¬¸ ìƒì„¸: {postalCode: '63625'}  âœ…
ğŸ’° ì…ê¸ˆìëª…: 'ê¸°ë¬´ì¹œ'  âœ…
```

### DB í™•ì¸
```sql
SELECT
  id,
  discount_amount,
  postal_code,
  depositor_name
FROM orders
JOIN order_shipping USING (order_id)
JOIN order_payments USING (order_id)
WHERE id = 'order_id';

-- ê²°ê³¼
discount_amount: 24600  âœ…
postal_code: '63625'     âœ…
depositor_name: 'ê¸°ë¬´ì¹œ'  âœ…
```

---

## ğŸ“ êµí›ˆ

### 1ï¸âƒ£ RLS ì •ì±… ì²´í¬ë¦¬ìŠ¤íŠ¸
**ëª¨ë“  í…Œì´ë¸”ì—ì„œ í™•ì¸:**
- [ ] SELECT ì •ì±…
- [ ] INSERT ì •ì±…
- [ ] **UPDATE ì •ì±…** â† ìì£¼ ëˆ„ë½!
- [ ] DELETE ì •ì±…

### 2ï¸âƒ£ RLS ë””ë²„ê¹… íŒ¨í„´
```
PATCH ì„±ê³µ (204) + DB ì €ì¥ ì•ˆ ë¨ (0 rows)
  â†“
RLS UPDATE ì •ì±… í™•ì¸
  â†“
auth.uid() = null í™•ì¸
  â†“
ì¸ì¦ í† í° í™•ì¸ (ANON KEY vs User Token)
```

### 3ï¸âƒ£ ì‚¬ìš©ì í† í° vs ANON KEY
```javascript
// âŒ ANON KEY: ì„œë¹„ìŠ¤ ë ˆë²¨ ì¸ì¦
Authorization: Bearer ${ANON_KEY}
// auth.uid() = null â†’ RLS ì‹¤íŒ¨

// âœ… User Token: ì‚¬ìš©ì ì„¸ì…˜ ì¸ì¦
const { data: { session } } = await supabase.auth.getSession()
Authorization: Bearer ${session.access_token}
// auth.uid() = ì‹¤ì œ ì‚¬ìš©ì ID â†’ RLS í†µê³¼
```

---

## ğŸ“ ê´€ë ¨ íŒŒì¼

### ë§ˆì´ê·¸ë ˆì´ì…˜
- `supabase/migrations/20251004_add_discount_to_orders.sql`
- `supabase/migrations/20251004_fix_rls_update_policies.sql`
- `supabase/migrations/20251004_fix_user_coupons_rls.sql`

### ì½”ë“œ ìˆ˜ì •
- `lib/supabaseApi.js` - updateMultipleOrderStatus í•¨ìˆ˜
- `app/orders/[id]/complete/page.js` - ì¿ í° í• ì¸ í‘œì‹œ

### ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸
- `scripts/check-rls-policies.sql` - RLS ì •ì±… í™•ì¸

### ë¬¸ì„œ ì—…ë°ì´íŠ¸
- `CLAUDE.md` - ìµœê·¼ ì£¼ìš” ì—…ë°ì´íŠ¸ ì„¹ì…˜
- `DB_REFERENCE_GUIDE.md` - discount_amount ì»¬ëŸ¼ ì¶”ê°€

---

## ğŸš€ ë°°í¬

```bash
# ì»¤ë°‹
git add .
git commit -m "fix: RLS UPDATE ì •ì±… ì¶”ê°€ (ì£¼ë¬¸/ì¿ í° ë°ì´í„° ì €ì¥ ë¬¸ì œ í•´ê²°)"

# í‘¸ì‹œ
git push origin main

# Vercel ìë™ ë°°í¬ ì™„ë£Œ
```

---

**ì‘ì—… ì™„ë£Œ ì‹œê°„**: 2025-10-04 00:30
**ìƒíƒœ**: âœ… ì™„ë£Œ ë° ë°°í¬ë¨
**ë‹¤ìŒ ì‘ì—…**: ìƒˆ ì£¼ë¬¸ìœ¼ë¡œ ì¿ í° ì‚¬ìš© ì™„ë£Œ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ (2025-10-05 ì˜ˆì •)
