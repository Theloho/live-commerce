# 🎟️ 체크아웃 RLS UPDATE 정책 해결 작업 로그

**날짜**: 2025-10-04
**작업자**: Claude Code
**작업 시간**: 약 2시간

---

## 📋 문제 상황

### 1️⃣ 초기 증상
사용자가 체크아웃에서:
- ✅ 제주 주소 선택 (63625)
- ✅ BEST10 쿠폰 적용 (₩24,600 할인)
- ✅ 입금자명 입력 ("기무친")
- ✅ 결제하기 클릭

**결과:**
- ❌ 주문 상세: 서울 주소 (05794)
- ❌ 쿠폰 할인: 0원 또는 undefined
- ❌ 입금자명: 배송자명으로 대체

### 2️⃣ 디버깅 과정

**단계 1: 데이터 전송 확인**
```javascript
// 체크아웃에서 전송한 데이터 (✅ 정상)
paymentUpdateData = {
  discountAmount: 24600,
  shippingData: {
    shipping_postal_code: '63625'
  },
  depositorName: '기무친'
}
```

**단계 2: API 응답 확인**
```javascript
// PATCH 요청 (✅ 성공)
response.status: 204
response.ok: true

// 하지만 DB 조회 시 (❌ 저장 안 됨)
discount_amount: 0
postal_code: '05794'
depositor_name: null
```

**단계 3: 근본 원인 발견**
1. **RLS UPDATE 정책 누락**
   - orders, order_payments, order_shipping, user_coupons 테이블
   - PATCH는 성공하지만 0 rows updated

2. **ANON KEY 인증 문제**
   ```javascript
   // 기존 (❌)
   Authorization: `Bearer ${ANON_KEY}`
   // RLS: auth.uid() = null → 권한 없음

   // 수정 (✅)
   const { data: { session } } = await supabase.auth.getSession()
   Authorization: `Bearer ${session.access_token}`
   // RLS: auth.uid() = 실제 사용자 ID → 권한 있음
   ```

3. **discount_amount 컬럼 누락**
   - DB 스키마에 존재하지 않음
   - 마이그레이션 필요

---

## 🛠️ 해결 방법

### 1️⃣ DB 스키마 수정
**파일**: `supabase/migrations/20251004_add_discount_to_orders.sql`

```sql
-- discount_amount 컬럼 추가
ALTER TABLE orders
ADD COLUMN discount_amount DECIMAL(12, 2) DEFAULT 0;

-- NOT NULL 제약조건 추가
ALTER TABLE orders
ALTER COLUMN discount_amount SET NOT NULL;

-- 인덱스 생성 (할인이 적용된 주문 조회용)
CREATE INDEX idx_orders_discount_amount
ON orders(discount_amount)
WHERE discount_amount > 0;
```

### 2️⃣ RLS UPDATE 정책 추가
**파일**: `supabase/migrations/20251004_fix_rls_update_policies.sql`

```sql
-- orders 테이블 UPDATE 정책
CREATE POLICY "Users can update their own orders"
ON orders
FOR UPDATE
TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

-- order_payments 테이블 UPDATE 정책
CREATE POLICY "Users can update payments for their orders"
ON order_payments
FOR UPDATE
TO authenticated
USING (
  order_id IN (SELECT id FROM orders WHERE user_id = auth.uid())
)
WITH CHECK (
  order_id IN (SELECT id FROM orders WHERE user_id = auth.uid())
);

-- order_shipping 테이블 UPDATE 정책
CREATE POLICY "Users can update shipping for their orders"
ON order_shipping
FOR UPDATE
TO authenticated
USING (
  order_id IN (SELECT id FROM orders WHERE user_id = auth.uid())
)
WITH CHECK (
  order_id IN (SELECT id FROM orders WHERE user_id = auth.uid())
);
```

### 3️⃣ 쿠폰 사용 RLS 정책 추가
**파일**: `supabase/migrations/20251004_fix_user_coupons_rls.sql`

```sql
-- user_coupons 테이블 UPDATE 정책
CREATE POLICY "Users can update their coupons"
ON user_coupons
FOR UPDATE
TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());
```

### 4️⃣ 코드 수정

**lib/supabaseApi.js - 사용자 토큰 인증**
```javascript
export const updateMultipleOrderStatus = async (orderIds, status, paymentData = null) => {
  // ✅ 사용자 세션 토큰 가져오기
  const { data: { session } } = await supabase.auth.getSession()
  const accessToken = session?.access_token

  if (!accessToken) {
    throw new Error('사용자 세션이 없습니다. 로그인이 필요합니다.')
  }

  // ✅ 쿠폰 할인 추가
  if (paymentData?.discountAmount !== undefined) {
    updateData.discount_amount = paymentData.discountAmount
  }

  // ✅ 사용자 토큰으로 인증 (CRITICAL FIX)
  const response = await fetch(`${supabaseUrl}/rest/v1/orders?id=eq.${orderId}`, {
    method: 'PATCH',
    headers: {
      'apikey': supabaseKey,
      'Authorization': `Bearer ${accessToken}`,  // ← 핵심 수정
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal'
    },
    body: JSON.stringify(updateData)
  })
}
```

**app/orders/[id]/complete/page.js - 쿠폰 할인 표시**
```javascript
// 하단 주문 상품 섹션에 쿠폰 할인 추가
const couponDiscount = orderData.discount_amount || 0

{couponDiscount > 0 && (
  <div className="flex justify-between items-center">
    <span className="text-sm text-blue-600">쿠폰 할인</span>
    <span className="font-medium text-blue-600">
      -₩{couponDiscount.toLocaleString()}
    </span>
  </div>
)}
```

---

## ✅ 테스트 결과

### 최종 테스트
1. 체크아웃 페이지
2. 제주 주소 선택 (63625)
3. BEST10 쿠폰 적용
4. 입금자명 "기무친" 입력
5. 결제하기

**결과 (✅ 성공):**
```
🔵 [1.5] 사용자 세션 토큰 확인: {hasToken: true, tokenLength: 699}
🔵 [7] orders 테이블 PATCH 응답: {status: 204, ok: true}
🔵 [10] ✅ order_shipping UPDATE 성공
🎟️ 쿠폰 정보 (DB에서 조회): {db_discount_amount: 24600}  ✅
💰 주문 상세: {postalCode: '63625'}  ✅
💰 입금자명: '기무친'  ✅
```

### DB 확인
```sql
SELECT
  id,
  discount_amount,
  postal_code,
  depositor_name
FROM orders
JOIN order_shipping USING (order_id)
JOIN order_payments USING (order_id)
WHERE id = 'order_id';

-- 결과
discount_amount: 24600  ✅
postal_code: '63625'     ✅
depositor_name: '기무친'  ✅
```

---

## 🎓 교훈

### 1️⃣ RLS 정책 체크리스트
**모든 테이블에서 확인:**
- [ ] SELECT 정책
- [ ] INSERT 정책
- [ ] **UPDATE 정책** ← 자주 누락!
- [ ] DELETE 정책

### 2️⃣ RLS 디버깅 패턴
```
PATCH 성공 (204) + DB 저장 안 됨 (0 rows)
  ↓
RLS UPDATE 정책 확인
  ↓
auth.uid() = null 확인
  ↓
인증 토큰 확인 (ANON KEY vs User Token)
```

### 3️⃣ 사용자 토큰 vs ANON KEY
```javascript
// ❌ ANON KEY: 서비스 레벨 인증
Authorization: Bearer ${ANON_KEY}
// auth.uid() = null → RLS 실패

// ✅ User Token: 사용자 세션 인증
const { data: { session } } = await supabase.auth.getSession()
Authorization: Bearer ${session.access_token}
// auth.uid() = 실제 사용자 ID → RLS 통과
```

---

## 📝 관련 파일

### 마이그레이션
- `supabase/migrations/20251004_add_discount_to_orders.sql`
- `supabase/migrations/20251004_fix_rls_update_policies.sql`
- `supabase/migrations/20251004_fix_user_coupons_rls.sql`

### 코드 수정
- `lib/supabaseApi.js` - updateMultipleOrderStatus 함수
- `app/orders/[id]/complete/page.js` - 쿠폰 할인 표시

### 검증 스크립트
- `scripts/check-rls-policies.sql` - RLS 정책 확인

### 문서 업데이트
- `CLAUDE.md` - 최근 주요 업데이트 섹션
- `DB_REFERENCE_GUIDE.md` - discount_amount 컬럼 추가

---

## 🚀 배포

```bash
# 커밋
git add .
git commit -m "fix: RLS UPDATE 정책 추가 (주문/쿠폰 데이터 저장 문제 해결)"

# 푸시
git push origin main

# Vercel 자동 배포 완료
```

---

**작업 완료 시간**: 2025-10-04 00:30
**상태**: ✅ 완료 및 배포됨
**다음 작업**: 새 주문으로 쿠폰 사용 완료 처리 테스트 (2025-10-05 예정)
