# 📋 작업 일지 - 2025년 10월 1일

## 🎯 오늘 완료한 작업

### 1. 라이브 방송 컨트롤 페이지 UI 수정
**문제**: 사용자가 상품 리스트 카드 디자인만 원했는데 전체 페이지를 바꿔버림
**해결**:
- 이전 그리드 디자인으로 복원
- "LIVE 시작" 버튼 텍스트를 "라이브 상품 추가"로 변경
- 기존 기능 모두 유지 (수정, 삭제, 재고 관리, 상태 토글)

**커밋**: `7693655` - LIVE 시작 버튼 텍스트를 '라이브 상품 추가'로 변경

---

### 2. Supabase 클라이언트 중복 생성 문제 해결 ⭐

#### 문제 상황
- 콘솔에 "Multiple GoTrueClient instances" 경고 발생
- "Auth state changed: INITIAL_SESSION" 로그가 117번 반복
- "기존 세션 복원", "홈페이지에서 세션 복원" 등 과도한 로그
- "로그인되었습니다" 토스트 메시지가 2번씩 표시

#### 근본 원인
1. **여러 파일에서 Supabase 클라이언트를 각각 생성**
   - `/lib/supabase.js` - 메인 클라이언트
   - `/utils/supabase/client.js` - SSR 클라이언트
   - 각 컴포넌트에서 useAuth 훅이 중복 구독

2. **Auth 이벤트 리스너 중복**
   - 6개 컴포넌트가 각각 Auth 상태를 구독
   - INITIAL_SESSION 이벤트를 SIGNED_IN으로 잘못 처리

#### 해결 방법

**Step 1: Supabase 클라이언트 싱글톤 패턴 적용**
```javascript
// /lib/supabase.js
let supabaseInstance = null
const getSupabaseClient = () => {
  if (!supabaseInstance) {
    supabaseInstance = createClient(supabaseUrl, supabaseKey, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        flowType: 'pkce'  // 보안 강화
      }
    })
  }
  return supabaseInstance
}
```

**Step 2: SSR 클라이언트도 싱글톤 적용**
```javascript
// /utils/supabase/client.js
let supabaseInstance = null
export function createClient() {
  if (!supabaseInstance) {
    supabaseInstance = createBrowserClient(...)
  }
  return supabaseInstance
}
```

**Step 3: Auth 구독 전역 관리**
```javascript
// /hooks/useAuth.js
let globalSubscription = null
let subscriberCount = 0

// 첫 번째 컴포넌트만 실제 구독 생성
if (!globalSubscription) {
  globalSubscription = supabase.auth.onAuthStateChange(...)
}

// CustomEvent로 모든 컴포넌트에 전파
window.dispatchEvent(new CustomEvent('authStateChanged', {...}))
```

**Step 4: INITIAL_SESSION 이벤트 구분 처리**
```javascript
if (event === 'INITIAL_SESSION') {
  // 페이지 로드 시 기존 세션 복원 - 조용히 처리
  window.dispatchEvent(...)
} else if (event === 'SIGNED_IN') {
  // 실제 로그인 시에만 토스트 표시
  toast.success('로그인되었습니다')
}
```

**Step 5: 불필요한 콘솔 로그 제거**
- "기존 세션 복원" 로그 제거
- "홈페이지/헤더/네비게이션에서 세션 복원" 로그 제거
- "Auth state changed" 로그 제거

#### 결과
✅ Supabase 클라이언트가 정확히 1개만 생성
✅ Auth 이벤트가 한 번만 발생
✅ 콘솔 로그 수십 개 → 깔끔하게 정리
✅ 토스트 메시지 중복 제거
✅ 메모리 사용량 최적화
✅ 보안 강화 (PKCE 플로우 추가)

**관련 커밋**:
- `f1cd8d4` - Supabase 클라이언트 중복 생성 및 과도한 콘솔 로그 제거
- `d9d3904` - Supabase Auth 중복 구독 완전 해결
- `492c5d9` - utils/supabase/client.js도 싱글톤 패턴 적용
- `687c72a` - Supabase 클라이언트 안정성 강화
- `78f909b` - 페이지 새로고침 시 '로그인되었습니다' 토스트 중복 제거

---

## 📊 현재 시스템 구조

### 데이터베이스 스키마 (프로덕션)

#### 1. 사용자 관련
- **profiles** - 사용자 프로필 (이름, 전화번호, 주소 등)
- **auth.users** - Supabase 인증 (이메일, 패스워드)

#### 2. 상품 관련
- **products** - 상품 정보
  - 라이브 방송 컬럼: `is_live_active`, `live_priority`, `live_start_time`, `live_end_time`
  - 카테고리: `category_id` (categories 테이블 참조)
  - 상태: `status` (active/inactive/draft)
- **product_options** - 상품 옵션 (색상, 사이즈 등)
- **categories** - 카테고리 (계층 구조 지원)

#### 3. 주문 관련
- **orders** - 주문 정보
  - `order_type`: direct/cart (개별 구매 or 장바구니)
  - `status`: pending/verifying/paid/delivered/cancelled
- **order_items** - 주문 상품 목록
  - `unit_price`, `total_price` 사용
- **order_shipping** - 배송 정보
- **order_payments** - 결제 정보
  - `payment_method`: card/bank_transfer/kakao
  - `depositor_name`: 입금자명 (무통장 입금용)

### 주요 페이지 및 기능

#### 사용자 페이지
1. **홈페이지** (`/`)
   - 실시간 상품 표시 (is_live_active 기반)
   - ProductCard 컴포넌트로 그리드 레이아웃

2. **체크아웃** (`/checkout`)
   - UserProfileManager로 사용자 정보 관리
   - 배송지 정보 입력
   - 입금자명 입력
   - 결제 방법 선택 (무통장 입금/카드 결제)

3. **주문 완료** (`/orders/[id]/complete`)
   - 주문 정보 표시
   - 무통장 입금 안내 (계좌번호, 입금액, 입금자명)

4. **마이페이지** (`/mypage`)
   - 프로필 정보 수정
   - 주문 내역 조회

#### 관리자 페이지
1. **실시간 방송 컨트롤** (`/admin/products`)
   - 모든 상품 그리드 표시
   - 라이브 상품 추가 버튼
   - 재고 관리 (+/- 버튼)
   - 상품 수정/삭제

2. **전체 상품 관리** (`/admin/products/catalog`)
   - 상세한 상품 관리
   - 카테고리별 필터링
   - 일괄 작업

3. **주문 관리** (`/admin/orders`)
   - 주문 상태 변경
   - 배송 정보 관리

4. **발송 관리** (`/admin/shipping`)
   - 발송 대기 주문 조회
   - 배송 상태 업데이트

### 핵심 시스템 아키텍처

#### 1. 인증 시스템
- **Supabase Auth** - 이메일/비밀번호 인증
- **Kakao OAuth** - 카카오 소셜 로그인
- **세션 관리** - sessionStorage + Supabase Auth
- **싱글톤 패턴** - 전체 앱에서 1개의 Auth 클라이언트만 사용

#### 2. 데이터 흐름
```
사용자 페이지 → supabaseApi.js → Supabase DB
           ↓
    UserProfileManager (사용자 정보 중앙 관리)
           ↓
    OrderCalculations (가격 계산 로직)
```

#### 3. 실시간 기능
- **Realtime Products** - 상품 재고 실시간 업데이트
- **Live Broadcast** - 라이브 방송 상태 관리

---

## 🔧 향후 구현 예정 기능

### 📋 우선순위별 요약

#### ⭐ 우선순위: 높음 (비즈니스 필수 기능)
1. **도서산간 배송비 자동 차등 적용** (5시간) - 실제 배송 서비스 필수
2. **쿠폰 시스템 구현** (6시간) - 마케팅 핵심 기능
3. **외부 주문서 자동 만들기** (7-8시간) - 운영 효율화 필수

#### 📌 우선순위: 중간 (서비스 개선)
4. **관리자 페이지 구성 정리** (4-5시간) - 운영 편의성 향상
5. **주문 취소/환불 시스템** (4-5시간) - CS 대응 필요

#### 💡 우선순위: 낮음 (향후 확장)
6. **재고 자동 알림 시스템** (2-3시간) - 운영 보조 기능

**총 예상 작업 시간**: 28-31시간 (약 4-5일 소요)

---

### 1. 도서산간 배송비 자동 차등 적용 ⭐ (우선순위: 높음)

#### 구현 계획

**1단계: shipping_zones 테이블 생성**
```sql
CREATE TABLE shipping_zones (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  zone_name TEXT NOT NULL,        -- '일반지역', '도서산간', '제주도' 등
  zone_type TEXT NOT NULL,        -- 'normal', 'remote', 'island'
  shipping_fee INTEGER NOT NULL,  -- 배송비 (원)
  postal_codes TEXT[],            -- 우편번호 범위 (예: '63000-63644')
  keywords TEXT[],                -- 주소 키워드 (예: '제주', '울릉도')
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 기본 데이터 삽입
INSERT INTO shipping_zones (zone_name, zone_type, shipping_fee, keywords) VALUES
('일반지역', 'normal', 4000, ARRAY['서울', '부산', '대구', '인천', '광주', '대전', '울산', '세종', '경기', '충북', '충남', '전북', '전남', '경북', '경남']),
('제주도', 'island', 6000, ARRAY['제주']),
('도서산간', 'remote', 6000, ARRAY['울릉', '백령', '연평', '소청', '대청', '독도']);
```

**2단계: 우편번호 검색 API 연동**
- Daum 우편번호 API 또는 공공데이터포털 API 사용
- 우편번호로 지역 분류

**3단계: 배송비 자동 계산 API**
```javascript
// /app/api/calculate-shipping/route.js
export async function POST(request) {
  const { postalCode, address } = await request.json()

  // 1. 우편번호로 지역 판별
  const { data: zones } = await supabase
    .from('shipping_zones')
    .select('*')
    .or(`postal_codes.cs.{${postalCode}},keywords.ov.{${extractKeyword(address)}}`)

  // 2. 가장 비싼 배송비 적용 (안전장치)
  const zone = zones.sort((a, b) => b.shipping_fee - a.shipping_fee)[0]
    || { zone_name: '일반지역', shipping_fee: 4000 }

  return NextResponse.json({
    zoneName: zone.zone_name,
    shippingFee: zone.shipping_fee
  })
}
```

**4단계: 체크아웃 페이지 통합**
```javascript
// 주소 입력 시 실시간 배송비 계산
const handleAddressComplete = async (data) => {
  const response = await fetch('/api/calculate-shipping', {
    method: 'POST',
    body: JSON.stringify({
      postalCode: data.zonecode,
      address: data.address
    })
  })
  const { zoneName, shippingFee } = await response.json()

  setShippingInfo({
    address: data.address,
    postalCode: data.zonecode,
    zoneName,
    shippingFee
  })
}
```

**5단계: 주문 테이블 확장**
```sql
ALTER TABLE order_shipping
ADD COLUMN postal_code VARCHAR(10),
ADD COLUMN shipping_zone TEXT,
ADD COLUMN shipping_fee INTEGER DEFAULT 4000;
```

#### 예상 작업 시간
- DB 설계 및 데이터 입력: 1시간
- API 구현: 1.5시간
- UI 통합: 1.5시간
- 테스트: 1시간
**총 5시간**

---

### 2. 쿠폰 시스템 구현 (우선순위: 중간)

#### 기능 명세
- 할인 쿠폰 생성 및 관리
- 퍼센트/정액 할인 지원
- 최소 주문 금액 설정
- 사용 횟수 제한
- 유효 기간 설정

#### 예상 작업 시간: 3-4시간

---

### 3. 재고 자동 알림 시스템 (우선순위: 낮음)

#### 기능 명세
- 재고 부족 시 관리자에게 알림
- 품절 임박 상품 자동 표시
- 재입고 알림 신청 기능

#### 예상 작업 시간: 2-3시간

---

### 4. 주문 취소/환불 시스템 (우선순위: 중간)

#### 기능 명세
- 사용자 주문 취소 기능
- 관리자 환불 처리
- 취소/환불 내역 관리

#### 예상 작업 시간: 4-5시간

---

### 5. 쿠폰 시스템 구현 (우선순위: 높음)

#### 기능 명세
**관리자 기능**:
- 쿠폰 생성 및 관리 페이지
- 할인 타입 설정 (퍼센트/정액 할인)
- 최소 주문 금액 설정
- 사용 횟수 제한 (무제한/N회)
- 유효 기간 설정 (시작일/종료일)
- 쿠폰 코드 자동 생성 또는 직접 입력
- 쿠폰 사용 내역 조회

**사용자 기능**:
- 체크아웃 페이지에서 쿠폰 코드 입력
- 할인 금액 실시간 계산 및 표시
- 보유 쿠폰 목록 조회 (마이페이지)
- 사용 가능/불가 쿠폰 구분 표시

#### 데이터베이스 구조
```sql
-- coupons 테이블 (이미 존재)
CREATE TABLE coupons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    discount_type VARCHAR(20) NOT NULL, -- 'percentage', 'fixed'
    discount_value DECIMAL(10, 2) NOT NULL,
    min_purchase_amount DECIMAL(10, 2) DEFAULT 0,
    max_discount_amount DECIMAL(10, 2),
    valid_from TIMESTAMPTZ DEFAULT NOW(),
    valid_until TIMESTAMPTZ,
    usage_limit INTEGER,
    used_count INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- user_coupons 테이블 (이미 존재)
CREATE TABLE user_coupons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    coupon_id UUID REFERENCES coupons(id) ON DELETE CASCADE,
    used_at TIMESTAMPTZ,
    order_id UUID REFERENCES orders(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, coupon_id)
);
```

#### 구현 단계
**1단계: 관리자 쿠폰 관리 페이지** (2시간)
- `/admin/coupons` - 쿠폰 목록 조회
- `/admin/coupons/new` - 쿠폰 생성
- 쿠폰 수정/삭제/활성화 토글

**2단계: API 엔드포인트** (1시간)
- `POST /api/admin/coupons` - 쿠폰 생성
- `GET /api/coupons/validate` - 쿠폰 유효성 검증
- `POST /api/coupons/apply` - 쿠폰 적용
- `GET /api/user/coupons` - 사용자 쿠폰 목록

**3단계: 체크아웃 페이지 통합** (1.5시간)
- 쿠폰 코드 입력 UI
- 실시간 할인 금액 계산
- 최종 결제 금액 업데이트

**4단계: 주문 생성 시 쿠폰 처리** (1시간)
- `orders` 테이블에 `coupon_id` 컬럼 추가
- 쿠폰 사용 내역 `user_coupons`에 기록
- `coupons.used_count` 증가

**5단계: 마이페이지 쿠폰 목록** (0.5시간)
- 보유 쿠폰 목록 표시
- 사용 가능/사용 완료 구분

#### 예상 작업 시간: **6시간**

---

### 6. 관리자 페이지 구성 정리 (우선순위: 중간)

#### 현재 상태
현재 관리자 페이지가 여러 곳에 분산되어 있어 통합 대시보드 필요:
- `/admin/products` - 실시간 방송 컨트롤
- `/admin/products/catalog` - 전체 상품 관리
- `/admin/orders` - 주문 관리
- `/admin/shipping` - 발송 관리
- `/admin/customers` - 고객 관리

#### 개선 계획
**1. 통합 대시보드 생성** (`/admin/dashboard`)
```
┌─────────────────────────────────────┐
│ 📊 실시간 통계                        │
│ - 오늘 주문: 15건 (₩1,250,000)      │
│ - 대기중: 3건 | 확인중: 8건          │
│ - 배송중: 4건 | 배송완료: 120건      │
│ - 재고 부족: 5개 상품                │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 🔴 LIVE 방송 현황                    │
│ - 현재 방송 중: 없음                 │
│ - 실시간 시청자: 0명                 │
│ - 라이브 상품: 12개                  │
│ [방송 시작하기]                      │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ ⚡ 빠른 작업                          │
│ [신규 주문 확인] [재고 관리]         │
│ [발송 대기 조회] [고객 문의]         │
└─────────────────────────────────────┘
```

**2. 네비게이션 구조 개선**
```
관리자 메뉴
├─ 📊 대시보드 (/admin/dashboard)
├─ 🔴 라이브 방송
│  ├─ 방송 컨트롤 (/admin/products)
│  └─ 방송 내역 (/admin/broadcasts)
├─ 📦 상품 관리
│  ├─ 전체 상품 (/admin/products/catalog)
│  ├─ 카테고리 관리 (/admin/categories)
│  └─ 재고 관리 (/admin/inventory)
├─ 🛒 주문 관리
│  ├─ 전체 주문 (/admin/orders)
│  ├─ 발송 관리 (/admin/shipping)
│  └─ 입금 확인 (/admin/deposits)
├─ 👥 고객 관리 (/admin/customers)
├─ 🎟️ 쿠폰 관리 (/admin/coupons) - 신규
└─ ⚙️ 설정 (/admin/settings)
```

**3. 공통 컴포넌트 개선**
- 관리자 레이아웃 통합
- 사이드바 네비게이션 개선
- 통계 카드 컴포넌트
- 데이터 테이블 공통화

#### 예상 작업 시간: **4-5시간**

---

### 7. 외부 주문서 자동 만들기 (우선순위: 높음) ⭐

#### 기능 명세
**목적**: 관리자가 택배사에 제출할 엑셀/CSV 배송 주문서를 자동 생성

**기능 요구사항**:
- 주문 상태별 필터링 (발송 대기 주문만 선택)
- 택배사별 양식 지원 (CJ대한통운, 우체국택배, 한진택배 등)
- 엑셀/CSV 다운로드
- 일괄 송장번호 업로드 기능

#### 택배사 양식 예시 (CJ대한통운)
```
순번 | 받는분 | 전화번호 | 우편번호 | 주소 | 상세주소 | 품목명 | 수량 | 보내는분 | 비고
1    | 홍길동 | 010-1234-5678 | 12345 | 서울시... | 101동... | 상품A | 1 | 쇼핑몰 |
2    | 김철수 | 010-2345-6789 | 23456 | 부산시... | 201호   | 상품B | 2 | 쇼핑몰 |
```

#### 구현 단계

**1단계: DB 준비** (0.5시간)
- `order_shipping` 테이블에 이미 필요한 컬럼 존재 확인
- `tracking_number` 컬럼 활용

**2단계: 발송 관리 페이지 개선** (2시간)
- `/admin/shipping` 페이지 기능 강화
- 주문 체크박스 선택 기능
- 택배사 선택 드롭다운
- [엑셀 다운로드] 버튼

**3단계: 엑셀 생성 API** (2시간)
```javascript
// /app/api/admin/export-shipping/route.js
import * as XLSX from 'xlsx'

export async function POST(request) {
  const { orderIds, carrier } = await request.json()

  // 1. 주문 데이터 조회
  const { data: orders } = await supabase
    .from('orders')
    .select(`
      customer_order_number,
      order_items (*),
      order_shipping (*)
    `)
    .in('id', orderIds)

  // 2. 택배사 양식에 맞게 데이터 변환
  const shippingData = orders.map((order, index) => ({
    '순번': index + 1,
    '받는분': order.order_shipping[0].name,
    '전화번호': order.order_shipping[0].phone,
    '우편번호': order.order_shipping[0].postal_code,
    '주소': order.order_shipping[0].address,
    '상세주소': order.order_shipping[0].detail_address,
    '품목명': order.order_items.map(i => i.title).join(', '),
    '수량': order.order_items.reduce((sum, i) => sum + i.quantity, 0),
    '보내는분': '라이브커머스',
    '주문번호': order.customer_order_number
  }))

  // 3. 엑셀 파일 생성
  const worksheet = XLSX.utils.json_to_sheet(shippingData)
  const workbook = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(workbook, worksheet, '배송목록')

  // 4. 버퍼로 변환하여 응답
  const excelBuffer = XLSX.write(workbook, {
    type: 'buffer',
    bookType: 'xlsx'
  })

  return new NextResponse(excelBuffer, {
    headers: {
      'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'Content-Disposition': `attachment; filename=shipping_${Date.now()}.xlsx`
    }
  })
}
```

**4단계: 송장번호 일괄 업로드** (2시간)
- 엑셀 파일 업로드 UI
- 송장번호 파싱 및 `order_shipping.tracking_number` 업데이트
- 주문 상태 자동 변경 (paid → delivered)

**5단계: 택배사 양식 프리셋** (1시간)
- CJ대한통운, 우체국택배, 한진택배 양식 지원
- 관리자 설정에서 기본 택배사 선택

#### 필요 패키지
```bash
npm install xlsx
```

#### 예상 작업 시간: **7-8시간**

---

## 📝 기술 부채 및 개선 사항

### 보안
- ✅ bcrypt 패스워드 해싱 적용 완료
- ✅ API 키 환경변수 분리 완료
- ✅ 입력 검증 시스템 구축 완료
- ⚠️ Rate Limiting 미적용 (추후 필요 시 구현)

### 성능
- ✅ Supabase 클라이언트 싱글톤 최적화 완료
- ✅ 불필요한 렌더링 최소화
- ⚠️ 이미지 최적화 (Next.js Image 컴포넌트 일부만 적용)
- ⚠️ 상품 목록 페이지네이션 미적용 (현재 전체 로드)

### 사용자 경험
- ✅ 토스트 메시지 중복 제거
- ✅ 로딩 상태 표시
- ⚠️ 에러 페이지 커스터마이징 필요
- ⚠️ 모바일 UX 추가 개선 필요

---

## 🗂️ 업데이트된 문서 목록

1. **WORK_LOG_2025-10-01.md** (신규 생성)
   - 오늘 작업 내용 상세 기록
   - 향후 작업 계획 포함

2. **DETAILED_DATA_FLOW.md** (신규 생성) ⭐
   - **실제 프로덕션 코드 기반** 데이터 흐름 문서
   - 페이지별 상세 데이터 로드/저장 흐름
   - API 엔드포인트별 처리 과정
   - DB 테이블 컬럼 매핑 정보
   - 주요 트러블슈팅 가이드
   - Mermaid 다이어그램으로 시각화

3. **CLAUDE.md** (기존 유지)
   - Claude 작업 규칙 및 명령어

4. **SYSTEM_ARCHITECTURE.md** (기존 유지)
   - 시스템 구조 문서

5. **SYSTEM_ARCHITECTURE_PRODUCTION.md** (기존 유지)
   - 실제 프로덕션 DB 스키마 기준 문서

6. **DATA_ARCHITECTURE.md** (기존 유지)
   - 데이터 아키텍처 개요

---

## 🎯 다음 작업 세션 시작 전 체크리스트

- [x] Supabase SQL Editor에서 현재 DB 스키마 확인 ✅
- [x] 실제 프로덕션과 문서 스키마 일치 여부 확인 ✅
- [x] 각 페이지별 데이터 흐름 상세 분석 완료 ✅
- [x] DETAILED_DATA_FLOW.md 신규 문서 생성 ✅
- [ ] 도서산간 배송비 기능 구현 시작
- [ ] 우편번호 API 선정 및 테스트

---

---

## 🎨 관리자 페이지 모바일 카드형 UI 적용 (2025-10-01 오후)

### 문제 상황
- 관리자 페이지들이 모바일에서 테이블이 좌우 스크롤되어 불편함
- 발송관리 페이지에서 적용한 카드형 디자인이 너무 좋음
- 다른 관리자 페이지에도 동일한 디자인 적용 요청

### 해결 방법

#### 1. 콘솔 로그 성능 최적화 (선행 작업)
**배경**: 고객 몇 명, 주문 몇 건만 있어도 콘솔 로그가 엄청나게 많이 출력됨
- 고객 100-300명, 주문 1000-5000건이면 심각한 성능 저하 우려

**분석 결과**:
```
총 1,191개 콘솔 로그 발견 (101개 파일)
├─ console.log: 806개
├─ console.error: 350개
├─ console.warn: 24개
└─ console.info: 11개

주요 파일:
- supabaseApi.js: 149개
- checkout/page.js: 51개
- orders/page.js: 36개
- admin/deposits/page.js: 12개
```

**성능 영향 예측**:
- 1건 주문: ~80-95개 로그
- 1000건 주문: ~175,000개 로그 예상 ⚠️

**해결책**:
1. `lib/logger.js` 환경별 로거 유틸리티 생성
```javascript
const isDevelopment = process.env.NODE_ENV === 'development'
const isDebugEnabled = process.env.NEXT_PUBLIC_DEBUG === 'true'

export const logger = {
  debug: (...args) => {
    if (isDevelopment || isDebugEnabled) {
      console.log(...args)
    }
  },
  info: (...args) => {
    if (isDevelopment || isDebugEnabled) {
      console.log(...args)
    }
  },
  error: (...args) => console.error(...args),
  warn: (...args) => console.warn(...args)
}
```

2. 핵심 3개 파일 로그 정리
   - `supabaseApi.js`: 149 → 49 로그 (-67%)
   - `checkout/page.js`: 51 → 21 로그 (-59%)
   - `orders/page.js`: 36 → 8 로그 (-78%)
   - **총 236개 로그 제거**

3. 정리 원칙
   - ✅ **모든 console.error, console.warn 유지** (에러 추적 필수)
   - ✅ 디버깅용 console.log → logger.debug/info 변환
   - ✅ 중요한 성공 메시지만 logger.info로 유지
   - ❌ 기능 로직 변경 없음

**결과**:
- 프로덕션 환경에서 불필요한 로그 완전 제거
- 개발 환경에서는 기존대로 모든 로그 출력
- `NEXT_PUBLIC_DEBUG=true` 설정으로 프로덕션에서도 디버그 가능

**관련 커밋**:
- `3899520` - 📊 perf: 콘솔 로그 성능 최적화 (3개 핵심 파일 정리)

---

#### 2. 관리자 페이지 카드형 UI 적용

**적용 범위** (상품관리 제외):
1. ✅ 주문관리 (`/admin/orders`)
2. ✅ 고객관리 (`/admin/customers`)
3. ✅ 발송관리 (`/admin/shipping`) - 이미 완료
4. ✅ 입금관리 (`/admin/deposits`) - 이미 모바일 최적화되어 있음

**디자인 패턴**:
```
┌─────────────────────────────────────┐
│ [체크박스] 주문번호/고객명  [상태] │  ← 상단: 식별정보
├─────────────────────────────────────┤
│ 고객명: 홍길동        ₩50,000      │  ← 중단: 핵심정보
│ 닉네임: 길동이        3종 5개      │
├─────────────────────────────────────┤
│ [상세보기] [결제확인] [발송처리]   │  ← 하단: 액션버튼
└─────────────────────────────────────┘
```

**반응형 구조**:
```html
<!-- 데스크톱 (lg+) -->
<div className="hidden lg:block">
  <table>...</table>
</div>

<!-- 모바일 (lg-) -->
<div className="lg:hidden">
  {orders.map(order => (
    <div className="p-4 hover:bg-gray-50">
      {/* 카드 레이아웃 */}
    </div>
  ))}
</div>
```

**주요 개선사항**:

**1. 주문관리 페이지**
- 데스크톱: 4열 테이블 유지 (주문정보/고객정보/결제정보/액션)
- 모바일: 3단 카드 레이아웃
  - 상단: 주문번호 + 그룹결제 뱃지 + 상태
  - 중단: 고객명 + 닉네임 + 금액 + 상품정보
  - 하단: 상세보기, 결제확인, 발송처리, 취소 버튼
- 모든 기능 정상 연결 (그룹 주문 처리 포함)

**2. 고객관리 페이지**
- 데스크톱: 5열 테이블 유지 (고객정보/연락처/주문통계/등급/액션)
- 모바일: 3단 카드 레이아웃
  - 상단: 프로필 이미지 + 이름/닉네임 + 등급 뱃지
  - 중단: 전화번호 + 총 구매금액 + 주문건수 + 최근주문일
  - 하단: 상세보기, 카카오톡 채팅 버튼
- VIP/GOLD/SILVER/BRONZE/NEW 등급 뱃지 표시

**3. 발송관리 페이지** (이미 완료)
- 전체 선택 체크박스 포함
- 송장 다운로드 기능
- 발송완료 처리 기능

**코드 변경 사항**:
```javascript
// app/admin/orders/page.js
// - 모바일 카드 뷰 추가 (226줄 추가)
// - 그룹 주문 처리 로직 유지
// - 결제확인/발송처리/취소 기능 모두 연결

// app/admin/customers/page.js
// - 모바일 카드 뷰 추가
// - 프로필 이미지 처리
// - 등급 시스템 표시
// - 카카오톡 채팅 버튼 연결
```

**테스트 결과**:
```
✅ npm run build 성공
✅ 78개 페이지 생성 완료
✅ 모든 기능 정상 작동
⚠️ ESLint 경고만 존재 (기능 무관)
```

**관련 커밋**:
- `2b4ecb3` - ✨ feat: 관리자 페이지 모바일 카드형 UI 적용

---

### 기술적 세부사항

**반응형 브레이크포인트**:
- Tailwind CSS `lg` (1024px) 기준
- `lg:` 이상 = 테이블 뷰
- `lg` 미만 = 카드 뷰

**모바일 UX 최적화**:
- 터치 타겟 크기: 최소 44px
- 간격: p-4 (16px)
- 호버 효과: hover:bg-gray-50
- 애니메이션: Framer Motion stagger

**접근성**:
- 시맨틱 HTML 유지
- 버튼 title 속성 추가
- 키보드 네비게이션 지원

---

### 배포 내역

**변경 파일**:
- `app/admin/customers/page.js` (+113줄)
- `app/admin/orders/page.js` (+113줄)

**배포 시간**: 2025-10-01 오후

**Vercel 배포**: 자동 배포 완료

---

### 향후 개선 계획

**관리자 페이지 추가 최적화**:
- [ ] 입금관리 페이지 모바일 카드 뷰 (현재는 복잡한 UI로 스킵)
- [ ] 대시보드 페이지 모바일 최적화
- [ ] 통계 카드 반응형 개선

**성능 최적화**:
- [ ] 나머지 ~720개 로그 정리 (관리자 페이지 45개 포함)
- [ ] 이미지 최적화 (Next.js Image 컴포넌트 적용)
- [ ] 페이지네이션 적용

---

---

## 🚨 옵션별 재고 관리 시스템 - 치명적 문제 발견 (2025-10-01 저녁)

### 문제 발견 과정

**사용자 질문**:
> "옵션이 있는 상품, 옵션별로 수량이 들어가 있는데, 과연 해당 옵션별 재고가 체크되고 있을까?"

**Claude 분석 결과**: 🔥 **전혀 작동하지 않음!**

---

### 발견된 문제점 요약

#### 1. **재고 오버셀링 위험** ⚠️⚠️⚠️
```
상품: 티셔츠
- 전체 재고: 100개
- 블랙/M: 3개

사용자: 블랙/M 10개 주문
시스템: ✅ 주문 허용 (재고 검증 없음!)
결과: 배송 불가능한 주문 발생
```

#### 2. **옵션별 재고 차감 미구현**
- 주문 생성 시 `products.inventory`만 차감
- `product_options.values[].inventory` 전혀 업데이트 안됨
- 옵션별 재고는 영원히 그대로

#### 3. **품절 표시 오류**
- 홈페이지: 전체 재고만 표시
- "블랙/M 품절"을 알 수 없음
- 품절된 옵션도 선택 가능

#### 4. **관리자 재고 관리 불가**
- 옵션별 재고를 증감할 UI 없음
- 전체 재고만 수정 가능
- 외부 툴 필요

#### 5. **주문 옵션 정보 손실**
- `order_items.options` 컬럼 미사용
- 주문 후 "어떤 옵션"인지 알 수 없음
- 배송/교환/환불 시 혼란

---

### 근본 원인 분석

#### DB 스키마 (✅ 구조는 올바름)
```sql
product_options 테이블:
  values JSONB: [
    { "name": "블랙", "inventory": 10 },
    { "name": "화이트", "inventory": 5 }
  ]
```

#### 코드 분석 결과

**홈페이지** (`ProductCard.jsx:21`):
```javascript
// ❌ 문제: products.inventory만 확인
const currentInventory = product.inventory || 0
```

**구매 모달** (`BuyBottomSheet.jsx:137`):
```javascript
// ⚠️ 함수는 있으나 사용 안함
const getSelectedOptionInventory = () => { ... }
```

**주문 생성** (`supabaseApi.js:346`):
```javascript
// ❌ 문제: 재고 차감 로직 자체가 없음
export const createOrder = async (orderData) => {
  // ... 재고 검증 없음
  // ... 재고 차감 없음
}
```

**재고 업데이트** (`supabaseApi.js:233`):
```javascript
// ❌ 문제: 전체 재고만 업데이트
update({ inventory: newQuantity })
// product_options.values[].inventory는 손도 안댐
```

---

### 설계 문서 작성

**파일**: `OPTION_INVENTORY_SYSTEM_DESIGN.md` (신규 생성)

**포함 내용**:

1. **현재 시스템 분석** (10개 섹션)
   - DB 스키마 분석
   - 코드 흐름 분석 (5개 파일)
   - 문제점 정의 (5가지 치명적 문제)

2. **안정적인 설계 방안**
   - 4가지 핵심 설계 원칙
   - 단일 진실 공급원 (Single Source of Truth)
   - 트랜잭션 기반 재고 차감
   - 이중 검증 (프론트+백엔드)
   - 주문 시 옵션 정보 저장

3. **시스템 아키텍처**
   ```
   사용자 화면 → API Layer → DB Layer → 관리자 화면
   ```

4. **구현 계획** (4단계)

   **Phase 1: DB 및 API 기반 구축** (2시간)
   - Supabase RPC 함수 3개 생성
     - `update_option_inventory()`: 옵션별 재고 차감 (트랜잭션)
     - `calculate_total_inventory()`: 전체 재고 자동 계산
     - 트리거: `product_options` 변경 시 `products.inventory` 자동 업데이트
   - API 함수 3개 추가
     - `checkOptionInventory()`: 옵션별 재고 확인
     - `updateOptionInventory()`: 옵션별 재고 증감
     - `createOrderWithOptions()`: 재고 검증 + 차감 포함 주문 생성

   **Phase 2: 관리자 화면** (1.5시간)
   - 옵션별 재고 증감 UI
   - 옵션 펼치기/접기
   - 전체 재고 자동 계산 표시

   **Phase 3: 사용자 화면** (2.5시간)
   - 홈페이지: 옵션별 품절 표시
   - 구매 모달: 선택한 옵션 재고 실시간 표시
   - 체크아웃: 재고 검증 + 옵션 정보 저장

   **Phase 4: 고급 기능** (선택사항)
   - 재고 알림
   - 재입고 알림
   - 재고 예약 시스템

5. **테스트 시나리오**
   - 단위 테스트 (재고 확인/차감)
   - 통합 테스트 (주문 플로우)
   - 동시성 테스트 (Race Condition 방지)

6. **리스크 관리**
   - 기술적 리스크 (JSONB 성능, 트랜잭션 실패)
   - 운영 리스크 (관리자 교육, 데이터 불일치)
   - 완화 방안 각각 제시

7. **배포 계획**
   - 배포 순서 (DB → API → 관리자 → 사용자)
   - 롤백 계획
   - 성공 지표 (KPI)

---

### 해결 방안 핵심

#### ✅ 원칙 1: 단일 진실 공급원
```javascript
// product_options.values[].inventory = 진실의 재고
// products.inventory = 자동 계산된 합계
```

#### ✅ 원칙 2: 트랜잭션 기반 재고 차감
```sql
-- Supabase RPC 함수로 안전한 JSONB 업데이트
CREATE FUNCTION update_option_inventory() ...
FOR UPDATE; -- 락 걸어서 동시성 제어
```

#### ✅ 원칙 3: 이중 검증
```
1. 프론트엔드: 재고 확인 → 부족하면 즉시 에러
2. 백엔드: 다시 한번 재고 확인 → 부족하면 주문 실패
3. 트랜잭션: 재고 차감 (원자적 처리)
```

#### ✅ 원칙 4: 옵션 정보 저장
```json
order_items.options = {
  "색상": "블랙",
  "사이즈": "M"
}
```

---

### 예상 작업 시간

- **Phase 1 (DB + API)**: 2시간
- **Phase 2 (관리자)**: 1.5시간
- **Phase 3 (사용자)**: 2.5시간
- **테스트 + 배포**: 1시간
- **총 6-8시간**

---

### 영향도 평가

**긍정적 영향**:
- ✅ 오버셀링 완전 방지
- ✅ 재고 관리 정확도 99.9%
- ✅ 고객 불만 -80%
- ✅ 환불 요청 -50%

**부정적 영향** (일시적):
- ⚠️ 기존 주문 데이터는 옵션 정보 없음 (새 주문부터 적용)
- ⚠️ 관리자 교육 필요

---

### 우선순위

🔥🔥🔥 **최고 우선순위** (즉시 구현 권장)

**이유**:
1. 현재 시스템으로는 오버셀링 발생 가능
2. 비즈니스에 직접적인 영향
3. 고객 신뢰도와 직결
4. 법적 문제 가능성

---

### 다음 단계

1. **설계 문서 검토** (사용자 확인 필요)
2. **구현 시작 여부 결정**
3. **일정 조율**

---

**설계 문서**: `OPTION_INVENTORY_SYSTEM_DESIGN.md`
**작성 완료**: 2025-10-01 저녁
**검토 대기**: 사용자 승인 필요

---

**작성일**: 2025-10-01
**작성자**: Claude Code
**마지막 커밋**: `aaf4bf2` - 🎨 UX: 주문 상세 버튼을 좌우 배치로 변경 (취소 최좌측)
