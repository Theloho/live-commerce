# 작업 로그 - 2025년 10월 3일

## 📋 작업 개요
**주제**: 우편번호 시스템 완전 통합 및 도서산간 배송비 전면 적용
**목표**: 모든 페이지에서 우편번호 기반 도서산간 배송비가 정확히 계산되도록 수정
**결과**: ✅ 성공 (전체 시스템에 우편번호 통합 완료)

---

## 🗄️ 데이터베이스 변경사항

### 1. profiles 테이블 - postal_code 컬럼 추가
```sql
ALTER TABLE profiles
ADD COLUMN IF NOT EXISTS postal_code TEXT;
```

**영향도**:
- ✅ 사용자 프로필에 우편번호 저장 가능
- ✅ 주소 선택 시 자동으로 도서산간 배송비 계산
- ✅ 마이페이지에서 우편번호 입력 및 수정 가능

**연관 파일**:
- `app/mypage/page.js` - AddressManager 업그레이드
- `app/checkout/page.js` - 우편번호 로드 및 배송비 계산
- `app/components/product/BuyBottomSheet.jsx` - 프로필에서 우편번호 로드

---

## 🐛 주요 버그 수정

### 1. 모바일 브라우저 입력 필드 가시성 문제 해결
**문제**: 모바일에서 input 텍스트가 보이지 않음
**원인**: `-webkit-text-fill-color` CSS 속성 누락
**해결**: `app/globals.css` 전면 개선

```css
/* 모든 입력 필드 텍스트 가시성 보장 */
input:not([type="radio"]):not([type="checkbox"]),
textarea,
select {
  -webkit-text-fill-color: #000000 !important;
  color: #000000 !important;
  opacity: 1 !important;
  -webkit-appearance: none;
  appearance: none;
}

/* 라디오/체크박스 버튼 보이도록 복원 */
input[type="radio"],
input[type="checkbox"] {
  -webkit-appearance: auto;
  appearance: auto;
}
```

**커밋**: `0505e73 🐛 fix: 모바일 브라우저 입력 필드 텍스트 가시성 문제 수정`

---

### 2. 라디오 버튼 완전히 보이지 않던 문제
**문제**: 체크아웃 입금자명 선택 라디오 버튼이 DOM에는 있지만 화면에 보이지 않음
**원인**: `globals.css`의 `input { appearance: none }`이 모든 input에 적용되어 라디오 버튼도 숨김
**해결**: 라디오/체크박스를 명시적으로 제외

**디버깅 과정**:
1. Tailwind 클래스 추가 시도 → 실패
2. accent-color 추가 → 실패
3. 인라인 스타일 20px → 실패
4. 브라우저 콘솔 확인 → `appearance: none` 발견
5. CSS 수정 → ✅ 성공

**사용자 확인**: "이제 나온다"

---

### 3. MyPage 주소 관리 시스템 이중화 문제
**문제**: MyPage가 구버전 AddressManager 사용, 우편번호 미지원
**원인**:
- `/app/components/AddressManager.jsx` (구버전) 사용 중
- `/app/components/address/AddressManager.jsx` (신버전) 존재

**해결**:
```javascript
// BEFORE
import AddressManager from '@/app/components/AddressManager'
<AddressManager userId={currentUserId} onAddressChange={() => {}} />

// AFTER
import AddressManager from '@/app/components/address/AddressManager'
<AddressManager
  userProfile={userProfile}
  onUpdate={async (updatedData) => {
    // DB에 실제로 저장
    await fetch(`${supabaseUrl}/rest/v1/profiles?id=eq.${currentUser.id}`, {
      method: 'PATCH',
      body: JSON.stringify(updatedData)
    })
  }}
/>
```

**커밋**: `18c3e77 🐛 fix: 마이페이지 주소 관리 구버전 → 신버전 완전 전환`

---

## 🚀 기능 개선

### 1. 우편번호 표시 전 페이지 통합
**적용 페이지**:
- ✅ 주문 상세 (`/orders/[id]/complete`) - 배송지 정보 섹션
- ✅ 주문 목록 모달 (`/orders`) - 그룹 주문 상세 모달
- ✅ 관리자 주문 상세 (`/admin/orders/[id]`) - 배송 정보 카드
- ✅ 관리자 발송 관리 (`/admin/shipping`) - 테이블 및 모바일 카드 뷰
- ✅ 관리자 발송 관리 CSV 다운로드 - 송장 파일에 우편번호 포함

**표시 형식**: `[우편번호] 주소 상세주소`
**예시**: `[63534] 제주특별자치도 서귀포시 가가로 123123`

**커밋**: `833c932 ✨ feat: 모든 주소 표시 페이지에 우편번호 추가`

---

### 2. 도서산간 배송비 계산 완전 통합

#### 2.1 체크아웃 페이지 배송비 계산
**파일**: `app/checkout/page.js`

```javascript
// 우편번호 로드 로직 추가 (line 186)
const addressResponse = await fetch(
  `${supabaseUrl}/rest/v1/profiles?id=eq.${currentUser.id}&select=addresses,address,detail_address,postal_code`
)

// 배송비 계산 (line 531)
const postalCode = selectedAddress?.postal_code || userProfile.postal_code
const shippingInfo = formatShippingInfo(4000, postalCode)
```

**결과**:
- 제주 우편번호 → 배송비 7,000원 (4,000 + 3,000)
- 울릉도/도서산간 → 배송비 9,000원 (4,000 + 5,000)

---

#### 2.2 주문 상세 페이지 우편번호 누락 수정
**문제**: `getOrderById()` 함수가 shipping 객체 생성 시 postal_code 제외
**파일**: `lib/supabaseApi.js` (line 1810-1815)

```javascript
// BEFORE
shipping: {
  name: data.shipping_name || data.order_shipping[0]?.name || '',
  phone: data.shipping_phone || data.order_shipping[0]?.phone || '',
  address: data.shipping_address || data.order_shipping[0]?.address || '',
  detail_address: data.shipping_detail_address || data.order_shipping[0]?.detail_address || ''
}

// AFTER
shipping: {
  name: data.shipping_name || data.order_shipping[0]?.name || '',
  phone: data.shipping_phone || data.order_shipping[0]?.phone || '',
  address: data.shipping_address || data.order_shipping[0]?.address || '',
  detail_address: data.shipping_detail_address || data.order_shipping[0]?.detail_address || '',
  postal_code: data.shipping_postal_code || data.order_shipping[0]?.postal_code || ''
}
```

**커밋**: `536f11d 🐛 fix: 주문 상세 페이지 우편번호 누락 문제 수정`

---

#### 2.3 관리자 주문 리스트 배송비 계산 수정
**문제**: 데스크톱/모바일 뷰 모두 배송비 하드코딩 (4,000원 고정)
**파일**: `app/admin/orders/page.js`

```javascript
// BEFORE (line 416)
const shippingFee = order.status === 'pending' ? 0 : 4000
const correctAmount = itemsTotal + shippingFee

// AFTER
const shippingInfo = formatShippingInfo(
  order.status === 'pending' ? 0 : 4000,
  order.shipping?.postal_code
)
const shippingFee = shippingInfo.totalShipping
const correctAmount = itemsTotal + shippingFee
```

**적용 위치**:
- 데스크톱 테이블 뷰 (line 412-425)
- 모바일 카드 뷰 (line 548-554)

**결과**: 제주 우편번호 63534 → ₩130,000 정확히 표시 (₩127,000 → ✅)

**커밋**: `7d3c4a0 🐛 fix: 관리자 주문 리스트 도서산간 배송비 계산 누락 수정`

---

## 📊 데이터 흐름 개선

### 우편번호 전체 흐름도

```
사용자 입력 (마이페이지)
    ↓
profiles.postal_code 저장
    ↓
체크아웃 페이지 로드
    ↓
formatShippingInfo(4000, postal_code) 호출
    ↓
도서산간 여부 판별
- 제주: 63000-63644 → +3000원
- 울릉도: 40200-40240 → +5000원
- 기타 도서산간: +5000원
    ↓
주문 생성 (order_shipping.postal_code 저장)
    ↓
주문 상세 / 관리자 페이지
    ↓
shipping.postal_code로 배송비 재계산
    ↓
정확한 금액 표시
```

---

## 🔧 기술 세부사항

### 1. formatShippingInfo 함수 구조
**파일**: `lib/shippingUtils.js`

```javascript
export function formatShippingInfo(baseShipping, postalCode) {
  // 기본 배송비
  let totalShipping = baseShipping
  let surcharge = 0
  let region = null
  let isRemote = false

  if (postalCode) {
    const code = parseInt(postalCode, 10)

    // 제주도: 63000-63644
    if (code >= 63000 && code <= 63644) {
      surcharge = 3000
      region = '제주'
      isRemote = true
    }
    // 울릉도: 40200-40240
    else if (code >= 40200 && code <= 40240) {
      surcharge = 5000
      region = '울릉도'
      isRemote = true
    }
    // 기타 도서산간
    else if (isRemoteArea(code)) {
      surcharge = 5000
      region = '도서산간'
      isRemote = true
    }
  }

  totalShipping += surcharge

  return {
    baseShipping,
    surcharge,
    totalShipping,
    region,
    isRemote
  }
}
```

---

### 2. 모든 페이지에서의 사용 패턴

#### 체크아웃 페이지
```javascript
const shippingInfo = formatShippingInfo(4000, userProfile.postal_code)
console.log('배송비:', {
  기본: shippingInfo.baseShipping,
  추가: shippingInfo.surcharge,
  총액: shippingInfo.totalShipping,
  지역: shippingInfo.region
})
```

#### 주문 상세 페이지
```javascript
const shippingInfo = formatShippingInfo(4000, orderData.shipping?.postal_code)
const shippingFee = shippingInfo.totalShipping
```

#### 관리자 페이지
```javascript
const shippingInfo = formatShippingInfo(
  order.status === 'pending' ? 0 : 4000,
  order.shipping?.postal_code
)
```

---

## 🎯 테스트 케이스

### 1. 제주 우편번호 테스트
```
입력: postal_code = '63534'
계산: baseShipping(4000) + surcharge(3000) = 7000
결과: ✅ 모든 페이지에서 ₩7,000 표시
```

### 2. 울릉도 우편번호 테스트
```
입력: postal_code = '40220'
계산: baseShipping(4000) + surcharge(5000) = 9000
결과: ✅ 모든 페이지에서 ₩9,000 표시
```

### 3. 일반 지역 테스트
```
입력: postal_code = '06035' (서울 강남)
계산: baseShipping(4000) + surcharge(0) = 4000
결과: ✅ 모든 페이지에서 ₩4,000 표시
```

---

## 📈 성능 및 안정성

### 빌드 결과
```
✓ Compiled successfully in 2.5s
✓ Generating static pages (82/82)
Route (app)                    Size    First Load JS
├ ○ /checkout                  11.1 kB    216 kB
├ ○ /orders                    13.7 kB    214 kB
├ ƒ /orders/[id]/complete      7.65 kB    196 kB
├ ○ /admin/orders              6.36 kB    201 kB
├ ƒ /admin/orders/[id]         5.92 kB    149 kB
├ ○ /admin/shipping            7.81 kB    190 kB
```

**경고**: ESLint 경고 19개 (기존과 동일, 기능적 문제 없음)

---

## 📝 커밋 히스토리

1. **0505e73** - 🐛 fix: 모바일 브라우저 입력 필드 텍스트 가시성 문제 수정
2. **18c3e77** - 🐛 fix: 마이페이지 주소 관리 구버전 → 신버전 완전 전환
3. **833c932** - ✨ feat: 모든 주소 표시 페이지에 우편번호 추가
4. **536f11d** - 🐛 fix: 주문 상세 페이지 우편번호 누락 문제 수정
5. **7d3c4a0** - 🐛 fix: 관리자 주문 리스트 도서산간 배송비 계산 누락 수정

---

## 🔄 영향받은 파일

### 프론트엔드
- `app/globals.css` - 모바일 입력 필드 가시성 전면 개선
- `app/mypage/page.js` - AddressManager 업그레이드
- `app/checkout/page.js` - 우편번호 로드 및 배송비 계산
- `app/orders/page.js` - 그룹 주문 모달 우편번호 표시
- `app/orders/[id]/complete/page.js` - 배송지 우편번호 표시
- `app/admin/orders/page.js` - 배송비 계산 로직 수정
- `app/admin/orders/[id]/page.js` - 우편번호 표시
- `app/admin/shipping/page.js` - 테이블/모바일/CSV 우편번호 추가
- `app/components/product/BuyBottomSheet.jsx` - 프로필 우편번호 로드

### 백엔드
- `lib/supabaseApi.js` - getOrderById 함수 shipping 객체에 postal_code 추가

### 데이터베이스
- `profiles` 테이블 - postal_code 컬럼 추가

---

## 🎓 학습 포인트

### 1. CSS 모바일 호환성
- `-webkit-text-fill-color` 속성이 모바일 브라우저에서 매우 중요
- `appearance: none`은 라디오/체크박스에 치명적
- `!important` 사용이 정당화되는 케이스

### 2. 데이터 구조 일관성
- 같은 데이터(shipping)를 여러 형태로 반환하면 버그 발생
- `getOrderById()` 같은 핵심 함수는 모든 필드를 일관되게 반환해야 함
- 옵셔널 체이닝(`?.`)으로 안전하게 접근

### 3. 컴포넌트 버전 관리
- 구버전 컴포넌트가 남아있으면 혼란 유발
- 사용하지 않는 파일은 명확히 표시 또는 삭제
- import 경로를 신중하게 관리

---

## ✅ 완료 체크리스트

- [x] profiles 테이블에 postal_code 컬럼 추가
- [x] 모든 주소 입력 폼에서 우편번호 수집
- [x] 체크아웃 페이지 배송비 계산 로직 수정
- [x] 주문 생성 시 postal_code 저장
- [x] 주문 상세 페이지 우편번호 표시 및 배송비 계산
- [x] 관리자 주문 리스트 배송비 계산 수정
- [x] 관리자 주문 상세 우편번호 표시
- [x] 관리자 발송 관리 우편번호 표시
- [x] CSV 송장 다운로드에 우편번호 포함
- [x] 모바일 입력 필드 가시성 문제 해결
- [x] 라디오 버튼 보이지 않는 문제 해결
- [x] MyPage AddressManager 업그레이드
- [x] 빌드 및 배포 성공

---

## 🚀 다음 작업 권장사항

1. **주문 생성 최적화**
   - 현재 여러 함수로 분산된 주문 생성 로직 통합
   - `createOrder`, `createOrderWithOptions`, `createOrderKakao` 통합 검토

2. **주소 관리 시스템 단순화**
   - `addresses` JSONB vs 개별 컬럼(`address`, `detail_address`, `postal_code`) 중복 정리
   - 단일 소스 오브 트루스(Single Source of Truth) 확립

3. **배송비 로직 테스트 자동화**
   - 우편번호별 배송비 계산 단위 테스트 작성
   - Edge case 처리 강화 (잘못된 우편번호, null 값 등)

4. **문서 업데이트**
   - DB_REFERENCE_GUIDE.md에 postal_code 필드 추가
   - DETAILED_DATA_FLOW.md에 배송비 계산 흐름 추가

---

**작성자**: Claude Code
**작성일**: 2025-10-03
**작업 시간**: 약 3시간
**커밋 수**: 5개
**배포 상태**: ✅ Vercel 프로덕션 배포 완료
