# 작업 로그 - 2025-10-29

## 📋 작업 개요
- **작업 시간**: 2025-10-29
- **작업자**: Claude + 사용자
- **주요 작업**: 일괄결제 주문 UI 그룹핑 구현

---

## ✅ 완료된 작업

### 1. 관리자 주문 상세 페이지 버그 수정 ⭐⭐⭐
**문제**: 일괄결제 그룹 중 1건만 "입금 확인" 시 나머지 주문은 verifying 상태로 남음

**해결**:
- `/app/api/admin/orders/route.js`: paymentGroupId 필터 추가 (Line 16, 102-105)
- `/app/admin/orders/[id]/page.js`: updateOrderStatus 완전 재작성 (Line 111-153)
  - payment_group_id 감지
  - 같은 그룹 모든 주문 조회 (API 호출)
  - Promise.all()로 그룹 전체 상태 업데이트

**커밋**: `f36734f`, `969d530`

---

### 2. 주문 목록 페이지 그룹핑 UI 구현 ⭐⭐⭐

#### 2.1. OrderCard 그룹 모드 추가
**파일**: `/app/components/orders/OrderCard.jsx`

**변경사항**:
- `isGroup` prop 추가 (Line 40, 50)
- `originalOrders` prop 추가 (Line 41, 51)
- 그룹 모드 UI 렌더링 (Line 92-171)
  ```jsx
  {/* 그룹 헤더 */}
  <span className="...">
    ✨ 일괄결제 {bulkPaymentInfo.groupOrderCount}건
  </span>

  {/* 그룹 금액 정보 */}
  <div>
    <span>총 입금금액</span>
    <span>₩{bulkPaymentInfo.groupTotalAmount?.toLocaleString()}</span>
  </div>
  ```

#### 2.2. useOrdersInit 그룹핑 로직 추가
**파일**: `/app/hooks/useOrdersInit.js`

**변경사항**:
- `groupOrdersByPaymentGroupId` 함수 추가 (Line 30-104)
- 4곳에서 그룹핑 적용:
  - Line 226-228: loadOrdersDataFast
  - Line 279-280: refreshOrders
  - Line 338-339: handleTabChange
  - Line 395-396: handlePageChange

**로직**:
1. payment_group_id로 그룹 분류
2. 대표 주문 선택 (bulkPaymentInfo.isRepresentativeOrder)
3. 그룹 카드 생성:
   ```javascript
   {
     ...representativeOrder,
     isGroup: true,
     originalOrders: groupOrders,
     groupOrderCount: groupOrders.length,
     totalAmount: groupTotalAmount
   }
   ```

#### 2.3. orders/page.js Props 전달
**파일**: `/app/orders/page.js`

**변경사항** (Line 129-130):
```javascript
<OrderCard
  isGroup={order.isGroup || false}
  originalOrders={order.originalOrders || []}
/>
```

**커밋**: `f36734f`, `73bc748`

---

### 3. 주문 상세 페이지 그룹 내 모든 상품 표시 ⭐⭐⭐

**문제**: 일괄결제 12건 카드 클릭 → 주문 상세에서 1건 상품만 표시

**해결**:

#### 3.1. 그룹 주문 조회 로직 추가
**파일**: `/app/orders/[id]/complete/page.js` (Line 133-166)

```javascript
if (order.payment_group_id) {
  // 같은 그룹의 모든 주문 조회
  const groupResponse = await fetch('/api/orders/list', {
    method: 'POST',
    body: JSON.stringify({
      user: currentUser,
      page: 1,
      pageSize: 100,
      status: 'all'
    })
  })

  const groupOrders = groupResult.orders.filter(
    o => o.payment_group_id === order.payment_group_id
  )

  order.groupedOrders = groupOrders  // ⭐ 추가
}
```

#### 3.2. 주문별 상품 리스팅 UI 구현
**파일**: `/app/orders/[id]/complete/page.js` (Line 969-1059)

```javascript
if (orderData.groupedOrders && orderData.groupedOrders.length > 1) {
  return (
    <div>
      <h2>주문 상품 ({orderData.groupedOrders.length}개 주문, 총 {totalProductCount}개)</h2>
      {orderData.groupedOrders.map((groupOrder, orderIndex) => (
        <div key={groupOrder.id} className="border-l-4 border-blue-400 pl-3">
          {/* 주문 헤더 */}
          <h3>주문 #{orderIndex + 1}</h3>
          <span>{groupOrder.customer_order_number}</span>

          {/* 주문 내 상품들 */}
          {groupOrder.items.map(item => (...))}
        </div>
      ))}
    </div>
  )
}
```

**UI 특징**:
- 파란색 구분선 (border-l-4 border-blue-400)
- 각 주문마다 "주문 #N" 헤더
- 주문번호(customer_order_number) 표시

**커밋**: `969d530`

---

### 4. 페이지네이션 개수 불일치 수정 ⭐⭐

**문제**: 13건 주문 → 2개 카드 (그룹핑) → 페이지네이션 2페이지 표시 (불필요)

**해결**: `/app/orders/page.js` (Line 136-144)

```javascript
{/* 페이지네이션 - 그룹핑 후 카드가 10개 초과일 때만 표시 */}
{orders.length > 10 && (
  <Pagination ... />
)}
```

**커밋**: `6643c8d`

---

## 🐛 발견된 문제 (내일 작업 예정)

### 문제: 탭 숫자와 카드 개수 불일치 ⭐⭐⭐

**현상**:
- **탭 표시**: "결제 확인중 (13)", "결제완료 (110)"
- **실제 카드**:
  - 결제 확인중: 일괄결제 12건 카드 1개만 보임 (1건 누락?)
  - 결제완료: 일괄결제 11건 + 일괄결제 3건 = 2개 카드 (나머지 96건 어디?)

**원인 분석**:
1. **탭 숫자**: 그룹핑 **전** 원본 주문 개수 (statusCounts)
2. **카드 표시**: 그룹핑 **후** 카드 개수
3. **불일치**: statusCounts가 그룹핑을 반영하지 않음

**예시**:
```
원본 주문:
- verifying: 13건 (payment_group_id: GROUP-A 12건 + null 1건)
- paid: 110건 (payment_group_id: GROUP-B 11건 + GROUP-C 3건 + ...)

그룹핑 후:
- verifying: 2개 카드 (GROUP-A 카드 1개 + 개별 카드 1개)
- paid: ? 개 카드 (GROUP-B 카드 + GROUP-C 카드 + ...)

탭 표시:
- "결제 확인중 (13)" ← 원본 주문 개수
- "결제완료 (110)" ← 원본 주문 개수
```

**해결 방안**:

#### Option A: 탭 숫자를 카드 개수로 변경
```javascript
// statusCounts를 그룹핑 후 카드 개수로 재계산
const groupedStatusCounts = {
  pending: groupedOrders.filter(o => o.status === 'pending').length,
  verifying: groupedOrders.filter(o => o.status === 'verifying').length,
  ...
}
```

#### Option B: 탭 숫자 표시 방식 변경
```
"결제 확인중 (2)" ← 카드 개수
"결제 확인중 (13건)" ← 원본 주문 개수
"결제 확인중 2개 (총 13건)" ← 둘 다 표시
```

#### Option C: 카드 내부에 "총 XX건 중 YY건" 표시
```
┌─────────────────────────┐
│ ✨ 일괄결제 12건        │
│ 총 입금금액: ₩276,000   │
│ (verifying 탭 총 13건 중)│
└─────────────────────────┘
```

**권장**: Option B ("결제 확인중 2개 (총 13건)")
- 사용자에게 가장 명확
- 그룹핑 전후 개수 모두 표시
- 혼란 최소화

**영향 파일**:
- `/app/hooks/useOrdersInit.js` - statusCounts 계산 로직
- `/app/components/orders/OrderFilter.jsx` - 탭 표시 UI

**우선순위**: ⭐⭐⭐ (High) - 사용자 혼란 야기

---

## 📝 커밋 내역

```bash
f36734f feat: 일괄결제 주문 UI 그룹핑 구현 + 관리자 그룹 업데이트 수정
73bc748 debug: 그룹핑 로직 디버그 로그 추가
969d530 feat: 주문 상세 페이지 일괄결제 그룹 내 모든 상품 표시
6643c8d fix: 그룹핑 후 페이지네이션 개수 불일치 수정
```

---

## 🎯 내일 작업 계획

### 1. 탭 숫자와 카드 개수 불일치 수정 (최우선)
- [ ] useOrdersInit.js: statusCounts 재계산 로직 추가
- [ ] OrderFilter.jsx: 탭 표시 UI 변경
- [ ] 테스트: 모든 탭에서 숫자 정확성 확인

### 2. 주문 상세 페이지 테스트 (검증)
- [ ] 일괄결제 12건 카드 클릭 → 모든 상품 표시 확인
- [ ] 주문별 구분선 및 "주문 #N" 표시 확인
- [ ] 콘솔 로그 확인:
  ```
  🔍 [주문 상세] 일괄결제 그룹 발견: GROUP-XXX
  ✅ [주문 상세] 그룹 주문 12건 조회 완료
  ```

### 3. 그룹핑 로직 디버그 로그 제거 (정리)
- [ ] useOrdersInit.js: console.log 제거 (프로덕션 불필요)
- [ ] complete/page.js: console.log 제거

### 4. 문서 업데이트
- [ ] SYSTEM_DEPENDENCY_COMPLETE_PART4.md: orders/page.js 업데이트
- [ ] FUNCTION_QUERY_REFERENCE_PART2.md: groupOrdersByPaymentGroupId 추가

---

## 💡 개선 아이디어

### 1. 그룹 카드 클릭 동작 개선
**현재**: 그룹 카드 클릭 → 모달 표시
**제안**: 그룹 카드 클릭 → 주문 상세 페이지 (그룹 내 모든 상품 표시)

**장점**:
- 모달 없이 전체 화면 활용
- 페이지 전환으로 명확한 네비게이션
- 뒤로가기 버튼으로 쉬운 복귀

**단점**:
- 모달보다 무거움 (페이지 전환)

### 2. 페이지네이션 기준 변경
**현재**: 원본 주문 개수 기준 (110건 → 11페이지)
**제안**: 그룹핑 후 카드 개수 기준 (2개 → 1페이지)

**영향**:
- 백엔드 페이지네이션 수정 필요
- 또는 클라이언트 사이드 페이지네이션 구현

---

## 🔗 관련 파일

### 수정된 파일:
- `/app/api/admin/orders/route.js`
- `/app/admin/orders/[id]/page.js`
- `/app/components/orders/OrderCard.jsx`
- `/app/hooks/useOrdersInit.js`
- `/app/orders/page.js`
- `/app/orders/[id]/complete/page.js`

### 참조 문서:
- `CODING_RULES.md` - Rule #0: Clean Architecture
- `CLAUDE.md` - Rule #0-A: 버그 수정 8-Stage Process
- `SYSTEM_DEPENDENCY_COMPLETE_PART4.md` - orders/page.js 종속성
