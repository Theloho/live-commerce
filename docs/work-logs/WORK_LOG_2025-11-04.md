# 📝 작업 로그 - 2025-11-04

**작업 시간**: 약 2시간
**주요 성과**: Bug #22 완전 해결 (addresses JSONB 컬럼 재생성)

---

## 🎯 세션 1: Bug #22 (4차 재발) - addresses 컬럼 완전 해결

### 문제 상황
- **증상**: 마이페이지에서 주소 저장 시 에러
- **에러 메시지**: `"Could not find the 'addresses' column of 'profiles' in the schema cache"`
- **재현**: 마이페이지 → 배송지 추가 → 저장 버튼 클릭

### 시도한 해결 방법 (모두 실패)

**1차 시도 (Commit cfc5b82)**:
```javascript
// ❌ 실패: supabaseAdmin import 변경
import { supabaseAdmin } from '@/lib/supabaseAdmin'
```

**2차 시도 (Commit 7ff9cbc)**:
```javascript
// ❌ 실패: upsert → update 변경
const { data, error } = await supabaseAdmin
  .from('profiles')
  .update(updateData)
  .eq('id', userId)
```

**3차 시도 (Commit 13a700d)**:
```javascript
// ❌ 실패: 어제 작동하던 버전(3a1000a)으로 복원
// inline createClient() 사용
const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
)
```

### 근본 원인 발견 과정

**Step 1**: 사용자 요청
> "오늘 이상해진거니 어제 소스를 확인할수있으면 확인해봐 오늘 너무 소스가 꼬여버렸어"

**Step 2**: Git 히스토리 분석
- 모든 시도가 오늘(11-04) 또는 최근 며칠 내 변경
- 실제로 "작동하던 버전"은 없었음

**Step 3**: DB 구조 의심
- 사용자: "디비 컬럼이 변했네 원래 addresses가 따로 있었고 Json형태로 저장됐었는데"
- 중요한 발견: **DB 스키마부터 확인했어야 함!**

**Step 4**: 실제 DB 확인
```bash
curl https://allok.shop/api/admin/check-db-schema
```

결과:
```json
{
  "profilesHasAddressesColumn": false,  // ⚠️ 컬럼이 아예 없음!
  "addressesTableExists": false
}
```

### 근본 원인
- **`profiles.addresses` JSONB 컬럼이 DB에서 완전히 사라짐**
- 스키마 캐시 문제가 아니라 **컬럼 자체가 존재하지 않았음**
- 모든 코드베이스는 이 컬럼을 사용하도록 작성됨 (50+ 파일)

### 해결책

**마이그레이션 SQL 실행** (Supabase SQL Editor):
```sql
-- addresses JSONB 컬럼 추가
ALTER TABLE profiles
ADD COLUMN IF NOT EXISTS addresses JSONB DEFAULT '[]'::jsonb;

-- 컬럼 설명 추가
COMMENT ON COLUMN profiles.addresses IS 'Array of address objects: [{id, label, address, detail_address, postal_code, is_default, created_at}]';

-- GIN 인덱스 생성 (JSONB 쿼리 성능 향상)
CREATE INDEX IF NOT EXISTS idx_profiles_addresses ON profiles USING GIN (addresses);
```

**결과**: `Success. No rows returned`

### 검증
- ✅ 마이페이스 주소 추가 즉시 작동
- ✅ "주소 저장에 실패했습니다" 에러 사라짐
- ✅ addresses JSONB 배열에 정상 저장

### 영향받는 파일
- `/app/api/profile/complete/route.js` (원래 코드 그대로 사용 가능)
- `/app/components/mypage/AddressSection.jsx`
- `/app/components/address/AddressManager.jsx`
- 총 50+ 파일이 `profiles.addresses` 의존

### 커밋
- `90c3139`: Bug #22 완전 해결 - addresses JSONB 컬럼 재생성
- `bac21d5`: debug API 추가 (check-db-schema, migrate-addresses-column)

---

## 📚 Rule #0-A 개선: DB 확인 단계 추가

### 배경
- **문제**: "column not found" 에러를 보고 문서만 확인
- **실수**: 실제 DB에 컬럼이 있는지 확인 안 함
- **결과**: 3번의 잘못된 수정 시도 (2시간 낭비)

### 개선 내용

**BUG_FIX_WORKFLOW.md** 업데이트:

**Stage 1 체크리스트에 추가**:
```
□ **DB 스키마 확인 (DB 버그인 경우)**:
  - "column not found" 에러? → DB에 컬럼이 실제로 있는지 확인!
  - /api/admin/check-db-schema 실행
  - DB_REFERENCE_GUIDE.md와 실제 DB 비교
```

**Stage 2 체크리스트에 추가**:
```
□ **DB 버그인 경우 필수**:
  1. DB_REFERENCE_GUIDE.md에서 테이블 스키마 확인
  2. /api/admin/check-db-schema로 실제 DB 확인
  3. 문서 스키마 vs 실제 DB 비교
  4. 컬럼이 없으면 마이그레이션 필요!
```

### 새로운 원칙
```
버그 수정 시 필수 확인:
1. ✅ 소스코드
2. ✅ 문서
3. ✅ **DB 스키마** ← 오늘 추가!
```

### 커밋
- `3c8c3d6`: Rule #0-A에 DB 스키마 확인 단계 추가

---

## 🎉 오늘의 성과

### 해결된 버그
1. **Bug #22 (4차 재발)**: addresses 컬럼 완전 해결
   - 소요 시간: 약 2시간
   - 근본 원인: DB 컬럼 누락
   - 해결 방법: SQL 마이그레이션

### 개선된 프로세스
1. **Rule #0-A 강화**: DB 스키마 확인 단계 추가
2. **디버그 도구 추가**: `/api/admin/check-db-schema` API
3. **마이그레이션 가이드**: `/api/admin/migrate-addresses-column` API

### 생성된 파일
- `/app/api/admin/check-db-schema/route.js` - DB 스키마 상태 확인
- `/app/api/admin/migrate-addresses-column/route.js` - 마이그레이션 가이드

### 문서 업데이트
- `docs/guidelines/BUG_FIX_WORKFLOW.md` - DB 확인 단계 추가

---

## 🔍 교훈

### 잘한 점
1. ✅ 사용자 피드백 수용 ("어제 소스 확인해봐")
2. ✅ Git 히스토리 분석으로 패턴 발견
3. ✅ 실제 DB 확인 API 생성
4. ✅ 근본 원인 발견 후 즉시 해결

### 개선할 점
1. ❌ **처음부터 DB 확인했어야 함!**
   - "column not found" = DB 확인이 최우선
   - 문서만 보고 가정하면 안 됨
2. ❌ 3번의 잘못된 시도 (API 레벨 수정)
   - 근본 원인(컬럼 누락)을 놓침

### 앞으로의 원칙
```
"column not found" 에러 발생 시:
1. DB_REFERENCE_GUIDE.md 확인
2. /api/admin/check-db-schema 실행
3. 문서 vs 실제 DB 비교
4. 차이 발견 → 마이그레이션
5. 차이 없음 → 다른 원인 분석
```

---

## 📊 통계

### 시간 분석
- 잘못된 시도: 1.5시간 (3번의 수정)
- 근본 원인 발견: 20분
- 해결 및 검증: 10분
- **총 소요 시간**: 약 2시간

### 커밋 분석
- 실패한 커밋: 3개 (cfc5b82, 7ff9cbc, 13a700d)
- 성공한 커밋: 2개 (90c3139, 3c8c3d6)
- 디버그 커밋: 1개 (bac21d5)

### Rule #0-A 준수율
- Stage 0 (아키텍처 체크): ✅ 완료
- Stage 1 (버그 현상 파악): ✅ 완료
- Stage 2 (문서 확인): ⚠️ **DB 확인 누락** (오늘 개선됨)
- Stage 3 (소스코드 확인): ✅ 완료
- Stage 4 (영향도 분석): ✅ 완료
- Stage 5 (수정 + 검증): ✅ 완료

---

## 🚀 다음 작업 (내일)

### 미해결 이슈
1. **Bug #19**: 회원가입 쿠폰 자동 배포
   - API 생성됨: `/api/admin/test-welcome-coupon`
   - 테스트 연기됨 (사용자 요청)

### 개선 작업
1. ✅ addresses 컬럼 마이그레이션 완료
2. ✅ Rule #0-A DB 확인 단계 추가 완료
3. 🔜 다른 JSONB 컬럼들도 확인 필요?

---

**작업 종료 시간**: 2025-11-04
**다음 세션 시작 전 확인사항**:
- ✅ addresses 컬럼 정상 작동
- ✅ Rule #0-A 업데이트 완료
- ✅ 마이페이지 주소 저장 정상
