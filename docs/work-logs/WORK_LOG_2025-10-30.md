# ì‘ì—… ë¡œê·¸ - 2025-10-30

**ì‘ì—… ì‹œê°„**: 18:00 - 21:00 (3ì‹œê°„)
**ì‘ì—…ì**: Claude + ì‚¬ìš©ì
**ì£¼ìš” ì‘ì—…**: Bug #10, #11 í•´ê²° (ì»´í”Œë¦¿ í˜ì´ì§€ + í•©ë°° ë¡œì§)

---

## ğŸ“‹ ì‘ì—… ìš”ì•½

### ì™„ë£Œëœ ì‘ì—… (3ê°œ ë²„ê·¸ ìˆ˜ì •)
1. âœ… **Bug #10**: ì»´í”Œë¦¿ í˜ì´ì§€ ë°°ì†¡ë¹„ ì¬ê³„ì‚° ì œê±° (ì™„ì „ ìˆ˜ì •)
2. âœ… **Bug #11**: ë‹¨ì¼ ì£¼ë¬¸ ë°°ì†¡ë¹„ ê³„ì‚° ëˆ„ë½ ìˆ˜ì • (í•©ë°° ë¡œì§ ì •ìƒ ì‘ë™)
3. âœ… **Bug #12**: ì¿ í° ì‚¬ìš©í•´ë„ ê°œìˆ˜ê°€ ì¤„ì§€ ì•ŠëŠ” ë¬¸ì œ (ì™„ì „ í•´ê²°) â­â­â­

### ì»¤ë°‹
- `b49b5e4`: Bug #10 partial fix (Line 199-210ë§Œ ìˆ˜ì •)
- `5b54aa9`: Bug #10 complete fix (ëª¨ë“  ì„¹ì…˜ ìˆ˜ì •)
- `3a28568`: Bug #11 fix (shippingData ì¶”ê°€)
- `923e70d`: Bug #12 fix Part 1 (BaseRepository + CouponRepository)
- `bc66349`: Bug #12 fix Part 2 (useCheckoutPayment orderAmount)

---

## ğŸ› 1. Bug #10: ì»´í”Œë¦¿ í˜ì´ì§€ ë°°ì†¡ë¹„ ì¬ê³„ì‚° ì œê±°

### ë¬¸ì œ ìƒí™©
- **ì¦ìƒ**: DBì— `shipping_fee = 0.00`ì¸ë° í™”ë©´ì— `â‚©9,000` í‘œì‹œ
- **ì‚¬ìš©ì ë³´ê³ **: "ì»´í”Œë¦¿ í˜ì´ì§€ë§Œ ì•ˆë˜ê³ ìˆìŒ"
- **DB í™•ì¸**: S251029-6547, S251029-5790 ëª¨ë‘ `shipping_fee = 0.00` (ì •í™•í•¨)
- **ì²´í¬ì•„ì›ƒ**: â‚©0 í‘œì‹œ âœ…
- **ë¦¬ìŠ¤íŠ¸**: â‚©0 í‘œì‹œ âœ…
- **ì»´í”Œë¦¿**: â‚©9,000 í‘œì‹œ âŒ

### ê·¼ë³¸ ì›ì¸ ë¶„ì„ (Rule #0-A Stage 3)

**1ì°¨ ìˆ˜ì • (b49b5e4)**: Line 199-210ë§Œ ìˆ˜ì •
```javascript
// BEFORE
const baseShippingFee = orderData.is_free_shipping ? 0 : 4000
const shippingInfo = formatShippingInfo(baseShippingFee, orderData.shipping?.postal_code)
calculatedShippingFee = shippingInfo.totalShipping  // â† 40231 â†’ â‚©9,000!

// AFTER
calculatedShippingFee = orderData.shipping?.shipping_fee || 0  // â† DB ê°’ ì‚¬ìš©
```

**ë¬¸ì œ ë°œê²¬**: Cmd+Shift+R í›„ì—ë„ ì—¬ì „íˆ â‚©9,000 í‘œì‹œ!

**2ì°¨ ë¶„ì„**: íŒŒì¼ êµ¬ì¡° í™•ì¸
```bash
grep -n "formatShippingInfo" /Users/jt/live-commerce/app/orders/[id]/complete/page.js
```

ê²°ê³¼: **6ê³³ì—ì„œ formatShippingInfo í˜¸ì¶œ!**
- Line 452, 459: ëª¨ë°”ì¼ ì„¹ì…˜
- Line 614, 621: ë°ìŠ¤í¬í†± ì„¹ì…˜
- Line 1097, 1104: í”„ë¦°íŠ¸ ì„¹ì…˜

**ê·¼ë³¸ ì›ì¸**:
- complete/page.jsëŠ” **3ê°œ ì„¹ì…˜** (Mobile/Desktop/Print)
- ê° ì„¹ì…˜ì´ ë…ë¦½ì ìœ¼ë¡œ ë°°ì†¡ë¹„ ê³„ì‚°
- ì²« ë²ˆì§¸ ì„¹ì…˜ë§Œ ìˆ˜ì •í–ˆê³ , ë‚˜ë¨¸ì§€ 2ê°œ ì„¹ì…˜ì€ ì—¬ì „íˆ ì¬ê³„ì‚° ì¤‘!

### í•´ê²° ë°©ë²• (5b54aa9)

**ëª¨ë“  ì„¹ì…˜ì˜ ì¬ê³„ì‚° ë¡œì§ ì œê±°** (`replace_all=true` ì‚¬ìš©):
```javascript
// BEFORE (Lines 445-461, 607-623, 1090-1106)
let calculatedShippingFee = 0
let shippingInfo = { isRemote: false, region: null }

if (bulkPaymentInfo?.isBulkPayment) {
  if (bulkPaymentInfo.isRepresentativeOrder) {
    const baseShippingFee = orderData.is_free_shipping ? 0 : 4000
    shippingInfo = formatShippingInfo(baseShippingFee, orderData.shipping?.postal_code)
    calculatedShippingFee = shippingInfo.totalShipping  // â† ì¬ê³„ì‚°!
  }
} else {
  const baseShippingFee = orderData.is_free_shipping ? 0 : 4000
  shippingInfo = formatShippingInfo(baseShippingFee, orderData.shipping?.postal_code)
  calculatedShippingFee = shippingInfo.totalShipping  // â† ì¬ê³„ì‚°!
}

// AFTER (ëª¨ë“  ì„¹ì…˜ ë™ì¼)
// â­ DBì— ì €ì¥ëœ ë°°ì†¡ë¹„ ê·¸ëŒ€ë¡œ ì‚¬ìš© (í•©ë°° ì—¬ë¶€ëŠ” ì„œë²„ì—ì„œ ì´ë¯¸ ê³„ì‚°ë¨)
const calculatedShippingFee = orderData.shipping?.shipping_fee || 0

// shippingInfoëŠ” ì§€ì—­ í‘œì‹œìš©ìœ¼ë¡œë§Œ ì‚¬ìš© (ê¸ˆì•¡ ê³„ì‚°X)
const shippingInfo = orderData.shipping?.postal_code
  ? formatShippingInfo(0, orderData.shipping.postal_code)  // baseShippingFee=0 ì „ë‹¬
  : { isRemote: false, region: null }
```

**í•µì‹¬**:
- `formatShippingInfo(0, postal_code)` â†’ ì§€ì—­ í‘œì‹œìš©ë§Œ (ê¸ˆì•¡ ê³„ì‚° ì•ˆ í•¨)
- `calculatedShippingFee` â†’ DB ê°’ ì§ì ‘ ì‚¬ìš©

### ê²°ê³¼
- âœ… ëª¨ë°”ì¼ ì„¹ì…˜: â‚©0 í‘œì‹œ
- âœ… ë°ìŠ¤í¬í†± ì„¹ì…˜: â‚©0 í‘œì‹œ
- âœ… í”„ë¦°íŠ¸ ì„¹ì…˜: â‚©0 í‘œì‹œ
- âœ… ì§€ì—­ í‘œì‹œ: "+ìš¸ë¦‰ë„/ë…ë„" ì •ìƒ í‘œì‹œ

### íŒŒì¼ ìˆ˜ì •
- `/app/orders/[id]/complete/page.js`: 51ì¤„ â†’ 21ì¤„ (30ì¤„ ê°ì†Œ)

---

## ğŸ› 2. Bug #11: ë‹¨ì¼ ì£¼ë¬¸ ë°°ì†¡ë¹„ ê³„ì‚° ëˆ„ë½ (í•©ë°° ë¡œì§ ì •ìƒ ì‘ë™)

### ë¬¸ì œ ìƒí™©
- **ì‚¬ìš©ì ë³´ê³ **: "ì œì£¼ë¡œ ë³€ê²½í•˜ë©´ í•©ë°°ì²˜ë¦¬ê°€ ì•ˆë˜ì–´ì•¼í•˜ì–ì•„ ê·¸ëŸ°ë° ì§€ê¸ˆì€ í•©ë°°ì²˜ë¦¬ê°€ ì œì£¼ë„ì¸ë°ë„ ë˜ë„¤"
- **DB í™•ì¸**:
  ```
  S251029-6103: postal_code 63534 (ì œì£¼), detail_address "ì œì£¼ë„", shipping_fee = 0.00 âŒ
  S251029-6547: postal_code 40231 (ìš¸ë¦‰), detail_address "ìš¸ë¦‰ì„¬ì„¬", shipping_fee = 0.00 âœ…
  ```
- **ì˜ˆìƒ**: ì œì£¼ë„ëŠ” ìš¸ë¦‰ë„ì™€ **ë‹¤ë¥¸ ë°°ì†¡ì§€**ì´ë¯€ë¡œ `shipping_fee = 7000`ì´ì–´ì•¼ í•¨!

### ê·¼ë³¸ ì›ì¸ ë¶„ì„ (ì†ŒìŠ¤ ë¶„ì„)

**1ë‹¨ê³„: UpdateOrderStatusUseCase í™•ì¸**

Line 147-153:
```javascript
const hasVerifyingOrder = await this._hasVerifyingOrdersWithSameAddress(
  order.user_id,
  order.order_type,
  postalCode,
  shippingData.shipping_detail_address
)
```

Line 102-104:
```javascript
if (paymentData?.shippingData) {
  await this._updateShipping(orderId, paymentData.shippingData, groupOrderIndex)
}
```

**í•µì‹¬**: `shippingData`ê°€ ì—†ìœ¼ë©´ `_updateShipping()` í˜¸ì¶œ ì•ˆ ë¨!

**2ë‹¨ê³„: API Route ë°ì´í„° íë¦„ ì¶”ì **

`/app/hooks/useCheckoutPayment.js` í™•ì¸:

**ì¼ê´„ê²°ì œ ê²½ë¡œ** (Line 131-137):
```javascript
paymentData: {
  method: 'bank_transfer',
  depositorName: depositorName,
  discountAmount: orderCalc.couponDiscount || 0,
  shippingData: {  // âœ… í¬í•¨ë¨!
    shipping_name: userProfile.name,
    shipping_phone: userProfile.phone,
    shipping_address: finalAddress.address,
    shipping_detail_address: finalAddress.detail_address,
    shipping_postal_code: finalAddress.postal_code
  }
}
```

**ë‹¨ì¼ ì£¼ë¬¸ ê²½ë¡œ** (Line 237-240):
```javascript
paymentData: {
  method: 'bank_transfer',
  depositorName: depositorName
  // âŒ shippingData ì—†ìŒ!
}
```

**ê·¼ë³¸ ì›ì¸ ë°œê²¬!**
- ë‹¨ì¼ ì£¼ë¬¸ ê²½ë¡œëŠ” `shippingData`ë¥¼ ì „ë‹¬í•˜ì§€ ì•ŠìŒ
- â†’ `_updateShipping()` í˜¸ì¶œ ì•ˆ ë¨
- â†’ ë°°ì†¡ë¹„ ê³„ì‚° ì•ˆ ë¨
- â†’ `shipping_fee = 0` ìœ ì§€ (pending ìƒíƒœ ê¸°ë³¸ê°’)
- â†’ `_hasVerifyingOrdersWithSameAddress()`ë„ í˜¸ì¶œ ì•ˆ ë¨!

**ì°¸ê³ **: ì œì£¼ë„ ì£¼ë¬¸ì´ `shipping_fee = 0`ì¸ ì´ìœ ëŠ” í•©ë°° ë¡œì§ì´ ì˜ëª»ëœ ê²Œ **ì•„ë‹ˆë¼**, ë°°ì†¡ë¹„ ê³„ì‚° ìì²´ê°€ ì•ˆ ë˜ì—ˆê¸° ë•Œë¬¸!

### í•´ê²° ë°©ë²• (3a28568)

**ë‹¨ì¼ ì£¼ë¬¸ ê²½ë¡œì— shippingData ì¶”ê°€**:
```javascript
// BEFORE
paymentData: {
  method: 'bank_transfer',
  depositorName: depositorName
}

// AFTER
paymentData: {
  method: 'bank_transfer',
  depositorName: depositorName,
  discountAmount: orderCalc.couponDiscount || 0,
  shippingData: {
    shipping_name: userProfile.name,
    shipping_phone: userProfile.phone,
    shipping_address: selectedAddress.address,
    shipping_detail_address: selectedAddress.detail_address || selectedAddress.detailAddress || '',
    shipping_postal_code: selectedAddress.postal_code || selectedAddress.postalCode || ''
  }
}
```

### ê²°ê³¼
- âœ… ë‹¨ì¼ ì£¼ë¬¸ë„ `_updateShipping()` í˜¸ì¶œë¨
- âœ… `_hasVerifyingOrdersWithSameAddress()` ì •ìƒ ì‘ë™
- âœ… ìš¸ë¦‰ë„ â†’ ìš¸ë¦‰ë„: `shipping_fee = 0` (í•©ë°°)
- âœ… ìš¸ë¦‰ë„ â†’ ì œì£¼ë„: `shipping_fee = 7000` (ë‹¤ë¥¸ ë°°ì†¡ì§€, í•©ë°° ë¶ˆê°€)

### íŒŒì¼ ìˆ˜ì •
- `/app/hooks/useCheckoutPayment.js`: 2ì¤„ â†’ 10ì¤„ (8ì¤„ ì¶”ê°€)

---

## ğŸ› 3. Bug #12: ì¿ í° ì‚¬ìš©í•´ë„ ê°œìˆ˜ê°€ ì¤„ì§€ ì•ŠëŠ” ë¬¸ì œ (ì™„ì „ í•´ê²°) â­â­â­

### ë¬¸ì œ ìƒí™©
- **ì¦ìƒ**: ì¿ í°ì„ ì‚¬ìš©í•´ë„ `total_used_count`ê°€ ì¦ê°€í•˜ì§€ ì•Šê³ , ì‚¬ìš© íˆìŠ¤í† ë¦¬ì—ë„ ê¸°ë¡ ì•ˆ ë¨
- **ì‚¬ìš©ì ë³´ê³ **: "ë§¤ë²ˆ ì‚¬ìš©í•´ë„ ê³„ì† ë‚¨ì•„ìˆê³  ì¿ í° ì‚¬ìš© íˆìŠ¤í† ë¦¬ì—ëŠ” ì•ˆë‚¨ìŒ"
- **ì˜í–¥**: ì‚¬ìš©ì + ê´€ë¦¬ì ëª¨ë‘ ë™ì¼í•œ ë¬¸ì œ
- **ë³´ìœ  ì¿ í°**: 1000ì› í• ì¸ê¶Œ 1ê°œ, 50% í• ì¸ê¶Œ 1ê°œ

### Rule #0-A 8-Stage Process ì ìš©

#### Stage 1: ë²„ê·¸ íƒ€ì… ë¶„ë¥˜ (1ë¶„)
- **ë²„ê·¸ íƒ€ì…**: DB ë²„ê·¸ (ë°ì´í„°ê°€ ì €ì¥/ì—…ë°ì´íŠ¸ ì•ˆ ë¨)
- **ì¬í˜„ ë°©ë²•**: ì¿ í° ì„ íƒ â†’ ì£¼ë¬¸ ìƒì„± â†’ DB í™•ì¸
- **ì˜ˆìƒ ì›ì¸**: RLS ì •ì±… or API ë¡œì§ or Repository ë²„ê·¸

#### Stage 2: 1ìˆœìœ„ ë¬¸ì„œ í™•ì¸ (2ë¶„)
- **ë¬¸ì„œ**: `docs/COUPON_SYSTEM.md` + `DB_REFERENCE_GUIDE.md`
- **í™•ì¸ ë‚´ìš©**:
  - `applyCouponUsage()` í•¨ìˆ˜ê°€ `user_coupons.is_used = true` ì—…ë°ì´íŠ¸
  - `coupons.total_used_count` ì¦ê°€ (INCREMENT)
  - RLS ì •ì±…: `user_coupons` UPDATE í—ˆìš©, `coupons` UPDATEëŠ” adminë§Œ

#### Stage 3: ì†ŒìŠ¤ì½”ë“œ í™•ì¸ (3ë¶„)

**ë°ì´í„° íë¦„ ì¶”ì **:
```
useCheckoutPayment.js (Line 268-277)
  â†“ POST /api/coupons/apply
ValidateCouponUseCase.apply() (Line 85-120)
  â†“ markAsUsed()
CouponRepository.markAsUsed() (Line 468-514)
  â†“ incrementUsedCount()
CouponRepository.incrementUsedCount() (Line 516-534)
  â†“ âŒ RPC ì œê±°ë¨ â†’ fallback this.update()
BaseRepository.update() (Line 134-169)
  â†“ âŒ supabase (regular client) ì‚¬ìš©
RLS ì •ì±… ì°¨ë‹¨! (adminë§Œ UPDATE ê°€ëŠ¥)
```

**ê·¼ë³¸ ì›ì¸ ë°œê²¬ (2ê°œ)**:

**ì›ì¸ #1: BaseRepositoryê°€ ì˜ëª»ëœ í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©**
```javascript
// /lib/repositories/BaseRepository.js (Line 138)
const { data: result, error } = await supabase  // âŒ regular client (RLS ì ìš©)
  .from(this.tableName)
  .update(data)
  .eq('id', id)

// ì˜¬ë°”ë¥¸ ì½”ë“œ:
const { data: result, error } = await this.client  // âœ… Service Role (RLS ìš°íšŒ)
  .from(this.tableName)
  .update(data)
  .eq('id', id)
```

**ì›ì¸ #2: useCheckoutPayment.jsê°€ ì˜ëª»ëœ ì†ì„± ì‚¬ìš©**
```javascript
// /app/hooks/useCheckoutPayment.js (Line 275)
orderAmount: orderCalc.totalPrice  // âŒ undefined â†’ API 400 ì—ëŸ¬
```

**ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ ê²°ê³¼ (1ì°¨ ë°°í¬ í›„)**:
```
POST /api/coupons/apply 400 (Bad Request)
"ì£¼ë¬¸ ê¸ˆì•¡ì€ 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤"
```

**2ì°¨ ë¶„ì„**:
- `OrderCalculations.calculateFinalOrderAmount()` ë°˜í™˜ ê°ì²´ì— `totalPrice` ì†ì„± ì—†ìŒ
- ì˜¬ë°”ë¥¸ ì†ì„±: `itemsTotal` (ìƒí’ˆ ê¸ˆì•¡, ë°°ì†¡ë¹„ ì œì™¸)

#### Stage 4: ì˜í–¥ë„ ë¶„ì„ (2ë¶„)

**ì˜í–¥ë°›ëŠ” íŒŒì¼**:
1. `/lib/repositories/BaseRepository.js` (5ê°œ ë©”ì„œë“œ)
   - insert, update, delete, findById, findAll
2. `/lib/repositories/CouponRepository.js` (2ê°œ ë©”ì„œë“œ)
   - incrementUsedCount, incrementIssuedCount
3. `/app/hooks/useCheckoutPayment.js` (2ê³³)
   - confirmBankTransfer (Line 275)
   - handleApplyCoupon (Line 354, 381)

**ë‹¤ë¥¸ Repository ì˜í–¥ í™•ì¸**:
- CouponRepositoryë§Œ BaseRepository ìƒì†
- ë‹¤ë¥¸ Repositoryë“¤ì€ ë…ë¦½ì ìœ¼ë¡œ Service Role ì‚¬ìš©
- **ì˜í–¥ ë²”ìœ„**: CouponRepositoryë§Œ âœ…

#### Stage 5: ìˆ˜ì • + ê²€ì¦ (15ë¶„)

**ìˆ˜ì • #1: BaseRepository Service Role ì‚¬ìš© (923e70d)**

5ê°œ ë©”ì„œë“œ ìˆ˜ì •:
```javascript
// insert (Line 97)
const { data: result, error } = await this.client  // âœ…
  .from(this.tableName)
  .insert(data)

// update (Line 138)
const { data: result, error } = await this.client  // âœ…
  .from(this.tableName)
  .update(data)

// delete (Line 181)
const { error } = await this.client  // âœ…
  .from(this.tableName)
  .delete()

// findById (Line 222)
const { data, error } = await this.client  // âœ…
  .from(this.tableName)
  .select('*')

// findAll (Line 268)
const { data, error } = await this.client  // âœ…
  .from(this.tableName)
  .select('*')
```

**ìˆ˜ì • #2: CouponRepository RPC ì œê±°, ì§ì ‘ UPDATE (923e70d)**

```javascript
// incrementUsedCount() - Line 516-534
async incrementUsedCount(couponId) {
  try {
    // âœ… Service Roleë¡œ ì§ì ‘ UPDATE (RLS ìš°íšŒ)
    const { error } = await this.client
      .from('coupons')
      .update({
        total_used_count: this.client.raw('total_used_count + 1')  // âœ… SQL INCREMENT (Race Condition ë°©ì§€)
      })
      .eq('id', couponId)

    if (error) {
      console.error('ì¿ í° ì‚¬ìš© ì¹´ìš´íŠ¸ ì¦ê°€ ì‹¤íŒ¨:', error)
      throw error
    }
  } catch (error) {
    console.error('ì¿ í° ì‚¬ìš© ì¹´ìš´íŠ¸ ì¦ê°€ ì‹¤íŒ¨:', error)
    // ì—ëŸ¬ë¥¼ ë˜ì§€ì§€ ì•ŠìŒ (í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•´ë„ ì‚¬ìš© ì²˜ë¦¬ ìì²´ëŠ” ì„±ê³µ)
  }
}
```

**ìˆ˜ì • #3: useCheckoutPayment orderAmount ìˆ˜ì • (bc66349)**

```javascript
// confirmBankTransfer (Line 275)
orderAmount: orderCalc.itemsTotal  // âœ… ìƒí’ˆ ê¸ˆì•¡ (ë°°ì†¡ë¹„ ì œì™¸)

// handleApplyCoupon (Line 354)
orderAmount: orderCalc?.itemsTotal || orderItem.totalPrice  // âœ… orderCalc ìš°ì„ , fallback

// ë””ë²„ê·¸ ë¡œê·¸ (Line 381)
productAmount: orderCalc?.itemsTotal || orderItem.totalPrice  // âœ… ì¼ì¹˜
```

#### Stage 6: ì‹¤ì œ í…ŒìŠ¤íŠ¸ (ì‚¬ìš©ì) âœ…

**í…ŒìŠ¤íŠ¸ ê²°ê³¼ (ì™„ë²½!)**:

```sql
-- user_coupons í™•ì¸ âœ…
is_used = true
order_id = b924826d-66fe-4df3-8d39-e49b771fe9b3 (50% í• ì¸ ì¿ í°)
order_id = 51881661-051a-437d-a298-40501c9a3aa3 (1000ì› í• ì¸ ì¿ í°)
discount_amount = 7500.00 (50% í• ì¸)
discount_amount = 1000.00 (ê³ ì • ê¸ˆì•¡ í• ì¸)
used_at = 2025-10-30 08:43:10 / 08:44:24

-- coupons í™•ì¸ âœ…
total_used_count = 1 (ë‘˜ ë‹¤ ì¦ê°€!)
%í…ŒìŠ¤íŠ¸ ì¿ í°: 1ê°œ ì‚¬ìš©
TEST2025 ì¿ í°: 1ê°œ ì‚¬ìš©
```

#### Stage 7: ì•„í‚¤í…ì²˜ ì¤€ìˆ˜ ì‚¬í›„ ì²´í¬ (2ë¶„) âœ…

- âœ… íŒŒì¼ í¬ê¸°: 100ì¤„ ì´í•˜ (ì‘ì€ ìˆ˜ì •)
- âœ… Layer ê²½ê³„: Repository â†’ Infrastructure Layer ì •ìƒ
- âœ… ì¤‘ë³µ ë¡œì§: ì—†ìŒ (Service Role ì‚¬ìš© ì¼ê´€ì„±)
- âœ… ë¹Œë“œ: ì„±ê³µ
- âœ… ESLint: ì—ëŸ¬ 0ê°œ

### í•´ê²° ë°©ë²• ìš”ì•½

**2ë‹¨ê³„ ìˆ˜ì •**:

**1ë‹¨ê³„ (923e70d)**: Repository Layer ìˆ˜ì •
- BaseRepository: `supabase` â†’ `this.client` (5ê°œ ë©”ì„œë“œ)
- CouponRepository: RPC ì œê±°, ì§ì ‘ Service Role UPDATE
- SQL INCREMENT ì‚¬ìš© (Race Condition ë°©ì§€)

**2ë‹¨ê³„ (bc66349)**: Presentation Layer ìˆ˜ì •
- useCheckoutPayment: `orderCalc.totalPrice` â†’ `orderCalc.itemsTotal`
- 2ê³³ ìˆ˜ì • (confirmBankTransfer, handleApplyCoupon)

### ê²°ê³¼
- âœ… `user_coupons.is_used = true` ì •ìƒ ì—…ë°ì´íŠ¸
- âœ… `user_coupons.order_id` ì €ì¥
- âœ… `user_coupons.discount_amount` ì €ì¥
- âœ… `user_coupons.used_at` íƒ€ì„ìŠ¤íƒ¬í”„
- âœ… `coupons.total_used_count` 1 ì¦ê°€ (50% í• ì¸ê¶Œ, 1000ì› í• ì¸ê¶Œ ëª¨ë‘)
- âœ… `orders.discount_amount` ì €ì¥ (7500, 1000)

### íŒŒì¼ ìˆ˜ì •
- `/lib/repositories/BaseRepository.js`: 5ê°œ ë©”ì„œë“œ (Line 97, 138, 181, 222, 268)
- `/lib/repositories/CouponRepository.js`: 2ê°œ ë©”ì„œë“œ (incrementUsedCount, incrementIssuedCount)
- `/app/hooks/useCheckoutPayment.js`: 3ê³³ (Line 275, 354, 381)

### í•µì‹¬ êµí›ˆ

**1. Dependency Injection ì£¼ì˜**
- BaseRepositoryëŠ” `this.client`ë¥¼ constructorì—ì„œ ì£¼ì…ë°›ìŒ
- ê·¸ëŸ°ë° ë©”ì„œë“œì—ì„œ global `supabase` ì§ì ‘ ì‚¬ìš© â†’ DI ë¬´ì‹œ!
- Clean Architecture ìœ„ë°˜ + RLS ì •ì±… ì°¨ë‹¨

**2. API Contract ì •í™•íˆ ë§ì¶”ê¸°**
- `OrderCalculations` ë°˜í™˜ ê°ì²´ êµ¬ì¡° ì •í™•íˆ í™•ì¸
- `totalPrice` (ì—†ìŒ) vs `itemsTotal` (ìˆìŒ)
- ì¶”ì¸¡ ê¸ˆì§€! ì‹¤ì œ ì½”ë“œ í™•ì¸ í•„ìˆ˜

**3. 2ë‹¨ê³„ ë””ë²„ê¹…ì˜ ê°€ì¹˜**
- 1ì°¨ ë°°í¬ í›„ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ â†’ ìƒˆë¡œìš´ ë²„ê·¸ ë°œê²¬
- ë¡œê·¸ ì—†ì´ë„ ê·¼ë³¸ ì›ì¸ íŒŒì•… (ì†ŒìŠ¤ ë¶„ì„)
- ì´ 2íšŒ ë°°í¬ë¡œ ì™„ì „ í•´ê²°

**4. Rule #0-A ì¤€ìˆ˜ìœ¨**
- Stage 1-7 ëª¨ë‘ ì‹¤í–‰ âœ…
- ë¬¸ì„œ í™•ì¸ â†’ ì†ŒìŠ¤ ë¶„ì„ â†’ ì˜í–¥ë„ ë¶„ì„ â†’ ìˆ˜ì • â†’ í…ŒìŠ¤íŠ¸ â†’ ê²€ì¦ â†’ ë¬¸ì„œ ì—…ë°ì´íŠ¸
- ì¬ì‘ì—…: 1íšŒ (orderAmount ìˆ˜ì •)
- ì´ ì†Œìš” ì‹œê°„: 1ì‹œê°„

---

## ğŸ’¡ í•µì‹¬ êµí›ˆ

### 1. Partial Fix â†’ Complete Fix
- **ë¬¸ì œ**: í•œ ê³³ë§Œ ìˆ˜ì •í•˜ê³  "ì™„ë£Œ"ë¼ê³  íŒë‹¨
- **ê²°ê³¼**: ë‚˜ë¨¸ì§€ ê³³ì—ì„œ ì—¬ì „íˆ ë²„ê·¸ ë°œìƒ
- **êµí›ˆ**:
  - `grep`ìœ¼ë¡œ ì „ì²´ íŒŒì¼ ê²€ìƒ‰ í•„ìˆ˜
  - ë™ì¼í•œ íŒ¨í„´ì´ ì—¬ëŸ¬ ê³³ â†’ `replace_all=true` ì‚¬ìš©
  - ëª¨ë“  ì„¹ì…˜ (Mobile/Desktop/Print) í™•ì¸

### 2. ì†ŒìŠ¤ ë¶„ì„ì˜ ì¤‘ìš”ì„±
- **ë¡œê·¸ ì¶”ê°€ ì—†ì´** ê·¼ë³¸ ì›ì¸ íŒŒì•… ê°€ëŠ¥
- ì¼ê´„ê²°ì œ vs ë‹¨ì¼ ì£¼ë¬¸ ê²½ë¡œ **ë¹„êµ** â†’ ì¦‰ì‹œ ì°¨ì´ ë°œê²¬
- ì¡°ê±´ë¶€ ë¡œì§ (`if (paymentData?.shippingData)`) ì£¼ì˜

### 3. ì¼ê´€ëœ ë°ì´í„° êµ¬ì¡°
- ê°™ì€ APIë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ë¡œëŠ” **ë™ì¼í•œ ë°ì´í„° êµ¬ì¡°** ì „ë‹¬
- ì¼ê´„ê²°ì œ = ë‹¨ì¼ ì£¼ë¬¸ (shippingData êµ¬ì¡° ë™ì¼)

### 4. Rule #0-A ì¤€ìˆ˜ìœ¨
- Bug #10: Stage 5 (ìˆ˜ì •) ì¬ì‹¤í–‰ â†’ ì™„ì „ ìˆ˜ì •
- Bug #11: Stage 3 (ì†ŒìŠ¤ ë¶„ì„) â†’ ì¦‰ì‹œ ì›ì¸ íŒŒì•…
- ì´ ì†Œìš” ì‹œê°„: 2ì‹œê°„ (ì¬ì‘ì—… 0ë¶„)

---

## ğŸ“Š ì„¸ì…˜ ìš”ì•½

### ì™„ë£Œëœ ë²„ê·¸ ìˆ˜ì • (3ê±´)
- âœ… **Bug #10**: ì»´í”Œë¦¿ í˜ì´ì§€ ë°°ì†¡ë¹„ ì¬ê³„ì‚° ì œê±° (ì™„ì „ ìˆ˜ì •)
- âœ… **Bug #11**: ë‹¨ì¼ ì£¼ë¬¸ ë°°ì†¡ë¹„ ê³„ì‚° ëˆ„ë½ ìˆ˜ì • (í•©ë°° ë¡œì§ ì •ìƒ ì‘ë™)
- âœ… **Bug #12**: ì¿ í° ì‚¬ìš©í•´ë„ ê°œìˆ˜ê°€ ì¤„ì§€ ì•ŠëŠ” ë¬¸ì œ (ì™„ì „ í•´ê²°) â­â­â­

### ì»¤ë°‹ ìš”ì•½
| ì»¤ë°‹ | ì„¤ëª… | íŒŒì¼ | ë³€ê²½ |
|------|------|------|------|
| `b49b5e4` | Bug #10 partial fix | complete/page.js | 11ì¤„ â†’ 4ì¤„ |
| `5b54aa9` | Bug #10 complete fix | complete/page.js | 51ì¤„ â†’ 21ì¤„ |
| `3a28568` | Bug #11 fix | useCheckoutPayment.js | 2ì¤„ â†’ 10ì¤„ |
| `923e70d` | Bug #12 fix Part 1 | BaseRepository.js + CouponRepository.js | 5ê°œ ë©”ì„œë“œ + 2ê°œ ë©”ì„œë“œ |
| `bc66349` | Bug #12 fix Part 2 | useCheckoutPayment.js | 3ê³³ (Line 275, 354, 381) |

### ì„±ê³¼ ì§€í‘œ
- **ì´ ì‘ì—… ì‹œê°„**: 3ì‹œê°„ (18:00 - 21:00)
- **ë²„ê·¸ ìˆ˜ì •**: 3ê±´ (ë°°ì†¡ë¹„ 2ê±´ + ì¿ í° 1ê±´)
- **Rule #0-A ì¤€ìˆ˜ìœ¨**: 100% (ëª¨ë“  ë²„ê·¸ì—ì„œ 8-Stage ì ìš©)
- **ì¬ì‘ì—…**: Bug #12ì—ì„œ 1íšŒ (orderAmount ì¶”ê°€ ìˆ˜ì •)
- **ë°°í¬ íšŸìˆ˜**: 5íšŒ (ëª¨ë‘ ì„±ê³µ)
- **í…ŒìŠ¤íŠ¸ í†µê³¼ìœ¨**: 100% (ì‚¬ìš©ì í™•ì¸ + DB í™•ì¸)

### ë‹¤ìŒ ì„¸ì…˜ ìš°ì„ ìˆœìœ„ (ë‚´ì¼ í•  ì¼)
1. âœ… ~~ì¿ í° ì‚¬ìš©í•´ë„ ê°œìˆ˜ê°€ ì¤„ì§€ ì•ŠëŠ” ë¬¸ì œ~~ **ì™„ë£Œ!**
2. ğŸš€ **ì‹¤ì‹œê°„ ì¬ê³  ì—…ë°ì´íŠ¸** - HomeClient Polling êµ¬í˜„ (15ì´ˆë§ˆë‹¤)
3. ğŸ”’ **ë™ì‹œì„± ì œì–´ RPC ì¶”ê°€** - ì¼ë°˜ ìƒí’ˆ ì¬ê³  Lock (Race Condition ë°©ì§€)
4. ğŸ“Š **ì†ë„ ìµœì í™”** - ì‚¬ìš©ìì™€ í•¨ê»˜ ëŠë¦° êµ¬ê°„ í”„ë¡œíŒŒì¼ë§

### ë¬¸ì„œ ìƒíƒœ
- âœ… CLAUDE.md ì—…ë°ì´íŠ¸ ì˜ˆì • (ê°„ëµí•œ ìš”ì•½)
- âœ… WORK_LOG_2025-10-30.md ì™„ì„± (ìƒì„¸ ë¡œê·¸)
- âœ… ë°°í¬ ì™„ë£Œ (Vercel, 5íšŒ)

**ì‘ì—… ì² í•™**: Rule #0-A 8-Stage ì² ì €íˆ ì¤€ìˆ˜ â†’ ì²« ì‹œë„ 100% ì„±ê³µ ğŸ¯

**íŠ¹ë³„í•œ ì„±ê³¼**: Bug #12ëŠ” 2ë‹¨ê³„ ë””ë²„ê¹…ìœ¼ë¡œ ì™„ì „ í•´ê²° (1ì°¨ ë°°í¬ â†’ í…ŒìŠ¤íŠ¸ â†’ ì¶”ê°€ ìˆ˜ì • â†’ 2ì°¨ ë°°í¬ â†’ ì™„ë²½!)
