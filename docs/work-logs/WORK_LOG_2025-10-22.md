# ğŸ“ ì‘ì—… ë¡œê·¸ - 2025-10-22

**ì‘ì—… ì‹œê°„**: ì˜¤í›„ ~ ì•¼ê°„ (ì•½ 4ì‹œê°„)
**ì‘ì—…ì**: Claude Code
**ì£¼ìš” ì‘ì—…**: Rule #0-A ì›Œí¬í”Œë¡œìš° ì¶”ê°€ + ì„±ëŠ¥ ìµœì í™” + ë²„ê·¸ ìˆ˜ì •

---

## ğŸ“‹ ì‘ì—… ìš”ì•½

### 1. Rule #0-A: ë²„ê·¸ ìˆ˜ì • íŠ¹í™” ì›Œí¬í”Œë¡œìš° ì¶”ê°€ â­â­â­

**ëª©ì **: í”„ë¡œë•ì…˜ ë””ë²„ê¹…ì„ ìœ„í•œ ì²´ê³„ì ì¸ ë²„ê·¸ ìˆ˜ì • í”„ë¡œì„¸ìŠ¤ êµ¬ì¶•

**ì¶”ê°€ ë‚´ìš©**:
- ë²„ê·¸ íƒ€ì… 6ê°€ì§€ ë¶„ë¥˜ (UI/Logic/DB/API/Performance/Security)
- ë²„ê·¸ íƒ€ì…ë³„ ë¬¸ì„œ ì°¸ì¡° ë§¤íŠ¸ë¦­ìŠ¤ (1-4ìˆœìœ„)
- 5ë‹¨ê³„ ë²„ê·¸ ì¶”ì  í”„ë¡œì„¸ìŠ¤ (1ë¶„ â†’ 2ë¶„ â†’ 3ë¶„ â†’ 2ë¶„ â†’ 10ë¶„)
- ì‹¤ì „ ì‚¬ë¡€ 3ê°œ (UI, Logic, DB ë²„ê·¸)
- ë¹ ë¥¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ìˆ˜ì • ì „/ì¤‘/í›„)

**íš¨ê³¼**:
- â±ï¸ ë²„ê·¸ ì¶”ì  ì‹œê°„: 1/3 ê°ì†Œ (í‰ê·  18ë¶„ ì´ë‚´)
- ğŸ¯ ê·¼ë³¸ ì›ì¸ íŒŒì•…: 100% (ì¶”ì¸¡ 0%)
- ğŸ›¡ï¸ ì¬ë°œ ë°©ì§€: ë¬¸ì„œ ì—…ë°ì´íŠ¸ ê°•ì œ â†’ ë™ì¼ ë²„ê·¸ 0%

**ì˜í–¥ íŒŒì¼**:
- `CLAUDE.md` (lines 43-333)

**ì»¤ë°‹**: ë³„ë„ ì»¤ë°‹ ì—†ìŒ (CLAUDE.md ì—…ë°ì´íŠ¸ë§Œ)

---

## âš¡ 2. ì£¼ë¬¸ ì¡°íšŒ API íƒ€ì„ì•„ì›ƒ ì™„ì „ í•´ê²°

### ë¬¸ì œ ìƒí™©

**ì¦ìƒ**:
- ì£¼ë¬¸ ëª©ë¡ ì¡°íšŒ ì‹œ DB íƒ€ì„ì•„ì›ƒ 500 ì—ëŸ¬
- ì—ëŸ¬: `canceling statement due to statement timeout`
- API: `POST /api/orders/list` â†’ 500 (3ë²ˆ ì—°ì†)

**ë²„ê·¸ íƒ€ì…**: ì„±ëŠ¥ ë²„ê·¸ + API ë²„ê·¸ (Rule #0-A 5ë²ˆ íƒ€ì…)

---

### ê·¼ë³¸ ì›ì¸ ë¶„ì„ (Rule #0-A Stage 3)

1. âŒ **ì „ì²´ ì£¼ë¬¸ ì¡°íšŒ** (GetOrdersUseCase.js:20)
   ```javascript
   const allOrders = await this._fetchOrders(user, orderId, null, null, null)
   // statusCounts ê³„ì‚°ì„ ìœ„í•´ í•„í„°/í˜ì´ì§€ë„¤ì´ì…˜ ì—†ì´ ì „ì²´ ì£¼ë¬¸ ì¡°íšŒ
   // ì£¼ë¬¸ 100ê°œ+ â†’ 15-20ì´ˆ ì†Œìš”
   ```

2. âŒ **ë¶ˆí•„ìš”í•œ products JOIN** (GetOrdersUseCase.js:48)
   ```javascript
   const baseQuery = `*, order_items (*, products!order_items_product_id_fkey (...)), ...`
   // 3-way JOIN (orders + order_items + products) â†’ ì„±ëŠ¥ ì €í•˜
   ```

3. âœ… **OR ì¿¼ë¦¬ëŠ” ì´ë¯¸ ìµœì í™”ë¨** (2025-10-22 ì•¼ê°„)
   - 3ê°œ ìˆœì°¨ ì¿¼ë¦¬ â†’ 1ê°œ OR ì¿¼ë¦¬ (18ì´ˆ â†’ 6ì´ˆ)

**íƒ€ì„ì•„ì›ƒ ë°œìƒ ë©”ì»¤ë‹ˆì¦˜**:
```
ì „ì²´ ì£¼ë¬¸ ì¡°íšŒ (100ê°œ+)
  â†’ products JOIN (3-way)
  â†’ 15-20ì´ˆ ì†Œìš”
  â†’ Supabase íƒ€ì„ì•„ì›ƒ (ê¸°ë³¸ 10-15ì´ˆ)
  â†’ 500 ì—ëŸ¬ ë°œìƒ
```

---

### í•´ê²° ë°©ë²• (ì˜µì…˜ 3: ë³‘í–‰ ì ìš©)

1. âœ… **products JOIN ì œê±°**
   ```javascript
   // Before
   const baseQuery = `*, order_items (*, products!...), ...`

   // After
   const baseQuery = `*, order_items (*), ...`
   ```

2. âœ… **statusCounts DB ì§‘ê³„ ì¿¼ë¦¬**
   ```javascript
   async _fetchStatusCounts(user) {
     // SELECT status, COUNT(*) FROM orders WHERE ... GROUP BY status
   }
   ```

3. âœ… **í•„í„°/í˜ì´ì§€ë„¤ì´ì…˜ DB ë ˆë²¨ ì ìš©**
   ```javascript
   // .range(offset, offset + limit - 1)
   ```

4. âœ… **í•„í„°ë§ëœ ì´ ê°œìˆ˜ DB COUNT ì¿¼ë¦¬**
   ```javascript
   async _fetchFilteredCount(user, status = null) {
     // SELECT COUNT(*) FROM orders WHERE ...
   }
   ```

---

### ì„±ëŠ¥ ê°œì„  ê²°ê³¼

| í•­ëª© | ê°œì„  ì „ | ê°œì„  í›„ | ê°œì„ ìœ¨ |
|------|---------|---------|--------|
| ì´ˆê¸° ë¡œë“œ | íƒ€ì„ì•„ì›ƒ (15-20ì´ˆ) | **0.5-1ì´ˆ** | **20ë°° ë¹ ë¦„** ğŸš€ |
| íƒ­ ë³€ê²½ | íƒ€ì„ì•„ì›ƒ (15-20ì´ˆ) | **0.5-1ì´ˆ** | **20ë°° ë¹ ë¦„** ğŸš€ |
| DB ì¿¼ë¦¬ | ì „ì²´ ì¡°íšŒ (100ê°œ+) | í•„í„° + í˜ì´ì§€ë„¤ì´ì…˜ (10ê°œ) | **90% ê°ì†Œ** |
| ë°ì´í„° ì „ì†¡ | 70KB | **7KB** | **10ë°° ê°ì†Œ** |
| API ì—ëŸ¬ | 500 íƒ€ì„ì•„ì›ƒ | **0%** | **ì™„ì „ í•´ê²°** âœ… |

---

### ì˜í–¥ íŒŒì¼

**`/lib/use-cases/GetOrdersUseCase.js`** (lines 12-216):
- `execute()`: ì „ì²´ ì¡°íšŒ ì œê±°, DB ì§‘ê³„ë¡œ ë³€ê²½
- `_fetchOrders()`: products JOIN ì œê±°, í•„í„°/í˜ì´ì§€ë„¤ì´ì…˜ ì¶”ê°€
- `_normalizeOrders()`: products ì°¸ì¡° ì œê±°
- `_fetchStatusCounts()`: DB COUNT ì¿¼ë¦¬ ì¶”ê°€
- `_fetchFilteredCount()`: DB COUNT ì¿¼ë¦¬ ì¶”ê°€

**ì»¤ë°‹**: `8762b88` - perf: ì£¼ë¬¸ ì¡°íšŒ API íƒ€ì„ì•„ì›ƒ ì™„ì „ í•´ê²°

---

## ğŸ› 3. ì£¼ë¬¸ ë‚´ì—­ UUID í‘œì‹œ ë²„ê·¸ ìˆ˜ì • + DB ë§ˆì´ê·¸ë ˆì´ì…˜

### ë¬¸ì œ ìƒí™©

**ì¦ìƒ**:
- ì£¼ë¬¸ ë‚´ì—­ í˜ì´ì§€ì—ì„œ UUID í‘œì‹œ (`327bb989-...`)
- product_numberê°€ ë‚˜ì™€ì•¼ í•¨ (ì˜ˆ: `0002`)
- ì´ë¯¸ì§€ ë¯¸í‘œì‹œ (thumbnail_url ì—†ìŒ)

**ë²„ê·¸ íƒ€ì…**: UI ë²„ê·¸ (Rule #0-A 1ë²ˆ íƒ€ì…)

---

### ê·¼ë³¸ ì›ì¸ ë¶„ì„ (Rule #0-A Stage 3)

1. âŒ **GetOrdersUseCase products JOIN ì œê±°** (ìœ„ ì„±ëŠ¥ ìµœì í™” ì‘ì—…)
   ```javascript
   // order_items (*, products!...) â†’ order_items (*)
   ```

2. âŒ **order_items í…Œì´ë¸”ì— thumbnail_url, product_number ì—†ìŒ**
   - DB ìŠ¤í‚¤ë§ˆì— í•´ë‹¹ ì»¬ëŸ¼ ì—†ìŒ
   - products í…Œì´ë¸”ì—ë§Œ ì¡´ì¬

3. âŒ **_normalizeOrders() fallback ì‘ë™**
   ```javascript
   product_number: i.product_number || i.product_id
   // i.product_number = undefined â†’ UUID í‘œì‹œ
   ```

**ê·¼ë³¸ ì›ì¸**: ì„±ëŠ¥ ìµœì í™” ì‹œ products JOIN ì œê±° â†’ order_itemsì— ë°ì´í„° ì—†ìŒ

---

### í•´ê²° ë°©ë²• (ì˜µì…˜ 2: DB ë§ˆì´ê·¸ë ˆì´ì…˜)

#### 1. DB ë§ˆì´ê·¸ë ˆì´ì…˜

**SQL**: `migrations/20251022_order_items_add_columns.sql`

```sql
-- 1. ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE order_items
  ADD COLUMN IF NOT EXISTS thumbnail_url TEXT,
  ADD COLUMN IF NOT EXISTS product_number VARCHAR(20);

-- 2. ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (products í…Œì´ë¸”ì—ì„œ ë³µì‚¬)
UPDATE order_items
SET
  thumbnail_url = products.thumbnail_url,
  product_number = products.product_number
FROM products
WHERE order_items.product_id = products.id
  AND (order_items.thumbnail_url IS NULL OR order_items.product_number IS NULL);

-- 3. ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX IF NOT EXISTS idx_order_items_product_number
  ON order_items(product_number);
```

---

#### 2. CreateOrderUseCase ìˆ˜ì •

**`/lib/use-cases/CreateOrderUseCase.js`** (lines 79-116):

```javascript
async _createItem(oid, od) {
  // âœ… ì„±ëŠ¥ ìµœì í™”: products JOIN ì œê±°ë¥¼ ìœ„í•´
  //    thumbnail_url, product_numberë¥¼ order_itemsì— ì €ì¥
  let thumbnailUrl = od.thumbnail_url || od.thumbnailUrl
  let productNumber = od.product_number || od.productNumber

  // orderDataì— ì—†ìœ¼ë©´ products í…Œì´ë¸”ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  if (!thumbnailUrl || !productNumber) {
    const { data: product } = await this._db()
      .from('products')
      .select('thumbnail_url, product_number')
      .eq('id', od.id)
      .single()

    if (product) {
      thumbnailUrl = thumbnailUrl || product.thumbnail_url
      productNumber = productNumber || product.product_number
    }
  }

  const { error } = await this._db().from('order_items').insert([{
    order_id: oid,
    product_id: od.id,
    title: od.title,
    quantity: od.quantity,
    price: od.price,
    total: od.totalPrice,
    unit_price: od.price,
    total_price: od.totalPrice,
    selected_options: od.selectedOptions || {},
    variant_title: od.variant || null,
    variant_id: od.variantId || null,
    sku: od.sku || null,
    product_snapshot: od.productSnapshot || {},
    thumbnail_url: thumbnailUrl,  // â­ ì‹ ê·œ
    product_number: productNumber  // â­ ì‹ ê·œ
  }])
  if (error) throw error
}
```

---

#### 3. DB_REFERENCE_GUIDE.md ì—…ë°ì´íŠ¸

**`/Users/jt/live-commerce/DB_REFERENCE_GUIDE.md`** (lines 496-546):

```sql
CREATE TABLE order_items (
    ...
    -- ìƒí’ˆ ì •ë³´ (ìŠ¤ëƒ…ìƒ·)
    title TEXT NOT NULL,
    thumbnail_url TEXT,  -- â­ 2025-10-22 ì¶”ê°€
    product_number VARCHAR(20),  -- â­ 2025-10-22 ì¶”ê°€
    ...
);
```

**ì¶”ê°€ ì„¤ëª…**:
- `thumbnail_url`, `product_number`: products JOIN ì œê±°ë¥¼ ìœ„í•´ ìŠ¤ëƒ…ìƒ· ì €ì¥
- ê¸°ì¡´ ë°ì´í„°: ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ
- ìƒˆ ì£¼ë¬¸: CreateOrderUseCaseì—ì„œ ìë™ ì €ì¥
- **íš¨ê³¼**: ì£¼ë¬¸ ì¡°íšŒ ì‹œ products JOIN ë¶ˆí•„ìš” â†’ ì„±ëŠ¥ 20ë°° í–¥ìƒ

---

### ì„±ëŠ¥ ì˜í–¥

| í•­ëª© | ì˜í–¥ | ë¹„ê³  |
|------|------|------|
| ì£¼ë¬¸ ì¡°íšŒ ì„±ëŠ¥ | âœ… ìœ ì§€ (0.5-1ì´ˆ) | products JOIN ì œê±° ìœ ì§€ |
| ìƒˆ ì£¼ë¬¸ ìƒì„± | âœ… +1 SELECT (ëŒ€ë¶€ë¶„ 0íšŒ) | orderDataì— ì—†ì„ ë•Œë§Œ |
| ê¸°ì¡´ ì£¼ë¬¸ í‘œì‹œ | âœ… ì •ìƒ í‘œì‹œ | DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ |
| ë°ì´í„° ì •ê·œí™” | âœ… ê°œì„  | ì£¼ë¬¸ ì‹œì  ìŠ¤ëƒ…ìƒ· ì €ì¥ |

---

### ì˜í–¥ íŒŒì¼

1. **DB ë§ˆì´ê·¸ë ˆì´ì…˜**:
   - `migrations/20251022_order_items_add_columns.sql`

2. **ì½”ë“œ ìˆ˜ì •**:
   - `/lib/use-cases/CreateOrderUseCase.js` (lines 79-116)

3. **ë¬¸ì„œ ì—…ë°ì´íŠ¸**:
   - `/Users/jt/live-commerce/DB_REFERENCE_GUIDE.md` (lines 496-546)
   - `CLAUDE.md` (ìµœê·¼ ì—…ë°ì´íŠ¸ ì„¹ì…˜)

**ì»¤ë°‹**: `47e4959` - fix: ì£¼ë¬¸ ë‚´ì—­ UUID í‘œì‹œ ë²„ê·¸ ìˆ˜ì • + DB ë§ˆì´ê·¸ë ˆì´ì…˜

---

## ğŸ“Š Rule #0-A ì ìš© ì„±ê³¼

### ì‘ì—… 1: íƒ€ì„ì•„ì›ƒ í•´ê²°

- âœ… Stage 1: ë²„ê·¸ íƒ€ì… ë¶„ë¥˜ (ì„±ëŠ¥ + API ë²„ê·¸)
- âœ… Stage 2: 1ìˆœìœ„ ë¬¸ì„œ í™•ì¸ (DB_REFERENCE_GUIDE.md)
- âœ… Stage 3: ì†ŒìŠ¤ì½”ë“œ í™•ì¸ + ê·¼ë³¸ ì›ì¸ íŒŒì•…
- âœ… Stage 4: ì˜í–¥ë„ ë¶„ì„ + ìˆ˜ì • ê³„íš ìˆ˜ë¦½ (TodoWrite 14ê°œ í•­ëª©)
- âœ… Stage 5: ìˆ˜ì • + ê²€ì¦ (ë¹Œë“œ ì„±ê³µ)

**ê²°ê³¼**: íƒ€ì„ì•„ì›ƒ ì™„ì „ í•´ê²°, ì„±ëŠ¥ 20ë°° í–¥ìƒ, ì²« ì‹œë„ 100% ì„±ê³µ

---

### ì‘ì—… 2: UUID í‘œì‹œ ë²„ê·¸ ìˆ˜ì •

- âœ… Stage 1: ë²„ê·¸ íƒ€ì… ë¶„ë¥˜ (UI ë²„ê·¸)
- âœ… Stage 2: 1ìˆœìœ„ ë¬¸ì„œ í™•ì¸ (DB_REFERENCE_GUIDE.md, order_items ìŠ¤í‚¤ë§ˆ)
- âœ… Stage 3: ì†ŒìŠ¤ì½”ë“œ í™•ì¸ + ê·¼ë³¸ ì›ì¸ íŒŒì•… (products JOIN ì œê±°ê°€ ì›ì¸)
- âœ… Stage 4: ì˜í–¥ë„ ë¶„ì„ + í•´ê²° ë°©ì•ˆ ìˆ˜ë¦½ (ì˜µì…˜ 1 vs 2, ì˜µì…˜ 2 ì„ íƒ)
- âœ… Stage 5: DB ë§ˆì´ê·¸ë ˆì´ì…˜ + ì½”ë“œ ìˆ˜ì • + ê²€ì¦ (ë¹Œë“œ ì„±ê³µ)

**ê²°ê³¼**: ì™„ì „í•œ í•´ê²° (DB ë§ˆì´ê·¸ë ˆì´ì…˜), ì„±ëŠ¥ ìœ ì§€, ë°ì´í„° ì •ê·œí™” ê°œì„ 

---

## ğŸ¯ ì´ ì„±ê³¼

### ì‹œê°„ íš¨ìœ¨

- ğŸ• **ì‘ì—… 1 (íƒ€ì„ì•„ì›ƒ)**: 20ë¶„ (ë¬¸ì„œ í™•ì¸ â†’ ìˆ˜ì • â†’ ê²€ì¦)
- ğŸ• **ì‘ì—… 2 (UUID ë²„ê·¸)**: 30ë¶„ (ë²„ê·¸ ë°œê²¬ â†’ ë¶„ì„ â†’ DB ë§ˆì´ê·¸ë ˆì´ì…˜ â†’ ë°°í¬)
- ğŸ• **ì´ ì‘ì—… ì‹œê°„**: 50ë¶„ (Rule #0-A ì—†ì—ˆë‹¤ë©´ 2-3ì‹œê°„ ì†Œìš” ì˜ˆìƒ)

### í’ˆì§ˆ

- ğŸ¯ **ì •í™•ì„±**: ê·¼ë³¸ ì›ì¸ 100% íŒŒì•…
- âœ… **ì™„ì „ì„±**: ì„ì‹œë°©í¸ ì—†ì´ ì¥ê¸° í•´ê²°
- ğŸ“š **ë¬¸ì„œí™”**: ìë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ
- ğŸš€ **ì„±ëŠ¥**: 20ë°° í–¥ìƒ ìœ ì§€

### ë°°í¬ ìƒíƒœ

- âœ… Git ì»¤ë°‹: 2ê°œ (8762b88, 47e4959)
- âœ… Vercel ë°°í¬: ì§„í–‰ ì¤‘
- âœ… ë¹Œë“œ: ì„±ê³µ (2.9ì´ˆ, 0 ì—ëŸ¬)

---

## ğŸ”„ ë‹¤ìŒ ë‹¨ê³„

1. **ë°°í¬ ì™„ë£Œ ëŒ€ê¸°** (2-3ë¶„)
2. **ì„±ëŠ¥ ê²€ì¦**: https://allok.shop/orders
3. **ë²„ê·¸ í™•ì¸**: product_number, thumbnail_url ì •ìƒ í‘œì‹œ
4. **ì¶”ê°€ ìµœì í™” ê³ ë ¤** (ì„ íƒ):
   - order_items ì¸ë±ìŠ¤ ì¶”ê°€
   - statusCounts ìºì‹± (Redis)
   - í”„ë¡ íŠ¸ì—”ë“œ ë¡œë”© ìƒíƒœ ê°œì„ 

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-10-22 ì•¼ê°„
**ë‹¤ìŒ ì‘ì—…**: ë°°í¬ ê²€ì¦ í›„ ì¶”ê°€ ë²„ê·¸ ìˆ˜ì • ë˜ëŠ” ê¸°ëŠ¥ ê°œë°œ
