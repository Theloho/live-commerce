# 📋 작업 일지 - 2025년 10월 1일

## 🎯 오늘 완료한 작업

### 1. 라이브 방송 컨트롤 페이지 UI 수정
**문제**: 사용자가 상품 리스트 카드 디자인만 원했는데 전체 페이지를 바꿔버림
**해결**:
- 이전 그리드 디자인으로 복원
- "LIVE 시작" 버튼 텍스트를 "라이브 상품 추가"로 변경
- 기존 기능 모두 유지 (수정, 삭제, 재고 관리, 상태 토글)

**커밋**: `7693655` - LIVE 시작 버튼 텍스트를 '라이브 상품 추가'로 변경

---

### 2. Supabase 클라이언트 중복 생성 문제 해결 ⭐

#### 문제 상황
- 콘솔에 "Multiple GoTrueClient instances" 경고 발생
- "Auth state changed: INITIAL_SESSION" 로그가 117번 반복
- "기존 세션 복원", "홈페이지에서 세션 복원" 등 과도한 로그
- "로그인되었습니다" 토스트 메시지가 2번씩 표시

#### 근본 원인
1. **여러 파일에서 Supabase 클라이언트를 각각 생성**
   - `/lib/supabase.js` - 메인 클라이언트
   - `/utils/supabase/client.js` - SSR 클라이언트
   - 각 컴포넌트에서 useAuth 훅이 중복 구독

2. **Auth 이벤트 리스너 중복**
   - 6개 컴포넌트가 각각 Auth 상태를 구독
   - INITIAL_SESSION 이벤트를 SIGNED_IN으로 잘못 처리

#### 해결 방법

**Step 1: Supabase 클라이언트 싱글톤 패턴 적용**
```javascript
// /lib/supabase.js
let supabaseInstance = null
const getSupabaseClient = () => {
  if (!supabaseInstance) {
    supabaseInstance = createClient(supabaseUrl, supabaseKey, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        flowType: 'pkce'  // 보안 강화
      }
    })
  }
  return supabaseInstance
}
```

**Step 2: SSR 클라이언트도 싱글톤 적용**
```javascript
// /utils/supabase/client.js
let supabaseInstance = null
export function createClient() {
  if (!supabaseInstance) {
    supabaseInstance = createBrowserClient(...)
  }
  return supabaseInstance
}
```

**Step 3: Auth 구독 전역 관리**
```javascript
// /hooks/useAuth.js
let globalSubscription = null
let subscriberCount = 0

// 첫 번째 컴포넌트만 실제 구독 생성
if (!globalSubscription) {
  globalSubscription = supabase.auth.onAuthStateChange(...)
}

// CustomEvent로 모든 컴포넌트에 전파
window.dispatchEvent(new CustomEvent('authStateChanged', {...}))
```

**Step 4: INITIAL_SESSION 이벤트 구분 처리**
```javascript
if (event === 'INITIAL_SESSION') {
  // 페이지 로드 시 기존 세션 복원 - 조용히 처리
  window.dispatchEvent(...)
} else if (event === 'SIGNED_IN') {
  // 실제 로그인 시에만 토스트 표시
  toast.success('로그인되었습니다')
}
```

**Step 5: 불필요한 콘솔 로그 제거**
- "기존 세션 복원" 로그 제거
- "홈페이지/헤더/네비게이션에서 세션 복원" 로그 제거
- "Auth state changed" 로그 제거

#### 결과
✅ Supabase 클라이언트가 정확히 1개만 생성
✅ Auth 이벤트가 한 번만 발생
✅ 콘솔 로그 수십 개 → 깔끔하게 정리
✅ 토스트 메시지 중복 제거
✅ 메모리 사용량 최적화
✅ 보안 강화 (PKCE 플로우 추가)

**관련 커밋**:
- `f1cd8d4` - Supabase 클라이언트 중복 생성 및 과도한 콘솔 로그 제거
- `d9d3904` - Supabase Auth 중복 구독 완전 해결
- `492c5d9` - utils/supabase/client.js도 싱글톤 패턴 적용
- `687c72a` - Supabase 클라이언트 안정성 강화
- `78f909b` - 페이지 새로고침 시 '로그인되었습니다' 토스트 중복 제거

---

## 📊 현재 시스템 구조

### 데이터베이스 스키마 (프로덕션)

#### 1. 사용자 관련
- **profiles** - 사용자 프로필 (이름, 전화번호, 주소 등)
- **auth.users** - Supabase 인증 (이메일, 패스워드)

#### 2. 상품 관련
- **products** - 상품 정보
  - 라이브 방송 컬럼: `is_live_active`, `live_priority`, `live_start_time`, `live_end_time`
  - 카테고리: `category_id` (categories 테이블 참조)
  - 상태: `status` (active/inactive/draft)
- **product_options** - 상품 옵션 (색상, 사이즈 등)
- **categories** - 카테고리 (계층 구조 지원)

#### 3. 주문 관련
- **orders** - 주문 정보
  - `order_type`: direct/cart (개별 구매 or 장바구니)
  - `status`: pending/verifying/paid/delivered/cancelled
- **order_items** - 주문 상품 목록
  - `unit_price`, `total_price` 사용
- **order_shipping** - 배송 정보
- **order_payments** - 결제 정보
  - `payment_method`: card/bank_transfer/kakao
  - `depositor_name`: 입금자명 (무통장 입금용)

### 주요 페이지 및 기능

#### 사용자 페이지
1. **홈페이지** (`/`)
   - 실시간 상품 표시 (is_live_active 기반)
   - ProductCard 컴포넌트로 그리드 레이아웃

2. **체크아웃** (`/checkout`)
   - UserProfileManager로 사용자 정보 관리
   - 배송지 정보 입력
   - 입금자명 입력
   - 결제 방법 선택 (무통장 입금/카드 결제)

3. **주문 완료** (`/orders/[id]/complete`)
   - 주문 정보 표시
   - 무통장 입금 안내 (계좌번호, 입금액, 입금자명)

4. **마이페이지** (`/mypage`)
   - 프로필 정보 수정
   - 주문 내역 조회

#### 관리자 페이지
1. **실시간 방송 컨트롤** (`/admin/products`)
   - 모든 상품 그리드 표시
   - 라이브 상품 추가 버튼
   - 재고 관리 (+/- 버튼)
   - 상품 수정/삭제

2. **전체 상품 관리** (`/admin/products/catalog`)
   - 상세한 상품 관리
   - 카테고리별 필터링
   - 일괄 작업

3. **주문 관리** (`/admin/orders`)
   - 주문 상태 변경
   - 배송 정보 관리

4. **발송 관리** (`/admin/shipping`)
   - 발송 대기 주문 조회
   - 배송 상태 업데이트

### 핵심 시스템 아키텍처

#### 1. 인증 시스템
- **Supabase Auth** - 이메일/비밀번호 인증
- **Kakao OAuth** - 카카오 소셜 로그인
- **세션 관리** - sessionStorage + Supabase Auth
- **싱글톤 패턴** - 전체 앱에서 1개의 Auth 클라이언트만 사용

#### 2. 데이터 흐름
```
사용자 페이지 → supabaseApi.js → Supabase DB
           ↓
    UserProfileManager (사용자 정보 중앙 관리)
           ↓
    OrderCalculations (가격 계산 로직)
```

#### 3. 실시간 기능
- **Realtime Products** - 상품 재고 실시간 업데이트
- **Live Broadcast** - 라이브 방송 상태 관리

---

## 🔧 향후 구현 예정 기능

### 1. 도서산간 배송비 자동 차등 적용 ⭐ (우선순위: 높음)

#### 구현 계획

**1단계: shipping_zones 테이블 생성**
```sql
CREATE TABLE shipping_zones (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  zone_name TEXT NOT NULL,        -- '일반지역', '도서산간', '제주도' 등
  zone_type TEXT NOT NULL,        -- 'normal', 'remote', 'island'
  shipping_fee INTEGER NOT NULL,  -- 배송비 (원)
  postal_codes TEXT[],            -- 우편번호 범위 (예: '63000-63644')
  keywords TEXT[],                -- 주소 키워드 (예: '제주', '울릉도')
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 기본 데이터 삽입
INSERT INTO shipping_zones (zone_name, zone_type, shipping_fee, keywords) VALUES
('일반지역', 'normal', 4000, ARRAY['서울', '부산', '대구', '인천', '광주', '대전', '울산', '세종', '경기', '충북', '충남', '전북', '전남', '경북', '경남']),
('제주도', 'island', 6000, ARRAY['제주']),
('도서산간', 'remote', 6000, ARRAY['울릉', '백령', '연평', '소청', '대청', '독도']);
```

**2단계: 우편번호 검색 API 연동**
- Daum 우편번호 API 또는 공공데이터포털 API 사용
- 우편번호로 지역 분류

**3단계: 배송비 자동 계산 API**
```javascript
// /app/api/calculate-shipping/route.js
export async function POST(request) {
  const { postalCode, address } = await request.json()

  // 1. 우편번호로 지역 판별
  const { data: zones } = await supabase
    .from('shipping_zones')
    .select('*')
    .or(`postal_codes.cs.{${postalCode}},keywords.ov.{${extractKeyword(address)}}`)

  // 2. 가장 비싼 배송비 적용 (안전장치)
  const zone = zones.sort((a, b) => b.shipping_fee - a.shipping_fee)[0]
    || { zone_name: '일반지역', shipping_fee: 4000 }

  return NextResponse.json({
    zoneName: zone.zone_name,
    shippingFee: zone.shipping_fee
  })
}
```

**4단계: 체크아웃 페이지 통합**
```javascript
// 주소 입력 시 실시간 배송비 계산
const handleAddressComplete = async (data) => {
  const response = await fetch('/api/calculate-shipping', {
    method: 'POST',
    body: JSON.stringify({
      postalCode: data.zonecode,
      address: data.address
    })
  })
  const { zoneName, shippingFee } = await response.json()

  setShippingInfo({
    address: data.address,
    postalCode: data.zonecode,
    zoneName,
    shippingFee
  })
}
```

**5단계: 주문 테이블 확장**
```sql
ALTER TABLE order_shipping
ADD COLUMN postal_code VARCHAR(10),
ADD COLUMN shipping_zone TEXT,
ADD COLUMN shipping_fee INTEGER DEFAULT 4000;
```

#### 예상 작업 시간
- DB 설계 및 데이터 입력: 1시간
- API 구현: 1.5시간
- UI 통합: 1.5시간
- 테스트: 1시간
**총 5시간**

---

### 2. 쿠폰 시스템 구현 (우선순위: 중간)

#### 기능 명세
- 할인 쿠폰 생성 및 관리
- 퍼센트/정액 할인 지원
- 최소 주문 금액 설정
- 사용 횟수 제한
- 유효 기간 설정

#### 예상 작업 시간: 3-4시간

---

### 3. 재고 자동 알림 시스템 (우선순위: 낮음)

#### 기능 명세
- 재고 부족 시 관리자에게 알림
- 품절 임박 상품 자동 표시
- 재입고 알림 신청 기능

#### 예상 작업 시간: 2-3시간

---

### 4. 주문 취소/환불 시스템 (우선순위: 중간)

#### 기능 명세
- 사용자 주문 취소 기능
- 관리자 환불 처리
- 취소/환불 내역 관리

#### 예상 작업 시간: 4-5시간

---

## 📝 기술 부채 및 개선 사항

### 보안
- ✅ bcrypt 패스워드 해싱 적용 완료
- ✅ API 키 환경변수 분리 완료
- ✅ 입력 검증 시스템 구축 완료
- ⚠️ Rate Limiting 미적용 (추후 필요 시 구현)

### 성능
- ✅ Supabase 클라이언트 싱글톤 최적화 완료
- ✅ 불필요한 렌더링 최소화
- ⚠️ 이미지 최적화 (Next.js Image 컴포넌트 일부만 적용)
- ⚠️ 상품 목록 페이지네이션 미적용 (현재 전체 로드)

### 사용자 경험
- ✅ 토스트 메시지 중복 제거
- ✅ 로딩 상태 표시
- ⚠️ 에러 페이지 커스터마이징 필요
- ⚠️ 모바일 UX 추가 개선 필요

---

## 🗂️ 업데이트된 문서 목록

1. **WORK_LOG_2025-10-01.md** (신규 생성)
   - 오늘 작업 내용 상세 기록
   - 향후 작업 계획 포함

2. **DETAILED_DATA_FLOW.md** (신규 생성) ⭐
   - **실제 프로덕션 코드 기반** 데이터 흐름 문서
   - 페이지별 상세 데이터 로드/저장 흐름
   - API 엔드포인트별 처리 과정
   - DB 테이블 컬럼 매핑 정보
   - 주요 트러블슈팅 가이드
   - Mermaid 다이어그램으로 시각화

3. **CLAUDE.md** (기존 유지)
   - Claude 작업 규칙 및 명령어

4. **SYSTEM_ARCHITECTURE.md** (기존 유지)
   - 시스템 구조 문서

5. **SYSTEM_ARCHITECTURE_PRODUCTION.md** (기존 유지)
   - 실제 프로덕션 DB 스키마 기준 문서

6. **DATA_ARCHITECTURE.md** (기존 유지)
   - 데이터 아키텍처 개요

---

## 🎯 다음 작업 세션 시작 전 체크리스트

- [x] Supabase SQL Editor에서 현재 DB 스키마 확인 ✅
- [x] 실제 프로덕션과 문서 스키마 일치 여부 확인 ✅
- [x] 각 페이지별 데이터 흐름 상세 분석 완료 ✅
- [x] DETAILED_DATA_FLOW.md 신규 문서 생성 ✅
- [ ] 도서산간 배송비 기능 구현 시작
- [ ] 우편번호 API 선정 및 테스트

---

**작성일**: 2025-10-01
**작성자**: Claude Code
**마지막 커밋**: `78f909b` - 페이지 새로고침 시 '로그인되었습니다' 토스트 중복 제거
